<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Каталог сообщений проекта</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <!-- Material Symbols (Sharp): для material-иконок -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Sharp:opsz,wght,FILL,GRAD@20..48,400,0,0" />
    <!-- Единые стили для всех review -->
    <link rel="stylesheet" href="r-styles.css">
    <!-- Level 2: единое хранилище и единый компонент сообщений -->
    <script src="../../ui/utils/messages-store.js"></script>
    <script src="../../ui/components/system-messages.js"></script>
    <!-- Единый менеджер для всех review (хедер с вкладками) - загружаем в head для ранней инициализации -->
    <script src="r-manager.js"></script>
</head>
<body>
    <!-- Хедер с вкладками будет вставлен здесь через review-manager.js -->

    <div id="app" class="container-fluid">
        <!-- Auto-scan: каталог сообщений из фактической кодовой базы -->
        <div class="mt-4 mb-3">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <div class="d-flex align-items-center gap-2">
                        <button
                            type="button"
                            class="btn btn-sm review-collapse-btn"
                            data-bs-toggle="collapse"
                            data-bs-target="#rm-auto-scan-collapse"
                            aria-expanded="false"
                            aria-controls="rm-auto-scan-collapse"
                            title="Развернуть/свернуть"
                        >
                            <span class="review-collapse-icon" aria-hidden="true">▾</span>
                        </button>
                        <h5 class="mb-0">Auto-scan</h5>
                    </div>

                    <!-- Summary (видно всегда) -->
                    <small class="text-muted">{{ autoScanSummary }}</small>
                </div>

                <!-- Свернуто по умолчанию -->
                <div id="rm-auto-scan-collapse" class="collapse">
                    <div class="card-body">
                    <div v-if="autoMessagesMeta" class="small text-muted mb-2">generatedAt: {{ autoMessagesMeta }}</div>

                    <!-- Единый хост сообщений для Auto-scan (показывается только при наличии сообщений) -->
                    <system-messages scope="review-messages-auto-scan" :include-unscoped="false" :limit="2"></system-messages>

                    <div v-if="autoMessagesLoading" class="text-muted">Сканирую сообщения в проекте…</div>
                    <div v-else-if="autoMessagesError" class="text-muted">
                        Auto-scan завершился с ошибкой (см. сообщение выше).
                    </div>
                    <div v-else>
                        <div v-if="autoMessages.length === 0" class="text-muted">Сообщения не найдены (или недоступен источник данных).</div>
                        <div v-else class="table-responsive">
                            <table class="table table-sm review-table">
                                <thead>
                                    <tr>
                                        <th style="width: 110px;">Тип</th>
                                        <th>Текст (сниппет)</th>
                                        <th style="width: 240px;">Где найдено</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr v-for="(m, idx) in autoMessages" :key="idx">
                                        <td>
                                            <span
                                                class="badge"
                                                :class="badgeClassForType(m.type)"
                                            >{{ m.type }}</span>
                                        </td>
                                        <td style="font-size: 0.9rem;">{{ m.text }}</td>
                                        <td class="usage-cell">
                                            <select v-if="m.files && m.files.length > 1" class="form-select form-select-sm" style="width: auto; display: inline-block; min-width: 200px; font-size: 0.85rem;">
                                                <option v-for="f in m.files" :key="f" :value="f">{{ f }}</option>
                                            </select>
                                            <code v-else-if="m.files && m.files.length === 1" style="font-size: 0.85rem;">{{ m.files[0] }}</code>
                                            <span v-else class="text-muted">—</span>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="messages-container mt-4">
            <div class="row g-4">
                <!-- Левая колонка: быстрые пресеты -->
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">Шаблоны</h5>
                        </div>
                        <div class="card-body">
                            <div class="d-flex flex-wrap gap-2">
                                <span
                                    v-for="p in leftPresets"
                                    :key="p.key"
                                    class="badge review-badge-btn"
                                    :class="[p.badgeClass, { 'review-badge-active': selected.left === p.key }]"
                                    :title="p.title"
                                    role="button"
                                    tabindex="0"
                                    @click="selectLeftPreset(p.key)"
                                    @keydown.enter.prevent="selectLeftPreset(p.key)"
                                    @keydown.space.prevent="selectLeftPreset(p.key)"
                                >{{ p.key }}</span>
                            </div>

                            <div class="mt-3">
                                <system-messages :scope="scopes.left" :include-unscoped="false" :limit="6"></system-messages>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Правая колонка: темы -->
                <div class="col-md-6">
                    <!-- Light Theme -->
                    <div class="card mb-4">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">Light Theme</h5>
                            <div class="btn-group btn-group-sm rm-type-toggle" role="group" aria-label="Light Theme message types">
                                <input type="radio" class="btn-check" name="rm-light-type" id="rm-light-info" value="info" v-model="selected.light">
                                <label class="btn rm-type-label" data-type="info" for="rm-light-info">Info</label>

                                <input type="radio" class="btn-check" name="rm-light-type" id="rm-light-success" value="success" v-model="selected.light">
                                <label class="btn rm-type-label" data-type="success" for="rm-light-success">Success</label>

                                <input type="radio" class="btn-check" name="rm-light-type" id="rm-light-warning" value="warning" v-model="selected.light">
                                <label class="btn rm-type-label" data-type="warning" for="rm-light-warning">Warning</label>

                                <input type="radio" class="btn-check" name="rm-light-type" id="rm-light-danger" value="danger" v-model="selected.light">
                                <label class="btn rm-type-label" data-type="danger" for="rm-light-danger">Danger</label>
                            </div>
                        </div>
                        <div class="card-body">
                            <system-messages :scope="scopes.light" :include-unscoped="false" :limit="4"></system-messages>
                        </div>
                    </div>

                    <!-- Dark Theme -->
                    <div class="card mb-4" data-bs-theme="dark">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">Dark Theme</h5>
                            <div class="btn-group btn-group-sm rm-type-toggle" role="group" aria-label="Dark Theme message types">
                                <input type="radio" class="btn-check" name="rm-dark-type" id="rm-dark-info" value="info" v-model="selected.dark">
                                <label class="btn rm-type-label" data-type="info" for="rm-dark-info">Info</label>

                                <input type="radio" class="btn-check" name="rm-dark-type" id="rm-dark-success" value="success" v-model="selected.dark">
                                <label class="btn rm-type-label" data-type="success" for="rm-dark-success">Success</label>

                                <input type="radio" class="btn-check" name="rm-dark-type" id="rm-dark-warning" value="warning" v-model="selected.dark">
                                <label class="btn rm-type-label" data-type="warning" for="rm-dark-warning">Warning</label>

                                <input type="radio" class="btn-check" name="rm-dark-type" id="rm-dark-danger" value="danger" v-model="selected.dark">
                                <label class="btn rm-type-label" data-type="danger" for="rm-dark-danger">Danger</label>
                            </div>
                        </div>
                        <div class="card-body">
                            <system-messages :scope="scopes.dark" :include-unscoped="false" :limit="4"></system-messages>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS для работы alert-dismissible -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Vue.js 3 -->
    <script src="https://unpkg.com/vue@3.5.25/dist/vue.global.prod.js"></script>

    <!-- Глобальные утилиты -->
    <script src="../../ui/utils/ui-element-helper.js"></script>
    <script src="../../ui/utils/hash-generator.js"></script>

    <!-- X-Template для компонента button (ДОЛЖЕН БЫТЬ ДО компонентов) -->
    <script type="text/x-template" id="button-template">
        <button
            :type="type"
            :class="buttonClasses"
            :disabled="disabled"
            @click="handleClick"
        >
            <!-- Основная часть (иконка + текст) с tooltip -->
            <span
                class="button-main"
                :class="{'button-icon-only': isIconOnly}"
                :title="mainTooltip"
            >
                <!-- Спиннер загрузки (показывается только если нет loadingText) -->
                <span v-if="loading && !loadingText" class="spinner-border spinner-border-sm" role="status"></span>

                <!-- Динамический текст загрузки (показывается вместо спиннера) -->
                <span v-if="loading && loadingText" class="button-label">{{ loadingText }}</span>

                <!-- Иконка (скрывается при loading) -->
                <span v-if="!loading && (effectiveIconClass || hasIconImage)" class="button-icon">
                    <!-- SVG-иконка из файла (используется object для поддержки currentColor и CSS переменных) -->
                    <object v-if="isSVGIcon"
                            :data="svgIconPath"
                            type="image/svg+xml"
                            :class="effectiveIconClass"
                            style="width: 1em; height: 1em; vertical-align: middle; pointer-events: none;">
                        <!-- Fallback на img если object не поддерживается -->
                        <img :src="svgIconPath"
                             :alt="displayLabel"
                             :class="effectiveIconClass"
                             style="width: 1em; height: 1em; vertical-align: middle;">
                    </object>
                    <!-- Font Awesome иконки (используется i) -->
                    <i v-else-if="effectiveIconClass" :class="effectiveIconClass"></i>
                    <img v-if="hasIconImage" :src="iconImage" :alt="displayLabel" width="16" height="16">
                </span>

                <!-- Текст (всегда рендерится, но скрывается визуально при loading для сохранения высоты, если нет loadingText) -->
                <span
                    v-if="displayLabel && !(loading && loadingText)"
                    class="button-label"
                    :style="{ visibility: (loading && !loadingText) ? 'hidden' : 'visible' }"
                >{{ displayLabel }}</span>
            </span>

            <!-- Индикатор с отдельным tooltip -->
            <span
                v-if="indicator"
                class="button-indicator"
                :title="indicatorTooltipText"
            >
                <i v-if="effectiveIndicatorIcon" :class="effectiveIndicatorIcon"></i>
            </span>
        </button>
    </script>

    <!-- Компоненты (для demo-кнопок и единых сообщений) -->
    <script src="../../ui/components/button.js"></script>

    <script>
        // Инициализация Vue приложения (Auto-scan + demo сообщений)
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof Vue === 'undefined' || !window.AppMessages || !window.cmpSystemMessages) return;

            const { createApp } = Vue;

            const app = createApp({
                data() {
                    return {
                        scopes: {
                            left: 'review-messages-left',
                            light: 'review-messages-light',
                            dark: 'review-messages-dark'
                        },
                        selected: {
                            left: 'cgError',
                            light: 'info',
                            dark: 'info'
                        },
                        leftPresets: [
                            { key: 'cgError', type: 'danger', title: 'Не удалось загрузить данные', badgeClass: 'bg-danger' },
                            { key: 'quoteError', type: 'warning', title: 'Не удалось загрузить цитату', badgeClass: 'bg-warning text-dark' },
                            { key: 'passwordError', type: 'danger', title: 'Неверный код', badgeClass: 'bg-danger' },
                            { key: 'importSuccess', type: 'success', title: 'Экспорт успешен', badgeClass: 'bg-success' },
                            { key: 'importError', type: 'danger', title: 'Ошибка экспорта', badgeClass: 'bg-danger' },
                            { key: 'apiKeyMissing', type: 'warning', title: 'Нужен API ключ', badgeClass: 'bg-warning text-dark' },
                            { key: 'apiKeyOk', type: 'success', title: 'API ключ настроен', badgeClass: 'bg-success' },
                            { key: 'failedTickers', type: 'warning', title: 'Некоторые монеты не удалось добавить', badgeClass: 'bg-warning text-dark' }
                        ],
                        autoMessagesLoading: true,
                        autoMessagesError: null,
                        autoMessagesMeta: null,
                        autoMessages: []
                    };
                },
                computed: {
                    autoScanCounts() {
                        const list = Array.isArray(this.autoMessages) ? this.autoMessages : [];
                        const byType = { info: 0, success: 0, warning: 0, danger: 0, other: 0 };
                        for (const m of list) {
                            const t = String(m?.type || 'info').toLowerCase();
                            if (t === 'danger' || t === 'error') byType.danger++;
                            else if (t === 'warning' || t === 'warn') byType.warning++;
                            else if (t === 'success') byType.success++;
                            else if (t === 'info') byType.info++;
                            else byType.other++;
                        }
                        return { total: list.length, byType };
                    },
                    autoScanSummary() {
                        if (this.autoMessagesLoading) return 'Сканирование…';
                        if (this.autoMessagesError) return 'Ошибка';
                        const { total, byType } = this.autoScanCounts;
                        if (!total) return '0 сообщений';
                        const parts = [`${total} сообщений`];
                        if (byType.danger) parts.push(`danger: ${byType.danger}`);
                        if (byType.warning) parts.push(`warning: ${byType.warning}`);
                        return parts.join(' • ');
                    }
                },
                watch: {
                    'selected.light'(val) {
                        try { this.selectTheme(this.scopes.light, val); } catch (_) { /* ignore */ }
                    },
                    'selected.dark'(val) {
                        try { this.selectTheme(this.scopes.dark, val); } catch (_) { /* ignore */ }
                    }
                },
                async mounted() {
                    // Default: показываем первый пример в каждом блоке (radio-mode),
                    // но не затираем, если пользователь уже создавал сообщения.
                    try {
                        const msgs = window.AppMessages?.state?.messages || [];
                        const hasLeft = Array.isArray(msgs) && msgs.some(m => m && m.scope === this.scopes.left);
                        const hasLight = Array.isArray(msgs) && msgs.some(m => m && m.scope === this.scopes.light);
                        const hasDark = Array.isArray(msgs) && msgs.some(m => m && m.scope === this.scopes.dark);
                        if (!hasLeft) this.selectLeftPreset(this.selected.left);
                        if (!hasLight) this.selectTheme(this.scopes.light, this.selected.light);
                        if (!hasDark) this.selectTheme(this.scopes.dark, this.selected.dark);
                    } catch (_) {
                        // ignore
                    }

                    const pipeline = window.ReviewManager?.ReviewDataPipeline;
                    if (!pipeline?.scanMessages) {
                        this.autoMessagesLoading = false;
                        this.autoMessagesError = 'ReviewDataPipeline недоступен.';
                        window.AppMessages?.replace?.('rm_auto_scan_error', {
                            scope: 'review-messages-auto-scan',
                            type: 'danger',
                            text: 'Auto-scan: ReviewDataPipeline недоступен.',
                            details: this.autoMessagesError
                        });
                        return;
                    }

                    try {
                        const res = await pipeline.scanMessages();
                        this.autoMessages = Array.isArray(res?.messages) ? res.messages : [];
                        this.autoMessagesMeta = res?.generatedAt ? String(res.generatedAt) : null;
                        this.autoMessagesLoading = false;
                        window.AppMessages?.dismiss?.('rm_auto_scan_error');
                    } catch (e) {
                        this.autoMessagesLoading = false;
                        this.autoMessagesError = String(e?.message || e);
                        window.AppMessages?.replace?.('rm_auto_scan_error', {
                            scope: 'review-messages-auto-scan',
                            type: 'danger',
                            text: 'Auto-scan сообщений: ошибка.',
                            details: this.autoMessagesError
                        });
                        window.ReviewManager?.ReviewSystemMessages?.post?.('messages.scan.error', {
                            id: 'messages-scan',
                            details: this.autoMessagesError
                        });
                    }
                },
                methods: {
                    badgeClassForType(type) {
                        const t = String(type || 'info').toLowerCase();
                        if (t === 'danger' || t === 'error') return 'bg-danger';
                        if (t === 'warning' || t === 'warn') return 'bg-warning';
                        if (t === 'success') return 'bg-success';
                        if (t === 'info') return 'bg-info';
                        return 'bg-secondary';
                    },
                    pushDemo({ id, scope, type, text, details }) {
                        if (!window.AppMessages) return;
                        window.AppMessages.replace?.(id, { scope, type, text, details });
                    },
                    selectLeftPreset(key) {
                        const scope = this.scopes.left;
                        const map = {
                            cgError: { id: 'rm_left_selected', type: 'danger', text: 'Не удалось загрузить данные', details: 'CoinGecko: пример системной ошибки.' },
                            quoteError: { id: 'rm_left_selected', type: 'warning', text: 'Не удалось загрузить цитату', details: 'Perplexity: пример предупреждения.' },
                            passwordError: { id: 'rm_left_selected', type: 'danger', text: 'Неверный код', details: 'Splash: неверный PIN.' },
                            importSuccess: { id: 'rm_left_selected', type: 'success', text: 'Экспорт успешен', details: 'Чувствительные данные обфусцированы.' },
                            importError: { id: 'rm_left_selected', type: 'danger', text: 'Ошибка экспорта настроек', details: 'Пример текста ошибки…' },
                            apiKeyMissing: { id: 'rm_left_selected', type: 'warning', text: 'Для работы необходимо указать API ключ', details: 'Perplexity API key отсутствует.' },
                            apiKeyOk: { id: 'rm_left_selected', type: 'success', text: 'API ключ настроен', details: 'Perplexity API key сохранён.' },
                            failedTickers: { id: 'rm_left_selected', type: 'warning', text: 'Некоторые монеты не удалось добавить', details: 'Повторите попытку позже.' }
                        };
                        const v = map[key];
                        if (!v) return;
                        this.selected.left = key;
                        this.pushDemo({ ...v, scope });
                    },
                    selectTheme(scope, type) {
                        const base = {
                            info: {
                                id: `${scope}_selected`,
                                type: 'info',
                                text: 'Информация о прогнозе',
                                details: 'Модель завершила расчёт метрик; проверьте распределение портфеля.'
                            },
                            success: {
                                id: `${scope}_selected`,
                                type: 'success',
                                text: 'Портфель сохранён',
                                details: 'Изменения сохранены в локальное хранилище.'
                            },
                            warning: {
                                id: `${scope}_selected`,
                                type: 'warning',
                                text: 'Внимание: недостаточно данных',
                                details: 'Данных < 30 дней по некоторым активам — точность может снизиться.'
                            },
                            danger: {
                                id: `${scope}_selected`,
                                type: 'danger',
                                text: 'Ошибка загрузки данных',
                                details: 'CoinGecko API: лимит запросов / сеть. Используйте кэш.'
                            }
                        }[type];
                        if (!base) return;
                        if (scope === this.scopes.light) this.selected.light = type;
                        if (scope === this.scopes.dark) this.selected.dark = type;
                        this.pushDemo({ ...base, scope });
                    }
                }
            });

            app.component('cmp-button', window.cmpButton);
            app.component('system-messages', window.cmpSystemMessages);
            app.mount('#app');
        });
    </script>
</body>
</html>
