# Руководство по интерфейсу и взаимодействию

> **Цель документа**: Поддержка сквозной консистентности UI во всех аспектах приложения.

> **ВАЖНО**: Этот документ предназначен для ИИ-агентов и разработчиков. Принципы и правила, описанные здесь, должны соблюдаться при разработке всех компонентов интерфейса.

## Структура документа

Документ разделен на две крупные секции:
- **Interface** — оформление, визуальные стили, компоненты
- **Interaction** — паттерны UX, базовые паттерны взаимодействия приложения

---

## Interface (оформление)

*Принципы и правила визуального оформления интерфейса: стили, компоненты, цветовая схема, типографика, анимации*

### Общие принципы стилизации

- **Приоритет Bootstrap**: Использовать Bootstrap классы и утилиты в приоритете. Минимизировать кастомные CSS стили, inline стили и секции `<style>` в HTML файлах.
- **Вынесение стилей в отдельные файлы**: Все кастомные CSS стили выносятся в отдельные файлы в структуре `ui/styles/`. Стили группируются по компонентам: `ui/styles/header.css`, `ui/styles/footer.css`, `ui/styles/splash.css`, `ui/styles/dropdown.css`, `ui/styles/layout.css`, `ui/styles/chat.css` и т.д.
- **Динамические стили**: Динамические стили в JavaScript (вычисляемые значения, анимации) могут оставаться в JS, но базовые стили должны быть в CSS файлах.
- **Радиусы скругления**: Использовать дефолтные значения Bootstrap (`var(--bs-border-radius)`). Избегать кастомных `border-radius`, если не требуется специфичное оформление.

### Цветовая схема и темы

- **Темы**: Поддержка светлой (`light`) и темной (`dark`) темы через Bootstrap `data-bs-theme`.
- **Хедер**: Всегда в темной теме (темный графит через `var(--color-header-bg)`), не реагирует на переключалку темы. Обеспечивает контраст с основным контентом.
- **Футер**: Фон соответствует теме через `bg-body`, тень сверху для визуального отделения.

#### Цветовая модель HSL/HSLA

**Принцип**: Проект использует цветовую модель **HSL (Hue, Saturation, Lightness)** с альфа-каналом (**HSLA**) как основу для всех цветовых определений. Это архитектурное решение, обеспечивающее консистентность, удобство настройки и поддержки цветовой схемы.

**Преимущества HSL/HSLA модели:**
- **Интуитивность настройки**: Параметры Hue (тон), Saturation (насыщенность), Lightness (яркость) соответствуют человеческому восприятию цвета, что упрощает создание гармоничных цветовых палитр.
- **Легкость создания вариаций**: Изменение одного параметра (например, Lightness) позволяет создавать семейства связанных цветов (светлые/темные варианты) без пересчета RGB значений.
- **Удобство адаптации под темы**: Легко создавать варианты цветов для светлой и темной темы, изменяя только Lightness при сохранении Hue и Saturation.
- **Централизованное управление**: Все цвета определяются через HSL переменные в `ui/styles/theme-colors.css`, что обеспечивает единую точку настройки цветовой схемы.
- **Оптимизация и переиспользование**: Общие значения (Hue, Saturation) могут быть вынесены в переменные для переиспользования, что уменьшает дублирование и упрощает поддержку.

**Реализация в проекте:**
- Все цвета определяются через HSL/HSLA переменные в `ui/styles/theme-colors.css`.
- Формат: `hsl(h, s%, l%)` или `hsla(h, s%, l%, alpha)`.
- Структура переменных: разделение на компоненты (H, S, L) позволяет переиспользовать общие значения (например, `--color-theme-h: 210` для основного тона темы).
- Избегание альтернативных форматов: не использовать `rgba()`, `rgb()`, hex-коды (`#ffffff`) в CSS правилах для обеспечения консистентности.

**Связь с Bootstrap:**
- Кастомные цвета отталкиваются от рутовых переменных Bootstrap (`--bs-primary`, `--bs-secondary`, `--bs-body-color`, `--bs-border-color` и т.д.).
- Переопределение Bootstrap переменных через HSL значения обеспечивает совместимость с компонентами Bootstrap при сохранении кастомизации.
- RGB значения для Bootstrap совместимости вычисляются из HSL и хранятся в `--bs-primary-rgb` и аналогичных переменных.

#### Система z-index слоев

**Принцип**: Все значения `z-index` определяются через CSS переменные в `ui/styles/z-index.css` и связаны с Bootstrap z-index переменными для обеспечения консистентности и совместимости с компонентами Bootstrap.

**Преимущества централизованной системы z-index:**
- **Единая точка управления**: Все z-index значения находятся в одном файле, что упрощает настройку и поддержку слоев наложения.
- **Совместимость с Bootstrap**: Переменные связаны с Bootstrap z-index переменными (`--bs-zindex-dropdown`, `--bs-zindex-modal` и т.д.), что обеспечивает корректное взаимодействие с компонентами Bootstrap.
- **Предотвращение конфликтов**: Централизованное управление предотвращает случайные конфликты z-index и обеспечивает правильный порядок наложения элементов.
- **Легкость изменения**: Изменение z-index значения в одном месте автоматически применяется ко всем элементам, использующим соответствующую переменную.

**Структура переменных:**
- `--z-index-dropdown`: Dropdown меню (совпадает с `--bs-zindex-dropdown: 1000`)
- `--z-index-splash`: Сплэш-экран - самый верхний слой (9999)
- `--z-index-overlay`: Элементы внутри контейнеров, например, текст поверх SVG (1)
- `--z-index-footer`: Футер - фиксированный внизу (1000, совпадает с Bootstrap dropdown)
- `--z-index-header`: Хедер - фиксированный сверху (1050, совпадает с Bootstrap modal)

**Правила использования:**
- Все z-index значения должны использовать переменные из `ui/styles/z-index.css`.
- Избегать хардкодных значений `z-index` в CSS правилах и inline стилях.
- При необходимости нового z-index слоя - добавить переменную в `z-index.css` с учетом иерархии Bootstrap.
- Значения должны быть связаны с Bootstrap переменными где возможно для обеспечения совместимости.

**Связь с Bootstrap:**
Bootstrap 5 определяет следующие z-index переменные:
- `--bs-zindex-dropdown: 1000`
- `--bs-zindex-sticky: 1020`
- `--bs-zindex-fixed: 1030`
- `--bs-zindex-modal-backdrop: 1040`
- `--bs-zindex-modal: 1050`
- `--bs-zindex-popover: 1070`
- `--bs-zindex-tooltip: 1080`

Кастомные переменные проекта используют эти значения как основу, обеспечивая правильный порядок наложения элементов относительно компонентов Bootstrap.

#### Маркировка контейнеров

**Назначение**: Автоматическая маркировка значимых контейнеров через CSS классы для удобной навигации в коде через DevTools и указания агенту места в разметке.

**Формат автоматической маркировки:**
- Префикс: `avto-`
- Формат: `avto-{Base58_8символов}`
- Примеры: `avto-X7pL2nQ`, `avto-K9mP4rT`
- Признак: класс начинается с `avto-` → чистый контейнер без JS/CSS зависимостей

**Правила применения:**

1. **Маркировать автоматическим классом** (`avto-{hash}`):
   - Основные секции (`<main>`, `<section>`, корневые `.container-fluid`)
   - Функциональные блоки (`.card`, корневые контейнеры виджетов)
   - Корневые контейнеры компонентов без JS-зависимостей

2. **НЕ маркировать**:
   - Мелкие обертки (`.mb-3`, `.input-group`, `.d-flex` без функционального значения)
   - Части компонентов (`.card-header`, `.card-body` внутри `.card`)
   - Элементы только для сетки (`.row`, `.col-*`)

3. **Осмысленные ID** (не `avto-*`):
   - Элементы с JS-зависимостями (`getElementById`, `querySelector`, `ref`)
   - Элементы с CSS-селекторами по ID
   - Элементы форм, привязанные к JS (`v-model`, обработчики)

**Изоляция:**
- Классы `avto-*` используются только для маркировки, не используются в JS/CSS
- ID используются только для JS-зависимых элементов (стандартная практика)
- Полная изоляция: классы = маркировка, ID = функциональность

**⚠️ ОБЯЗАТЕЛЬНОЕ ПРАВИЛО: Детерминированные хэши для экземпляров компонентов**

Все экземпляры переиспользуемых компонентов должны иметь детерминированные уникальные хэши для возможности кастомной стилизации конкретных экземпляров.

**Требования:**
- Каждый экземпляр компонента должен иметь computed свойство `instanceHash`, которое генерирует детерминированный Base58 хэш на основе уникального идентификатора экземпляра
- Хэш должен быть стабильным между сессиями - один и тот же идентификатор всегда дает один и тот же хэш
- Хэш генерируется через утилиту `window.hashGenerator.generateMarkupClass(uniqueId)`
- Уникальный идентификатор берется из props компонента (например, `coinId`, `rowId`, `cellId`, `field` и т.д.)

**Примеры:**
- `cell-coin`: `instanceHash` на основе `coinId` prop
- `cell-row-select`: `instanceHash` на основе `rowId` prop
- `cell-num`: `instanceHash` на основе `cellId` prop (опционально)
- `header-cell`: `instanceHash` на основе `sortField` или `label` prop
- `sortable-header`: `instanceHash` на основе `field` prop

**Использование в шаблонах:**
```html
<div :class="[instanceHash, cssClasses.cell]">
  <!-- контент компонента -->
</div>
```

**Исключения:**
- Компоненты-контейнеры, которые используются только один раз в приложении (например, `table-data`, `header-coins`) - могут использовать статический хэш или не иметь хэша
- Компоненты без уникальных идентификаторов - могут не иметь `instanceHash` (но рекомендуется добавить prop для идентификации)

**Примеры:**
```html
<!-- ✅ Автоматическая маркировка через класс -->
<div class="container-fluid app-main-container avto-X7pL2nQ">
  <main class="avto-K9mP4rT row justify-content-center">
    <div class="col-12 col-lg-4 mb-4">
      <div class="card avto-M3nP8qW">
        <!-- Контент -->
      </div>
    </div>
  </main>
</div>

<!-- ✅ Маркировка header и footer -->
<header class="position-fixed top-0 start-0 w-100 app-header avto-vn6jdk3M">
  <!-- Контент хедера -->
</header>

<!-- ✅ JS-зависимый элемент через ID (не маркируется avto-) -->
<div id="splash-screen" class="app-splash-screen">
  <!-- Splash screen имеет ID и используется в JS через getElementById -->
</div>
```

**Цель**: Удобная навигация в DevTools и указание агенту места в коде через инспектор.

**⚠️ Терминология**: Под словом "страница" пользователь всегда имеет в виду контейнер с классом `avto-X7pL2nQ` (корневой контейнер контента приложения). ИИ-агент должен понимать, что когда пользователь говорит "страница", речь идет именно об этом контейнере.


#### Паттерн создания хедеров карточек

**Принцип**: Все хедеры карточек изначально создаются подобно `ui/components/header-coins.js` - сначала просто с заголовком, но потом дополняются набором специфичных своих контролов.

**Эталонный пример**: Компонент `ui/components/header-coins.js` является эталонным примером этого паттерна. Он демонстрирует структуру и подход к созданию хедеров карточек.

**Преимущества паттерна:**
- **Единообразие структуры**: Все хедеры карточек следуют единому паттерну, что упрощает понимание и поддержку кода.
- **Постепенное наращивание функциональности**: Хедер начинается с простого заголовка, затем дополняется специфичными контролами по мере необходимости.
- **Переиспользование**: Общие элементы (заголовок, базовые контролы) могут быть переиспользованы в разных хедерах.
- **Упрощение поддержки**: Единая структура упрощает поиск и исправление проблем в хедерах карточек.

**Структура компонента хедера карточки:**
- **Props**: Принимает данные от родительского компонента (счетчики, состояние, данные для отображения).
- **Emits**: Эмитит события для взаимодействия с родительским компонентом (переключение dropdown, выбор, поиск, удаление из таблицы и т.д.).
- **Methods**: Содержит методы для обработки событий и форматирования данных (форматирование дат, получение данных из избранного, проверка состояний).
- **Template**: Использует x-template шаблон для разделения логики и разметки.

**Правила создания хедеров карточек:**
- Начинать с простого заголовка и базовой структуры.
- Добавлять специфичные контролы постепенно, по мере необходимости.
- Использовать props для получения данных от родительского компонента.
- Использовать emits для взаимодействия с родительским компонентом.
- Следовать структуре и паттернам, используемым в `header-coins.js`.

- **Формат цветов**: Все цвета должны использовать формат **HSLA** (HSL с альфа-каналом) для консистентности и удобства настройки. Избегать использования `rgba()`, `rgb()`, hex-кодов (`#ffffff`) в CSS правилах.
- **Рутовые переменные Bootstrap**: Все кастомные цвета должны отталкиваться от рутовых переменных цвета тем в Bootstrap (`--bs-primary`, `--bs-secondary`, `--bs-body-color`, `--bs-border-color` и т.д.). Кастомные цвета определяются в `ui/styles/theme-colors.css` через HSL переменные и переопределяют или расширяют стандартные переменные Bootstrap.
- **Цветовые состояния метрик**:
  - BTC Dominance: цветная иконка если >50%, серая если нет
  - FGI (Fear & Greed Index): красный 0-25, оранжевый 26-45, серый 46-55, зеленый 56-75, яркий зеленый 76-100
  - VIX: зеленый <20, серый 20-30, красный >30
  - Funding Rate: зеленый отрицательный, серый нейтральный, красный положительный
  - Long/Short Ratio: красный <1.0, серый =1.0, зеленый >1.0
  - Open Interest: всегда серый

### Компоненты

#### Хедер
- **Позиционирование**: `position-fixed top-0`, высота 50px, z-index через `var(--z-index-header)` (1050, совпадает с Bootstrap modal)
- **Фон**: Темный графит через `var(--color-header-bg)`, тень сверху
- **Паддинги**: Боковые паддинги отсутствуют (0px) для десктоп и мобильной версии. Контейнер хедера без боковых отступов.
- **Структура**: 3 секции
  - Левая: гамбургер (50px, SVG иконка для пиксельной четкости)
  - Средняя: селект математической модели (десктоп) / dropdown (мобильная) + вкладки отображения (Bootstrap радиокнопки). Занимает всю доступную ширину (`flex-grow-1`), без боковых паддингов.
  - Правая: кнопки рефреша и смены темы (2x50px)
- **Селекты**: Полупрозрачный фон через `var(--color-header-overlay)`, белый текст через `var(--color-header-text)`, полупрозрачная стрелка через data URI SVG
- **Вкладки**: Bootstrap `btn-group` с `btn-check`, активная вкладка — белый текст через `var(--color-header-text)`, неактивные — полупрозрачный белый через `var(--color-header-text-muted)`
- **Кнопки управления**: Без ободков, только иконки, легкая подсветка при наведении через `var(--color-header-overlay)`
- **Dropdown меню**: Всегда в темной теме (не реагируют на переключение темы приложения). Идентичное оформление для десктоп и мобильной версии. Используют дефолтные радиусы скругления Bootstrap. **Примечание**: Выпадающие меню внутри `<main>` (не в хедере) используют единый стиль с радиусом `2.5px`, контрастной рамкой и тенью (см. раздел "Карточки" → "Выпадающие меню внутри `<main>`").
- **Всплывающие подсказки (tooltips)**: Всегда в темной теме (не реагируют на переключение темы приложения). Инициализируются через Bootstrap Tooltip API с `data-bs-theme="dark"`.
- **Адаптивность**: На десктопе селект модели, на мобильных — dropdown. Вкладки: десктоп — радиокнопки, мобильные — dropdown

#### Футер
- **Позиционирование**: `position-fixed bottom-0`, z-index через `var(--z-index-footer)` (1000, совпадает с Bootstrap dropdown), тень сверху
- **Адаптивность**:
  - Десктоп: все индикаторы равномерно распределены (`justify-content-between`)
  - Мобильные: только метрики рынка с горизонтальной прокруткой (`overflow-x-auto`, `-webkit-overflow-scrolling: touch`), версии фреймворков скрыты
- **Высота**: На мобильных `p-5` (≈48px), на десктопе `p-2` (≈8px)
- **Метрики**: Моноширинный шрифт `font-monospace` с размером `1.05em` для предотвращения "дергания" строки при анимации

#### Сплэш-экран
- **Позиционирование**: `position-fixed`, полный экран, z-index через `var(--z-index-splash)` (9999 - самый верхний слой), темный фон через `hsla(0, 0%, 0%, 0.95)`
- **Контейнер**: Максимальная ширина 400px, ширина 90%
- **Поле ввода API-ключа**:
  - По умолчанию: прозрачный фон, прозрачная рамка, полупрозрачный текст (`opacity: 0.5`)
  - При фокусе: фон `var(--bs-dark)`, рамка `var(--bs-secondary)`, полная непрозрачность
- **Индикатор загрузки**: Анимированные точки (1,2,3,4,5) вместо спиннера

#### Карточки
- **Паттерн создания хедеров карточек**: Все хедеры карточек изначально создаются подобно `ui/components/header-coins.js` - сначала просто с заголовком, но потом дополняются набором специфичных своих контролов. Это обеспечивает единообразие структуры, упрощает поддержку и позволяет постепенно наращивать функциональность. Компонент `header-coins.js` является эталонным примером этого паттерна. Подробнее см. раздел "Паттерн создания хедеров карточек" в `docs/architect.md`.
- **Хедер карточки (`.card-header`)**:
  - Вертикальные паддинги: `padding-top: 0.75rem`, `padding-bottom: 0.75rem` для улучшенной читаемости
  - Фон: Более темный и "стальной" оттенок через `var(--color-card-header)` для визуального отделения от основного контента
  - Кнопки: Единый стиль для всех кнопок в хедерах карточек (класс `.card-header .btn`)
    - Фон: `var(--bs-secondary-bg)` (адаптируется под тему)
    - Рамки: Через `var(--color-border)` (нормальное состояние), `var(--color-border-hover)` (при hover/focus)
    - Прозрачность: Полностью непрозрачные (`opacity: 1`)
    - Hover/Focus: Фон через `var(--color-button-hover)`
    - Фиксированная ширина: Кнопка обновления (`.cg-update-btn`) имеет фиксированную ширину `7em` для предотвращения "прыжков" интерфейса при показе спиннера
- **Выпадающие меню внутри `<main>`**: Единый стиль для всех выпадающих меню (счетчик монет, поиск, избранное, контекстное меню)
  - Радиус скругления: `2.5px` (единый для всех меню)
  - Рамка: Высококонтрастная через `var(--color-border)` для светлой темы, `var(--color-dropdown-border-dark)` для темной темы
  - Тень: Усиленная для обеих тем для визуального отделения
  - Цвет текста: Одинаковый во всех состояниях (hover, focus, active) через `var(--bs-body-color)` для единообразия
  - Подсветка: Только фон меняется при hover/focus/active, цвет текста остается неизменным
  - **Стиль фокуса**: Фокус пунктов меню использует общую рутовую переменную `--color-focus-bg` (такой же стиль, как у выбранных строк таблицы), без черной рамки Bootstrap. Подробнее см. раздел "Паттерны универсальных компонентов" в `docs/architect.md`.

#### Универсальные компоненты меню

**Принцип**: Использование универсальных компонентов `menu-item` и `dropdown-menu` для обеспечения единообразия всех выпадающих меню в приложении.

**Компонент `menu-item` (пункт меню):**
- **Структура**: Иконка (слева) + Текст команды (центр) + Индикатор (справа)
- **Стилизация**:
  - Все паддинги на `<span>` элементах, `<a>` имеет `padding: 0`
  - Фиксированные ширины: иконка `4em`, индикатор `3em`
  - Минимальная высота: `3rem`
  - Вертикальные паддинги: `1rem` для всех элементов
  - Горизонтальные паддинги: `1rem` для текста, `0` для иконок и индикаторов
- **Интеграция с системой UI элементов**: Использует `uiElementHelper` для загрузки конфигурации (иконки, labels, tooltips) из `ui-element-mapping.json`
- **Индикаторы**: Универсальный объект `indicator` для статусов (selected, disabled, loading, warning, error) или язычков переходов (submenu, external, modal)

**Компонент `dropdown-menu` (выпадающее меню):**
- **Клавиатурная навигация**:
  - `Escape` — закрытие меню
  - `ArrowDown` / `ArrowUp` — перемещение по пунктам
  - `Home` / `End` — переход к первому/последнему пункту
  - `Tab` — стандартная навигация
- **Автофокус**: Автоматический фокус на первом элементе при открытии
- **Управление курсором**: Prop `trigger-selector` автоматически устанавливает `cursor: pointer` на элементе-триггере
- **Позиционирование**: Гибкое позиционирование (absolute/fixed) с различными размещениями (bottom-start, bottom-end, top-start, top-end)
- **Закрытие**: Закрытие по клику вне меню, по Escape, через событие `@close`

**Правила использования:**
- Все выпадающие меню должны использовать компонент `dropdown-menu`
- Все пункты меню должны использовать компонент `menu-item`
- Каждый экземпляр должен иметь уникальный `instanceId` для `instanceHash`
- Элементы-триггеры должны иметь `trigger-selector` для автоматической установки курсора

Подробнее см. раздел "Паттерны универсальных компонентов" в `docs/architect.md`.

#### Счетчик монет
- **Кнопка счетчика (`.cg-coins-counter`)**:
  - Фиксированная ширина: `5em` для двузначных чисел и слеша (например: "99/99")
  - Выравнивание текста: По центру
  - Формат отображения:
    - При частичном выборе (`0 < selectedCount < totalCount`): Формат "n/N" (n - выбрано, N - всего)
    - При отсутствии выбора или выборе всех: Только общее число монет (N)
  - Выделение числа выбранных монет: Класс `.cg-counter-selected` с полужирным шрифтом (`font-weight: 600`) и цветом `var(--bs-body-color)` для контраста в обеих темах
- **Выпадающее меню счетчика (`.cg-counter-dropdown`)**:
  - Опции: "Выбрать все", "Отменить все", "Удалить отмеченные"
  - Подсветка: Работает корректно для всех элементов, включая disabled, через специфичные CSS правила с `!important`

#### Отключенные поля ввода
- **Disabled поля в темной теме**: Глобальные стили для всех типов disabled полей ввода
  - `.form-control:disabled`, `.form-control[readonly]`: Темный фон `var(--bs-secondary-bg)`, приглушенный текст `var(--bs-secondary-color)`, прозрачность `0.65`
  - `.form-select:disabled`: Те же стили для select элементов
  - `.form-check-input:disabled`: Темный фон для чекбоксов
  - `textarea.form-control:disabled`: Стили для текстовых областей
  - Bootstrap по умолчанию применяет белый фон для disabled элементов, что плохо видно в темной теме, поэтому используются кастомные стили с `!important` для переопределения

#### Цветовые состояния предупреждений
- **Неудачные тикеры при добавлении монет**: Кастомные цвета для лучшей читабельности на светлом фоне
  - Бейджи: Класс `.bg-warning-dark` с темно-оранжевым фоном через `var(--color-warning-dark)`
  - Текст предупреждений: Класс `.text-warning-dark` с темно-оранжевым цветом через `var(--color-warning-dark)`
  - Стандартный желтый цвет Bootstrap (`bg-warning`, `text-warning`) заменен на более контрастный темно-оранжевый для улучшенной читабельности

#### Панелька загрузки монет
- **Позиционирование панельки загрузки (`.cg-loading-panel`)**:
  - Верхний край панельки выровнен с верхней границей card-header (на уровне кнопок управления)
  - Реализовано через отрицательный `margin-top` с использованием единиц `ex` для точного вертикального позиционирования
  - Формула: `calc(-2.2rem + 0.45ex)` учитывает высоту поля ввода (`form-control-sm`) и корректировку для точного выравнивания

### Типографика

- **Моноширинный шрифт**: Используется для метрик и числовых значений (`font-monospace`) для предотвращения "дергания" строки при анимации
- **Размеры**: Базовый размер шрифта Bootstrap, метрики с увеличенным размером `1.05em` для визуального совпадения

### Анимации и переходы

- **Индикатор загрузки метрик**: Вращающиеся символы `| / - \` (каждые 150мс) вместо тире во время загрузки
- **Индикатор загрузки цитаты**: Анимированные точки (1,2,3,4,5) на сплэш-экране
- **Переходы**: Плавные переходы для hover состояний (`transition: background-color 0.2s`)

### Иконки

- **Font Awesome 6.5.1**: Основная библиотека иконок
- **SVG иконки**: Используются для пиксельной четкости (гамбургер в хедере)
- **Централизованная система UI элементов**: Архитектурный принцип централизованного управления UI элементами (иконки, кнопки, меню) через декларативную конфигурацию (JSON) и стили через CSS переменные, зарутованные от Bootstrap. Подробнее см. раздел "Система иконок" ниже.
- **Цветовые состояния**: Иконки метрик меняют цвет в зависимости от значения

#### Система иконок

**Принцип**: Архитектурный принцип централизованного управления UI элементами (иконки, кнопки, меню) через декларативную конфигурацию (JSON) и стили через CSS переменные, зарутованные от Bootstrap.

**Концепт централизованного управления UI элементами:**
Система UI элементов построена на принципе разделения ответственности:
- **Декларативная конфигурация** (JSON): Все соответствия иконок и команд описаны в структурированном JSON файле `ui/config/ui-element-mapping.json`, что обеспечивает единую точку истины для всех UI элементов в приложении.
- **Стили через CSS переменные**: Все стили иконок определяются через CSS переменные в `ui/styles/icons.css`, зарутованные от Bootstrap переменных, что обеспечивает автоматическую адаптацию к темам и консистентность с остальными элементами интерфейса.
- **Программный доступ**: Утилита `ui/utils/ui-element-helper.js` предоставляет функции для получения конфигурации UI элементов (иконки, labels, tooltips) по категориям, что упрощает использование в компонентах и обеспечивает типобезопасность через структурированные категории.

**Преимущества централизованной системы UI элементов:**
- **Единая точка управления**: Все соответствия иконок и команд находятся в одном JSON файле, что упрощает настройку и поддержку.
- **Консистентность стилей**: Стили иконок определяются через CSS переменные, зарутованные от Bootstrap переменных (`--bs-body-color`, `--bs-primary`, `--bs-secondary` и т.д.), что обеспечивает автоматическую адаптацию к темам.
- **Легкость добавления новых элементов**: Добавление нового UI элемента требует только обновления JSON файла и при необходимости CSS переменных.
- **Централизованное управление цветами**: Цвета иконок фреймворков и статусов определяются через CSS переменные, что упрощает настройку и поддержку.
- **Раздельные tooltips**: Система поддерживает раздельные tooltips для основной части (иконка + текст) и индикатора в компонентах button и menu-item, что обеспечивает более точное описание функциональности.

**Структура системы:**
- **JSON файл соответствий** (`ui/config/ui-element-mapping.json`): Содержит схему соответствий:
  - **Схема `icons` (одна иконка → много команд)**: Позволяет одной иконке соответствовать нескольким командам. Например, иконка `fas fa-star` может использоваться для команд `favorite`, `add-to-favorites`, `remove-from-favorites`. Структура:
    ```json
    "icons": {
      "fas fa-star": {
        "commands": {
          "favorite": { "category": "actions", "label": "Избранное", "tooltip": "Выбрать избранное" },
          "add-to-favorites": { "category": "actions", "label": "В избранное", "tooltip": "Добавить в избранное" },
          "remove-from-favorites": { "category": "actions", "label": "Убрать из избранного", "tooltip": "Убрать из избранного" }
        },
        "defaultCommand": "favorite",
        "baseIcon": "fas fa-star"
      }
    }
    ```
  - **Индикаторы**: Индикаторы (статусы и навигационные указатели) также хранятся в схеме `icons` как команды с `category: "indicators"`. Примеры: `selected`, `disabled`, `loading`, `warning`, `error`, `favorite`, `not-favorite`, `submenu`, `external`, `modal`
- **CSS файл стилей** (`ui/styles/icons.css`): Определяет CSS переменные для цветов иконок:
  - `--icon-vuejs-color`: Цвет иконки Vue.js (hsl(152, 48%, 53%))
  - `--icon-bootstrap-color`: Цвет иконки Bootstrap (hsl(264, 45%, 47%))
  - `--icon-status-warning-color`: Цвет иконки предупреждения
  - `--icon-status-error-color`: Цвет иконки ошибки
  - `--icon-status-success-color`: Цвет иконки успеха
  - `--icon-action-color`: Цвет иконок действий (зарутован от `--bs-body-color`)
  - `--icon-action-hover-color`: Цвет иконок действий при hover (зарутован от `--bs-primary`)
  - `--icon-action-disabled-color`: Цвет иконок действий в disabled состоянии (зарутован от `--bs-secondary`)
- **Утилита** (`ui/utils/ui-element-helper.js`): Предоставляет функции для получения конфигурации UI элементов:
  - **Основные функции схемы "одна иконка → много команд"**:
    - `getIconCommands(iconClass)`: Получить все команды для иконки
    - `getIconByCommand(command)`: Получить базовую иконку для команды
    - `getCommandData(command)`: Получить данные команды (category, label, tooltip)
    - `getIconForCommand(category, command)`: Получить иконку для команды
  - **Функции для категорий** (используют `getIconForCommand` внутри):
    - `getActionIcon(action)`: Получить иконку для действия
    - `getNavigationIcon(navigation)`: Получить иконку для навигации
    - `getStatusIcon(status)`: Получить иконку для статуса
    - `getMetricIcon(metric)`: Получить иконку для метрики
    - `getFrameworkIcon(framework)`: Получить иконку для фреймворка
    - `getOtherIcon(other)`: Получить иконку для другого элемента
    - `getThemeIcon(theme)`: Получить иконку темы в зависимости от текущей темы
    - `getIconLabel(category, name)`: Получить label (текст для UI) для иконки
    - `getIconTooltip(category, name)`: Получить tooltip (подсказку) для иконки
    - `getFrameworkColor(framework)`: Получить цвет для иконки фреймворка
  - **Функции для индикаторов**:
    - `getIndicatorIcon(type, value)`: Получить иконку для indicator
    - `getIndicatorLabel(type, value)`: Получить label для indicator
    - `getIndicatorTooltip(type, value)`: Получить tooltip для indicator
  - **Функции для SVG-иконок**:
    - `isSVGIcon(iconClass)`: Проверить, является ли иконка SVG-файлом (начинается с 'icon-')
    - `getSVGIconPath(iconName)`: Получить путь к SVG-файлу иконки (например, 'icon-cross' → 'ui/assets/icons/icon-cross.svg')
- **Статистика проекта** (`review-app.html`): Страница статистики проекта с рейтингом файлов по количеству строк кода, диаграммами распределения по типам файлов и топ-10 файлов, автоматической статистикой по иконкам и цветам. Отображает общее количество строк кода, файлов, иконок и цветов. Использует единую систему управления review-файлами через `ui/review-manager.js` и `ui/review-styles.css`. Является первой вкладкой в системе review-файлов.
- **Каталог иконок** (`ui/assets/review-icons.html`): Интерактивный каталог всех иконок проекта с интеграцией `ui-element-helper.js`. Отображает все иконки в табличном формате, сгруппированные по актуальным категориям (Actions, Navigation, Statuses & Indicators, Metrics, Frameworks & Brands). Показывает превью иконок, идентификаторы, команды, использование в компонентах, файлы/источники. Поддерживает фильтрацию по типу иконки, категории и поиск. Автоматически определяет использование иконок в компонентах и помечает неиспользуемые иконки полупрозрачными. Интегрирован с `ui-element-helper.js` для динамической загрузки данных из `ui-element-mapping.json`. Использует единую систему управления review-файлами через `ui/review-manager.js` и `ui/review-styles.css`.
- **Каталог цветов** (`ui/styles/review-colors.html`): Интерактивный каталог всех цветовых переменных проекта. Отображает все CSS переменные в табличном формате, сгруппированные по категориям (Primary, Info, Success, Warning, Danger, Bootstrap, Theme, UI элементы, Header, Dropdown, Other). Показывает идентификаторы переменных, превью цветов, HSL, RGB, Hex значения, использование в компонентах. Поддерживает фильтрацию по категории и поиск. Использует единую систему управления review-файлами через `ui/review-manager.js` и `ui/review-styles.css`.
- **Каталог сообщений** (`ui/interaction/review-messages.html`): Каталог шаблонов сообщений Bootstrap с примерами оформления. Отображает 4 типа сообщений (info, success, warning, danger) в различных вариантах: стандартные сообщения, сообщения с возможностью закрытия (dismissible), компактные сообщения. Каждый тип представлен в виде карточки с несколькими примерами использования. Использует единую систему управления review-файлами через `ui/review-manager.js` и `ui/review-styles.css`.
- **Система управления review-файлами**:
  - **`ui/review-manager.js`**: Единый JavaScript-менеджер для всех review-файлов, обеспечивающий хедер с вкладками для переключения между review и общие утилиты (сортировка, фильтрация). Автоматически определяет текущий review-файл и создает навигационные вкладки в стиле 2010-х.
  - **`ui/review-styles.css`**: Единые стили для всех review-файлов, включая стили хедера с вкладками в стиле 2010-х (градиенты, эффект выступания активной вкладки), общие стили таблиц, фильтров и ячеек.
- **SVG-иконки** (`ui/assets/icons/`): Папка для хранения SVG-иконок проекта. Иконки хранятся с префиксом `icon-` (например, `icon-cross.svg`). SVG-иконки поддерживают CSS переменные для настройки цвета и толщины линий (например, `--icon-cross-stroke-width`, `--icon-cross-color`). Загружаются через `<object>` тег для поддержки `currentColor` и CSS переменных. Компоненты `button` и `menu-item` автоматически определяют SVG-иконки через `uiElementHelper.isSVGIcon()` и загружают их через `uiElementHelper.getSVGIconPath()`.

**Правила использования:**
- **Единая схема "одна иконка → много команд"**: Все иконки и команды хранятся в схеме `icons`. Даже если у иконки только одна команда, она все равно должна быть в этой схеме для единообразия.
- **Все соответствия иконок и команд должны быть описаны в `ui/config/ui-element-mapping.json`**: При добавлении нового UI элемента добавить в секцию `icons` с соответствующими командами.
- **⚠️ ВАЖНО - Встроенное содержимое**: Для избежания CORS проблем при работе с `file://` протоколом, содержимое `ui-element-mapping.json` встроено непосредственно в `ui/utils/ui-element-helper.js` как константа `uiElementMapping`. При добавлении новой иконки или команды **ОБЯЗАТЕЛЬНО** обновлять оба места:
  1. `ui/config/ui-element-mapping.json` (для документации и каталога иконок)
  2. Встроенное содержимое в `ui/utils/ui-element-helper.js` (для работы приложения)
- **Индикаторы хранятся как команды с `category: "indicators"`**: Индикаторы (статусы и навигационные указатели) хранятся в той же схеме `icons`, но имеют `category: "indicators"` и дополнительные поля `type` и `value`.
- **Стили иконок должны использовать CSS переменные из `ui/styles/icons.css`**: Избегать хардкодных цветов в CSS правилах и inline стилях.
- **Цвета иконок должны быть зарутованы от Bootstrap переменных**: Для автоматической адаптации к темам.
- **Компоненты `button` и `menu-item` используют схему `icons`**: При указании `icon-command` компоненты ищут команду в схеме `icons` через `uiElementHelper`.
- **Раздельные tooltips**: Компоненты `button` и `menu-item` поддерживают раздельные tooltips для основной части (иконка + текст) и индикатора. Паддинги Bootstrap переносятся на дочерние элементы (`.button-main`, `.button-indicator`, `.menu-item-main`, `.menu-item-indicator`) для корректной работы tooltips.
- **SVG-иконки**: SVG-иконки хранятся в `ui/assets/icons/` с префиксом `icon-`. Поддерживают CSS переменные для настройки цвета и толщины. Загружаются через `<object>` тег для поддержки `currentColor` и CSS переменных. Определяются через `uiElementHelper.isSVGIcon()` и загружаются через `uiElementHelper.getSVGIconPath()`.
- **Статистика проекта**: Страница `review-app.html` отображает статистику проекта с рейтингом файлов, диаграммами и автоматической статистикой по иконкам и цветам. Является первой вкладкой в системе review-файлов.
- **Каталог иконок**: Интерактивный каталог `ui/assets/review-icons.html` отображает все иконки проекта с интеграцией `ui-element-helper.js`, группировкой по категориям, фильтрацией и поиском. Использует единую систему управления review-файлами.
- **Каталог цветов**: Интерактивный каталог `ui/styles/review-colors.html` отображает все цветовые переменные проекта с группировкой по категориям, фильтрацией и поиском. Использует единую систему управления review-файлами.

**Связь с Bootstrap:**
CSS переменные иконок используют Bootstrap переменные как основу:
- `--icon-action-color: var(--bs-body-color)`
- `--icon-action-hover-color: var(--bs-primary)`
- `--icon-action-disabled-color: var(--bs-secondary)`
- `--icon-status-warning-color`: Использует Bootstrap warning цвет
- `--icon-status-error-color`: Использует Bootstrap danger цвет
- `--icon-status-success-color`: Использует Bootstrap success цвет

Это обеспечивает автоматическую адаптацию цветов иконок к темам приложения (light/dark) и консистентность с остальными элементами интерфейса.

### Адаптивность

- **Breakpoints Bootstrap**: Использование стандартных breakpoints Bootstrap (`d-none d-md-block`, `d-block d-md-none`)
- **Мобильная версия**: Упрощенный интерфейс на мобильных (dropdown вместо селектов, скрытие второстепенной информации)
- **Touch-friendly**: Увеличенные области нажатия на мобильных (футер `p-5` вместо `p-2`)

#### Адаптивные отступы (Spacing)

**ОБЯЗАТЕЛЬНО**: Для управления горизонтальными отступами на мобильных устройствах **ВСЕГДА** использовать Bootstrap утилиты отступов (Spacing utilities), а не кастомные CSS стили или медиа-запросы.

**Принцип работы:**
- Bootstrap использует mobile-first подход: классы без префикса применяются ко всем размерам экрана, начиная с мобильных
- Для обнуления горизонтальных отступов на мобильных устройствах используется класс `px-0` (padding-x: 0)
- Если требуется восстановить отступы на больших экранах, используются responsive классы с префиксами: `px-md-3`, `px-lg-4` и т.д.

**Примеры использования:**
- `<main class="px-0">` — обнуляет горизонтальные паддинги на всех размерах экрана
- `<div class="col-12 mb-4 px-0">` — обнуляет горизонтальные паддинги у колонки на всех размерах экрана
- `<div class="px-0 px-md-3">` — обнуляет паддинги на мобильных, восстанавливает на средних и больших экранах

**Документация Bootstrap:**
- [Bootstrap 5 Spacing utilities](https://getbootstrap.com/docs/5.3/utilities/spacing/)
- [Bootstrap 5 Responsive utilities](https://getbootstrap.com/docs/5.3/utilities/spacing/#notation)

**ВАЖНО**: Не использовать кастомные CSS правила или медиа-запросы для управления отступами, если это можно сделать через Bootstrap утилиты. Это обеспечивает консистентность, упрощает поддержку и следует принципу приоритета Bootstrap классов.

### Полосы прокрутки

- **Вертикальная полоса прокрутки**: Всегда видна глобально (`overflow-y: scroll` на `html`) для предотвращения "дергания" интерфейса при появлении/исчезновении полосы
- **Горизонтальная полоса прокрутки**: Скрыта визуально глобально (`overflow-x: hidden` на `html`/`body`, скрытие через CSS `::-webkit-scrollbar { height: 0 }` и `scrollbar-width: none`), но горизонтальная прокрутка доступна через Shift + колесико мыши (или пальцем на мобильных)

---

## Interaction (паттерны UX)

*Базовые паттерны взаимодействия приложения: навигация, формы, обратная связь, состояния загрузки*

### Навигация

- **Хедер**: Фиксированный сверху, всегда видимый, обеспечивает быстрый доступ к основным функциям
- **Гамбургер-меню**: Левая секция хедера (50px), готов к реализации бокового меню
- **Вкладки отображения (View Tabs)**: Переключение между режимами отображения данных (%, Компл. дельты, Градиенты, MAX, min, Баланс Δ). Реализует парадигму переключения представлений (View Switching Pattern) с централизованным управлением состоянием через корневой компонент. Активное представление сохраняется в `localStorage` для персистентности между сессиями.

### Формы и ввод данных

- **PIN-код**: 4-значный PIN для разблокировки приложения, автоматическая валидация при вводе
- **API-ключ**: Поле ввода на сплэш-экране, скрыто до фокуса (полупрозрачное), автоматическое сохранение при вводе
- **Селекты**: Десктоп — нативный `<select>`, мобильные — Bootstrap dropdown для лучшего UX

### Обратная связь

- **Индикаторы загрузки**:
  - Метрики рынка: вращающиеся символы `| / - \`
  - Цитата на сплэш-экране: анимированные точки
- **Цветовые состояния**: Визуальная обратная связь через цвет иконок метрик (красный/зеленый/серый)
- **Сообщения об ошибках**: Alert компоненты Bootstrap для отображения ошибок

### Состояния компонентов

- **Загрузка**: Флаги `isLoading` для отслеживания состояния загрузки, визуальные индикаторы
- **Активность**: Выделение активных элементов (вкладки, выбранные опции)
- **Отключенные элементы**: `disabled` состояние для кнопок и полей ввода во время загрузки

### Доступность

- **Подсказки**: `title` атрибуты для кнопок и элементов управления. Bootstrap tooltips с инверсной темой для визуального контраста с хедером.
- **Клавиатурная навигация**:
  - Стандартная навигация через Tab
  - Полная поддержка клавиатурной навигации в выпадающих меню (Escape, стрелки, Home/End) через компонент `dropdown-menu`
  - Автофокус на первом элементе при открытии меню
- **Семантическая разметка**: Использование правильных HTML элементов (`<header>`, `<footer>`, `<button>`)
- **Курсор**: Автоматическая установка `cursor: pointer` на элементах-триггерах выпадающих меню через prop `trigger-selector` компонента `dropdown-menu`

### Персистентность

- **Тема**: Сохранение выбранной темы в `localStorage`
- **API-ключ**: Сохранение API-ключа в `localStorage` (обфусцированно)
- **PIN-код**: Сохранение PIN-кода в `localStorage` (обфусцированно)
- **Активная вкладка (Active View State)**: Сохранение идентификатора активного представления в `localStorage` через Vue watcher в корневом компоненте. Состояние автоматически восстанавливается при перезагрузке приложения. Все компоненты получают активное представление реактивно через `this.$root.activeTab` или `window.appRoot.activeTab`.
- **Список монет**: Сохранение выбранных монет, избранных монет, данных CoinGecko в `localStorage`

### Кэширование данных

- **Иконки монет**: Кэшируются в localStorage (`cgIconsCache`) с временным ограничением (не чаще 1 раза в час). Обеспечивают мгновенную загрузку при повторном отображении. Время последнего обновления хранится в `cgIconsCacheTimestamp`.
- **Метрики рынка**: Кэшируются в localStorage (`marketMetricsCache`) с временным ограничением (не чаще 1 раза в час). Неопределенные метрики (`"—"`) продолжают загружаться из API с показом анимации. Время последнего обновления хранится в `marketMetricsCacheTimestamp`.
- **Фильтрация анимации**: Символы анимации (`|`, `/`, `-`, `\`) не попадают в кэш, заменяются на `"—"` перед сохранением через метод `filterSpinnerChars()`.
- **Валидация кэша**: Кэшируются только успешно загруженные данные с реальными значениями. Пустые значения не кэшируются.

### Многоязычность

- **Определение языка**: Автоматическое определение языка системы через `navigator.language`
- **Генерация контента**: Философские предложения генерируются на языке системы пользователя

### Паттерны взаимодействия

- **Переключение темы**: Кнопка в хедере, мгновенное применение через `data-bs-theme`
- **Обновление страницы**: Кнопка рефреша в хедере
- **Разблокировка приложения**: PIN-код на сплэш-экране, автоматическая проверка при вводе
- **Настройка API**: Поле ввода на сплэш-экране, сохранение при нажатии кнопки сохранения
- **Глобальное закрытие выпадающих списков**: Клик за пределами любого выпадающего списка закрывает все открытые выпадающие элементы одновременно. Реализовано через глобальный обработчик в корневом компоненте (`closeAllDropdowns()`), который использует событие `close-all-dropdowns` для уведомления всех компонентов. Обеспечивает консистентное поведение и чистый интерфейс (одновременно открыт только один элемент).
- **Управление списком монет**:
  - **Поиск монет**: Поле поиска с автодополнением, поддержка множественного поиска через разделители (запятые, слеши, спецсимволы). Результаты сортируются: полные совпадения по тикеру → тикеры, начинающиеся с запроса → остальные по популярности. Выпадающий список поиска автоматически закрывается при клике вне области поиска. При вводе числа (например, "50") в поле поиска автоматически появляются два кастомных пункта: "Топ N по капитализации" и "Топ N по дневному объему" для быстрого добавления топ монет. При клике на один из пунктов загружаются соответствующие монеты из CoinGecko API и добавляются в таблицу.
  - **Избранное монет (хранилище избранного)**: Структура хранения - массив объектов `{id, symbol, name}`. При добавлении в избранное сохраняются ID, тикер (uppercase) и полное название монеты. В выпадающем списке избранного показывается только тикер, полное название отображается в tooltip при наведении. Ширина выпадающего списка - по контенту (`width: auto; min-width: fit-content;`). Выпадающий список избранного автоматически закрывается при клике вне области избранного. Автоматически добавленные монеты с неудачными тикерами (неудачные попытки добавления после 5 попыток) имеют ID с префиксом `failed-{ticker}` и отображаются с иконкой рефреша (`fa-sync-alt`) вместо фирменной иконки монеты для визуального отличия. Избранное - это хранилище: монета может одновременно присутствовать в таблице и в избранном. При добавлении монеты в таблицу она НЕ удаляется из избранного. При удалении монеты из таблицы она добавляется в избранное (если ещё не там). При клике на пункт избранного: если монета уже в таблице - показывается отметка, если нет - монета добавляется в таблицу.
  - **Контекстное меню**: Доступно по клику на блок иконка+тикер. Операции: открытие на Bybit (в новой вкладке), управление избранным (добавление/удаление из избранного), удаление из таблицы, удаление. Пункт избранного отображается с динамической иконкой звездочки (золотая для избранных, серая для не избранных) и текстом "В избранное" или "Убрать из избранного" в зависимости от статуса. Контекстное меню автоматически закрывается при клике вне области меню или блока монеты.
  - **Система избранного**: Персистентное хранение избранных монет в `localStorage` под ключом `cgFavoriteCoinIds` (массив ID монет). Состояние избранного сохраняется между сессиями и автоматически восстанавливается при загрузке приложения. Управление избранным доступно через контекстное меню монет. Статус избранного определяется через метод `isFavorite(coinId)`, переключение статуса - через метод `toggleFavorite(coinId)`. Система интегрирована с существующим контекстным меню, не требуя дополнительных UI элементов.
  - **Счетчик монет**: Интерактивная кнопка с выпадающим меню для массовых операций. Отображает количество выбранных монет или общее число. Формат "n/N" показывается только при частичном выборе, в остальных случаях показывается только общее число монет. Выпадающее меню предоставляет опции: "Выбрать все", "Отменить все", "Удалить отмеченные". Кнопка имеет фиксированную ширину `5em` для предотвращения "прыжков" интерфейса. Подсветка уже добавленных монет в списке поиска использует тему-зависимый класс `.cg-search-item-selected` с `var(--bs-secondary-bg)` для корректной работы в обеих темах.
  - **Сортировка таблицы**: Циклическая сортировка по клику на заголовок колонки (3 состояния: desc → asc → null → desc). Первый клик по несортированной колонке начинается с сортировки по убыванию (desc). Глобальный mixin `table-sort-mixin.js` для переиспользования.
  - **Линейное добавление монет списком тикеров**: Режим автоматически активируется при вставке списка тикеров в поле поиска. Тикеры разделяются любыми не-алфавитными символами, автоматически фильтруются (удаляются уже присутствующие в таблице или избранном, удаляются отсутствующие на CoinGecko). Добавление происходит последовательно, по одной монете, с визуальной обратной связью: поле поиска блокируется, показывается текущий добавляемый тикер, список оставшихся тикеров уменьшается по мере добавления. Неудачно загруженные монеты пропускаются и повторяются в следующем цикле. После 5 неудачных попыток монета автоматически добавляется в избранное с префиксом `failed-`. Процесс можно остановить вручную через кнопку "Остановить". Используется адаптивный таймаут для обработки rate limiting CoinGecko API (экспоненциальный backoff: базовое значение 300ms, удваивается при 429 ошибке до максимума 10 секунд, постепенно уменьшается при успешных запросах).
  - **Добавление монет из избранного в таблицу**: При добавлении монеты из избранного с неудачным тикером (`failed-{ticker}`) система автоматически находит реальный CoinGecko ID по тикеру. Если монета не найдена или попытка добавления не удалась - монета остается в избранном с оригинальным ID. Если монета уже присутствует в таблице - просто закрывается dropdown (отметка показывается в UI).

### Парадигма переключения представлений (View Switching Pattern)

**Принцип**: Централизованное управление состоянием активного представления (view) через единую точку истины в корневом компоненте приложения. Парадигма обеспечивает реактивное распространение состояния между компонентами и синхронизацию UI элементов с активным представлением.

**Архитектурная модель**: Single Source of Truth (SSOT) для состояния представления с реактивным распространением через Vue.js реактивную систему.

**Компоненты парадигмы**:

1. **Централизованное состояние** (`app/app-ui-root.js`):
   - `activeTab`: Реактивное свойство корневого компонента, хранящее идентификатор активного представления
   - Персистентность: Сохранение состояния в `localStorage` через Vue watcher для восстановления при перезагрузке
   - Инициализация: Загрузка сохраненного состояния из `localStorage` при монтировании приложения

2. **Управление переключением** (`ui/interaction/header.js`):
   - `switchTab(tabId)`: Метод переключения активного представления, обновляющий `activeTab` в корневом компоненте
   - `displayTabs`: Конфигурация доступных представлений (массив объектов с `id` и `label`)
   - Побочные эффекты: Автоматическое управление видимостью компонентов (например, закрытие панели настроек при переключении на определенные представления)

3. **Реактивное распространение состояния**:
   - Доступ к состоянию: Компоненты получают `activeTab` через `this.$root.activeTab` или `window.appRoot.activeTab`
   - Computed свойства: Компоненты могут определять computed свойства, зависящие от `activeTab`, для автоматического обновления при изменении
   - Условный рендеринг: Использование `v-if` и `v-show` для условного отображения компонентов в зависимости от активного представления

4. **UI компоненты переключения**:
   - Десктоп: Bootstrap `btn-group` с радиокнопками (`btn-check`) для визуального переключения
   - Мобильные устройства: Bootstrap dropdown для компактного отображения списка представлений
   - Визуальная обратная связь: Выделение активного представления через CSS классы (`app-header-tab-active`)

**Преимущества парадигмы**:
- **Единая точка истины**: Состояние активного представления хранится в одном месте, исключая рассинхронизацию
- **Реактивность**: Автоматическое обновление всех зависимых компонентов при изменении активного представления
- **Персистентность**: Сохранение выбранного представления между сессиями пользователя
- **Расширяемость**: Легкое добавление новых представлений через конфигурацию `displayTabs`
- **Разделение ответственности**: Логика переключения изолирована в компоненте хедера, состояние управляется корневым компонентом

**Структура данных**:
```javascript
// Корневой компонент (app-ui-root.js)
data() {
  return {
    activeTab: 'percent' // Идентификатор активного представления
  };
},
watch: {
  activeTab(newTab) {
    localStorage.setItem('activeTab', newTab); // Персистентность
  }
}

// Компонент хедера (header.js)
displayTabs: [
  { id: 'percent', label: '%' },
  { id: 'complex-deltas', label: 'Компл. дельты' },
  { id: 'gradients', label: 'Градиенты' },
  // ... другие представления
]
```

**Правила использования**:
- Все компоненты должны получать `activeTab` из корневого компонента, не хранить локальную копию
- Переключение представлений должно происходить только через метод `switchTab()` компонента хедера
- Новые представления добавляются в массив `displayTabs` компонента хедера
- Компоненты, зависящие от активного представления, должны использовать computed свойства для реактивности

**Связь с другими паттернами**:
- **Условный рендеринг**: Использование `v-if="activeTab === 'percent'"` для отображения компонентов
- **Column Visibility Management**: Использование `activeTab` для управления видимостью колонок таблиц (см. раздел "Управление видимостью колонок таблицы через вкладки" ниже)
- **State Management**: Парадигма является частью общей архитектуры управления состоянием приложения

### Управление видимостью колонок таблицы через вкладки

**Принцип**: Переиспользуемый Vue mixin для управления видимостью колонок таблицы на основе активного представления (active view). Реализует паттерн View-based Column Visibility Management, интегрируясь с парадигмой переключения представлений через реактивное отслеживание `activeTab` из корневого компонента.

**Файл**: `ui/utils/column-visibility-mixin.js`

**Архитектурная интеграция**: Mixin является расширением парадигмы переключения представлений (View Switching Pattern), используя централизованное состояние `activeTab` для управления видимостью колонок таблиц. Это обеспечивает синхронизацию отображения данных с активным представлением пользователя.

**Использование**:
1. Подключить mixin к компоненту: `mixins: [window.columnVisibilityMixin]`
2. Определить конфигурацию колонок в `data()`: `columnVisibilityConfig`
3. Добавить `<colgroup>` с `<col>` тегами в таблицу
4. Добавить классы к `<th>` и `<td>` элементам
5. Опционально: определить метод `getColumnClasses()` для явного указания всех классов колонок

**Пример конфигурации**:
```javascript
columnVisibilityConfig: {
  'percent': { hide: ['col-cd'] },           // На вкладке "%" скрыть колонки CD
  'complex-deltas': { hide: ['col-percent'] } // На вкладке "Компл. дельты" скрыть колонки процентов
}
```

**Преимущества**:
- **Переиспользуемость**: Один mixin для всех таблиц с переключением видимости колонок
- **Гибкость конфигурации**: Поддержка префиксного совпадения классов (например, 'col-percent' скрывает все 'col-percent-*')
- **Мгновенное переключение**: Использование CSS классов на `<col>`, `<th>` и `<td>` для мгновенного скрытия/показа без перерисовки таблицы
- **Автоматическое определение активной вкладки**: Получение активной вкладки из корневого компонента через `$root` или `window.appRoot`

**Структура mixin**:
- **Computed свойства**:
  - `activeTab()`: Реактивное computed свойство, получающее идентификатор активного представления из корневого компонента через `this.$root.activeTab` или `window.appRoot.activeTab`. Обеспечивает автоматическое обновление при изменении активного представления.
  - `columnVisibilityClasses()`: Реактивное computed свойство, возвращающее объект с CSS классами видимости для каждой колонки. Ключи объекта соответствуют классам колонок, значения - `'col-hidden'` для скрытых колонок или пустая строка для видимых. Вычисляется на основе `activeTab` и конфигурации `columnVisibilityConfig`.
  - `visibleColumnsCount()`: Реактивное computed свойство, подсчитывающее число видимых колонок на текущей вкладке через DOM (подсчет `<col>` элементов без класса `col-hidden`). Используется для автоматического расчета ширины колонок. Подсчет через DOM обеспечивает учет динамических колонок, генерируемых через `v-for`.
- **Watchers**:
  - `visibleColumnsCount`: Отслеживает изменение числа видимых колонок и автоматически вызывает `updateColumnWidths()` для пересчета ширины колонок при изменении видимости. Использует `$nextTick()` для гарантии обновления DOM.
  - `activeTab`: Отслеживает изменение активной вкладки и автоматически пересчитывает ширину колонок при переключении представлений через `$nextTick()` для гарантии обновления DOM.
- **Methods**:
  - `updateColumnWidths(visibleCount)`: Метод для автоматического расчета и установки ширины колонок на основе числа видимых колонок. Находит таблицу через `this.$el.querySelector('table')`, получает все видимые колонки из `<colgroup>`, рассчитывает ширину как `100% / число видимых колонок` и устанавливает её для каждой видимой колонки через `style.width`. Обеспечивает равномерное распределение ширины колонок при переключении вкладок.
- **Hooks**:
  - `mounted()`: Вызывает `updateColumnWidths()` через `$nextTick()` после монтирования компонента для инициализации ширины колонок при первой загрузке.

**CSS правила** (в `ui/styles/layout.css`):
- `col.col-hidden { width: 0; }` - скрытие колонки через colgroup
- `table th.col-hidden, table td.col-hidden { display: none; }` - универсальное правило для скрытия ячеек

**Правила использования**:
- Конфигурация должна быть определена в `data()` компонента как `columnVisibilityConfig`
- Классы колонок должны быть добавлены к `<col>`, `<th>` и `<td>` элементам
- Для префиксного совпадения использовать базовый класс (например, 'col-percent' для 'col-percent-1h', 'col-percent-24h' и т.д.)
- Опционально определить метод `getColumnClasses()` для явного указания всех классов колонок (если не определен, используются классы из конфигурации)

**Пример использования в компоненте**:
```javascript
window.cmpMyTable = {
  template: '#my-table-template',
  mixins: [window.columnVisibilityMixin],
  data() {
    return {
      columnVisibilityConfig: {
        'tab1': { hide: ['col-secondary'] },
        'tab2': { hide: ['col-primary'] }
      }
    };
  },
  methods: {
    getColumnClasses() {
      return ['col-primary', 'col-secondary', 'col-tertiary'];
    }
  }
};
```

**Интеграция с парадигмой переключения представлений**:
- **Зависимость от централизованного состояния**: Mixin использует `activeTab` из корневого компонента, обеспечивая синхронизацию с парадигмой переключения представлений
- **Реактивное обновление**: При изменении `activeTab` в корневом компоненте, computed свойство `columnVisibilityClasses()` автоматически пересчитывается, обновляя видимость колонок
- **Конфигурация представлений**: Каждое представление (tab) может иметь свою конфигурацию скрываемых колонок через `columnVisibilityConfig`
- **Мгновенное переключение**: Использование CSS классов обеспечивает мгновенное скрытие/показ колонок без перерисовки таблицы, что критично для плавного UX при переключении представлений

**Автоматический расчет ширины колонок**:
- Mixin автоматически рассчитывает и устанавливает ширину колонок на основе числа видимых колонок на текущей вкладке
- Ширина рассчитывается как `100% / число видимых колонок` для равномерного распределения пространства между видимыми колонками
- Пересчет происходит автоматически при:
  - Переключении вкладок (через watcher `activeTab`)
  - Изменении видимости колонок (через watcher `visibleColumnsCount`)
  - Монтировании компонента (через hook `mounted()`)
- Реализация использует DOM для точного подсчета видимых колонок, что учитывает динамические колонки, генерируемые через `v-for` (например, колонки CD)
- Ширина устанавливается через inline стили (`style.width`) для мгновенного применения без перерисовки таблицы

**Связь с другими фичами**:
- Используется вместе с `table-sort-mixin.js` для полнофункциональных таблиц с сортировкой и переключением видимости колонок
- CSS правила универсальны и работают с любыми таблицами, не привязаны к конкретным классам
- Является частью общей архитектуры управления состоянием представлений (View State Management)
- Автоматический расчет ширины колонок обеспечивает оптимальное использование пространства при переключении между представлениями с разным числом видимых колонок

---

## Обновление принципов

Принципы и правила в этом документе обновляются по командам пользователя:
- **Команды `UI:`** — обновляют раздел "Interface (оформление)"
- **Команды `UX:`** — обновляют раздел "Interaction (паттерны UX)"

ИИ-агент должен немедленно обновлять соответствующий раздел при получении команды.

## Связанные документы

Этот документ является частью системы документации проекта:
- **`.cursorrules`** — правила работы ИИ-агента с проектом
- **`docs/architect.md`** — архитектурный план проекта, принципы математической модели, технические ограничения
- **`docs/guide-ii.md`** (этот файл) — руководство по интерфейсу и взаимодействию

**ВАЖНО**: При изменении принципов UI/UX в этом документе необходимо проверить согласованность с другими документами проекта. См. раздел "Отслеживание согласованности архитектурных правил" в `docs/architect.md` и `.cursorrules`.

---

*Документ обновляется по мере развития проекта и изменения требований*

