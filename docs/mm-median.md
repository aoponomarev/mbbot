# Математическая модель: Median-based Analysis

> Оглавление
1. **Математическая модель: Median-based Analysis** `docs/mm-median.md`
   - § *Понятия* — термины и сокращения математической модели.
   - § *Структура модели* — организация файлов модели "median".
   - § *Переменные и метрики* — входные данные, промежуточные значения, выходные метрики.
   - § *Вычислительный трек* — алгоритмы расчета метрик (PRC Weights, CPT, CD, CDH).
   - § *Особенности реализации* — специфичные детали реализации и отображения.
   - § *Статус миграции* — текущее состояние миграции из старого приложения.

> § <br> **ПОНЯТИЯ**

- **PV (Price Variation)** — вариация цены. Изменение цены актива за фиксированный временной интервал, выраженное в процентах.
- **CD (Cumulative Delta)** — накопительная дельта. Интегральная сила движения цены, вычисляемая как накопительная сумма PV за фиксированные временные интервалы.
- **CDH (Cumulative Delta on Horizon)** — CD на горизонте прогноза. Интерполированное значение CD для заданного пользователем горизонта прогноза.
- **CPT (Coin Potential)** — потенциал монеты. Взвешенная сумма PV, отражающая потенциал монеты с учетом важности временных интервалов.
- **PRC (Proximity Relevance Coefficient)** — коэффициент близости и релевантности. Вес, определяющий важность временного интервала для заданного горизонта прогноза.
- **hDays (Horizon Days)** — горизонт прогноза. Пользовательский параметр (1-90 дней), определяющий временной горизонт для прогнозирования.
- **Сырые значения** — значения, вычисленные без учета весов (например, сырые CD — простая накопительная сумма PV).
- **Взвешенные значения** — значения, вычисленные с учетом PRC-весов (например, взвешенные CD — накопительная сумма PV, умноженных на веса).
- **Временные узлы** — фиксированные временные интервалы для расчета метрик: 1 час, 24 часа, 7 дней, 14 дней, 30 дней, 200 дней.
- **Интерполяция** — метод вычисления промежуточных значений между известными точками данных. В контексте CDH используется линейная интерполяция между соседними CD значениями.

> § <br> **СТРУКТУРА МОДЕЛИ**

Модель "median" организована в структуре `mm/median/` с подпапками:

- **utils/** — базовые математические утилиты (clamp, safeNumber, tanh, median).
- **core/** — основные функции (PRC-веса, пересчет).
- **metrics/** — метрики (CPT, CD, CMD, CGR, DIN, AGR, MDN, медианы).

Все функции модели экспортируются через `window.mmMedian*` (например: `window.mmMedianCPT`, `window.mmMedianCD`).

> § <br> **ПЕРЕМЕННЫЕ И МЕТРИКИ**

## Входные данные

**PV (Price Variations)** — вариации цены:
- **Формат**: массив из 6 значений `[PV1h, PV24h, PV7d, PV14d, PV30d, PV200d]`.
- **Единицы**: проценты (%).
- **Источник**: CoinGecko API (`price_change_percentage_*_in_currency`).
- **Использование**: базовые данные для расчета всех производных метрик.

**hDays (Horizon Days)** — горизонт прогноза:
- **Диапазон**: 1-90 дней.
- **По умолчанию**: 2 дня.
- **Использование**: расчет PRC-весов, интерполяция CDH.

## Промежуточные значения

**PRC Weights (Proximity Relevance Coefficients)** — коэффициенты близости и релевантности:
- **Формат**: массив из 6 весов `[w1, w2, w3, w4, w5, w6]` (сумма = 1.0).
- **Зависимость**: зависит от `hDays` — чем ближе временной интервал к горизонту, тем больше вес.
- **Использование**: взвешивание PV для расчета CPT и взвешенных CD.

## Выходные метрики

**CPT (Coin Potential)** — потенциал монеты:
- **Описание**: взвешенная сумма PV, отражающая потенциал монеты.
- **Единицы**: проценты (%).
- **Использование**: компонент метрики AGR (Impulse).

**CD (Cumulative Delta)** — накопительная дельта:
- **Типы**:
  - **Сырые CD** (`cd1`..`cd6`): простая накопительная сумма PV.
  - **Взвешенные CD** (`cd1w`..`cd6w`): накопительная сумма PV, умноженных на PRC-веса.
- **Единицы**: проценты (%).
- **Использование**: базовые значения для интерполяции CDH.

**CDH (Cumulative Delta on Horizon)** — CD на горизонте прогноза:
- **Типы**:
  - **Сырое CDH** (`cdh`): интерполяция между сырыми CD значениями.
  - **Взвешенное CDH** (`cdhw`): интерполяция между взвешенными CD значениями.
- **Единицы**: проценты (%).
- **Использование**: компонент метрики AGR (Alignment).

> § <br> **ВЫЧИСЛИТЕЛЬНЫЙ ТРЕК**

## PRC Weights (Proximity Relevance Coefficients)

**Назначение**: Вычисление весов для временных интервалов на основе близости к горизонту прогноза.

**Входные данные**:
- `hDays` — горизонт прогноза в днях (1-90).
- `timeFramesDays` — массив временных узлов: `[1/24, 1, 7, 14, 30, 200]` дней.

**Алгоритм**:
1. Для каждого временного узла `t[i]` вычисляется расстояние до горизонта: `distance[i] = |hDays - t[i]|`.
2. Вычисляется обратное расстояние с нормализацией: `weight[i] = 1 / (1 + distance[i])`.
3. Веса нормализуются так, чтобы их сумма равнялась 1.0.

**Формула**:
```
weight[i] = (1 / (1 + |hDays - t[i]|)) / Σ(1 / (1 + |hDays - t[j]|))
```

**Реализация**: `mm/median/core/prc-weights.js` → `computePRCWeights(hDays)`.

**Выходные данные**: Массив из 6 весов `[w1, w2, w3, w4, w5, w6]`, где `Σw[i] = 1.0`.

## CPT (Coin Potential)

**Назначение**: Вычисление потенциала монеты как взвешенной суммы вариаций цены.

**Входные данные**:
- `pvs` — массив из 6 значений PV: `[PV1h, PV24h, PV7d, PV14d, PV30d, PV200d]`.
- `prcWeights` — массив из 6 PRC-весов.

**Алгоритм**:
1. Каждое значение PV умножается на соответствующий PRC-вес.
2. Результаты суммируются.

**Формула**:
```
CPT = Σ(PV[i] × w[i]) для i = 0..5
```

где:
- `PV[i]` — вариация цены для временного узла `i`.
- `w[i]` — PRC-вес для временного узла `i`.

**Реализация**: `mm/median/metrics/cpt.js` → `computeEnhancedCPT(pvs, hDays)`.

**Выходные данные**:
- `enhancedCpt` — числовое значение CPT.
- `enhancedCptFormatted` — отформатированное значение CPT (строка).

## CD (Cumulative Delta)

**Назначение**: Вычисление накопительной дельты как интегральной силы движения цены.

**Входные данные**:
- `pvs` — массив из 6 значений PV: `[PV1h, PV24h, PV7d, PV14d, PV30d, PV200d]`.
- `prcWeights` — массив из 6 PRC-весов.

**Алгоритм**:
1. **Сырые CD**: для каждого временного узла вычисляется накопительная сумма PV.
2. **Взвешенные CD**: для каждого временного узла вычисляется накопительная сумма PV, умноженных на PRC-веса.

**Формула (сырые CD)**:
```
cdRaw[0] = PV[0]
cdRaw[i] = cdRaw[i-1] + PV[i] для i = 1..5
```

**Формула (взвешенные CD)**:
```
cdW[0] = PV[0] × w[0]
cdW[i] = cdW[i-1] + PV[i] × w[i] для i = 1..5
```

**Реализация**: `mm/median/metrics/cd.js` → `calculateCDsWeighted(pvs, prcWeights)`.

**Выходные данные**:
- `cd1`..`cd6` — сырые CD значения для временных узлов [1h, 24h, 7d, 14d, 30d, 200d].
- `cd1w`..`cd6w` — взвешенные CD значения для временных узлов [1h, 24h, 7d, 14d, 30d, 200d].

**Важно**:
- **Сырые CD** (cd1..cd6) зависят только от фиксированных временных интервалов и **не должны пересчитываться** при изменении горизонта прогноза.
- **Взвешенные CD** (cd1w..cd6w) зависят от PRC-весов, которые зависят от hDays, поэтому **должны пересчитываться** при изменении горизонта прогноза.
- Пересчитывается также CDH.

## CDH (Cumulative Delta on Horizon)

**Назначение**: Интерполяция CD для заданного горизонта прогноза.

**Входные данные**:
- `series` — массив CD значений (сырые `cdRaw` или взвешенные `cdW`).
- `hDays` — горизонт прогноза в днях (1-90).
- `timeFramesDays` — массив временных узлов: `[1/24, 1, 7, 14, 30, 200]` дней.

**Алгоритм**:
1. Находятся два соседних временных узла `t[i]` и `t[i+1]`, между которыми находится `hDays`.
2. Извлекаются соответствующие CD значения `cd[i]` и `cd[i+1]`.
3. Выполняется линейная интерполяция между `cd[i]` и `cd[i+1]` на основе положения `hDays` между `t[i]` и `t[i+1]`.

**Формула**:
```
Если hDays == t[i]: CDH = cd[i]
Если hDays < t[0]: CDH = cd[0]
Если hDays > t[5]: CDH = cd[5]
Иначе:
  ratio = (hDays - t[i]) / (t[i+1] - t[i])
  CDH = cd[i] + ratio × (cd[i+1] - cd[i])
```

**Реализация**: `mm/median/metrics/cd.js` → `approximateCDHFromSeries(series, hDays)`.

**Выходные данные**:
- `cdh` — сырое CDH значение (интерполяция между сырыми CD).
- `cdhw` — взвешенное CDH значение (интерполяция между взвешенными CD).

**Важно**:
- **Сырое CDH** (cdh) **НЕ пересчитывается** при изменении горизонта прогноза — оно зависит только от сырых CD, которые не меняются.
- **Взвешенное CDH** (cdhw) **пересчитывается** при изменении горизонта прогноза — оно зависит от взвешенных CD, которые пересчитываются с новыми PRC-весами.
- Сырые CD1-CD6 остаются неизменными.

> § <br> **ОСОБЕННОСТИ РЕАЛИЗАЦИИ**

## Отображение CD в таблице

**Осознанное расхождение со старым функционалом**: В новом приложении в таблице отображаются **взвешенные CD** (`cd1w`..`cd6w`, `cdhw`), а сырые значения (`cd1`..`cd6`, `cdh`) доступны в tooltip при наведении.

**Обоснование**:
- Взвешенные значения используются в расчете AGR (более важны для анализа).
- Учитывают важность временных интервалов через PRC-веса.
- Согласованы с отображением в портфолио.

**В старом проекте**: В основной таблице показывались сырые CD1-CD6 и взвешенное CDH.

> § <br> **СТАТУС МИГРАЦИИ**

Документ находится в процессе миграции из старого приложения. Заполняется по мере миграции компонентов модели.

