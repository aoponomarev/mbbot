# Математические модели проекта

## Коммит 28d980b от 12.12.2025 : Add colorization, rounding features and color adjustments to cell-num
◆ Добавлены функции округления до 0.5, округления больших чисел до целых и префикс "~" для округленных до 0 для математической модели. → Добавлен prop `roundToHalf: Boolean` в компонент `cell-num.js` для округления до 0.5 (0.0, 0.5, 1.0, 1.5 и т.д.). Обновлен метод `applyRounding()` для поддержки `roundToHalf` с формулой `Math.round(value * 2) / 2`. Добавлено computed свойство `effectivePrecision()` для определения эффективной точности с учетом `roundToHalf` и больших чисел. Для чисел с абсолютным значением >= 10 автоматически используется `precision: 0` (округление до целых). Обновлены computed свойства `hasFractionPart()` и `fractionPart()` для использования `effectivePrecision`. Добавлена логика в `numberPrefix()` для автоматического добавления префикса "~" если значение округлилось до 0 (но изначально не было 0). Добавлен флаг `roundToHalf: true` во все числовые колонки (процентные и CD) в конфигурации `tableColumns` в `coingecko.js`. Обновлен метод `formatDecimal()` для использования `effectivePrecision`. ◉ Адаптивное округление демонстрирует принцип контекстной точности: малые значения округляются до 0.5 для сохранения детализации, большие — до целых для читаемости. Префикс "~" для значений, округленных до 0, показывает внимание к семантике: пользователь должен понимать, что значение приблизительное, а не точный ноль. Это критично для корректной интерпретации данных математической модели.

## Коммит dddc5c8 от 11.12.2025 : Stage 2: Migrate CPT calculation and create Complex Deltas tab with stubs
◆ Мигрирован расчет CPT (Coin Potential) для математической модели "median" (Этап 2), создана вкладка "Комплексные дельты" с таблицей и заглушками для CD значений. → Создан файл `mm/median/metrics/cpt.js` с функциями `computeEnhancedCPT(values, hDays)` - расчет улучшенного CPT с адаптацией весов к горизонту прогноза, `formatEnhancedCPT(value)` - форматирование CPT для отображения (формат "+X.XX" или "-X.XX"). Базовые веса `baseW` адаптированы для новых интервалов CoinGecko: `[0.38, 0.32, 0.18, 0.08, 0.03, 0.01]` для `[1h, 24h, 7d, 14d, 30d, 200d]`. Файл обернут в IIFE для изоляции области видимости. Экспортируется через `window.mmMedianCPT`. В `ui/api/coingecko.js` добавлен метод `calculateCPT(coin, hDays)` для расчета CPT для монеты. CPT рассчитывается при обновлении данных монет (`fetchCoinGecko`), при добавлении топ монет (`addTopCoinsByMarketCap`, `addTopCoinsByVolume`), при загрузке из localStorage (в `mounted()` хуке). Результаты сохраняются в `coin.enhancedCpt` и `coin.enhancedCptFormatted`. Создан компонент `ui/api/complex-deltas.js` для таблицы "Комплексные дельты". Компонент отображает таблицу с колонками: №, Тикер, CDH, CD6, CD5, CD4, CD3, CD2, CD1. CDH выделяется цветом (как в старом приложении). Поддерживает сортировку по колонкам через mixin. Использует заглушки для CD значений (частичные суммы `pvs`) до миграции Этапа 3. Динамическая позиция CDH вставляется в зависимости от горизонта прогноза. В `index.html` добавлен x-template для компонента `complex-deltas-template`, компонент подключен с условием `activeTab === 'complex-deltas'`. В хедере уже была вкладка "Компл. дельты" с id `complex-deltas`. В `app/app-ui-root.js` зарегистрирован компонент `app-complex-deltas`. В `ui/styles/layout.css` добавлены стили для колонки CDH: цвет `hsl(200, 44%, 55%)` для светлой темы, `hsl(200, 50%, 65%)` для темной темы, `font-weight: bold`. В `migration-plan.md` обновлен статус Этапа 2 как завершенного, добавлена запись в историю изменений. ◉ Интеграция CPT в UI демонстрирует пошаговый подход к миграции: расчет выполняется автоматически при обновлении данных, результаты сохраняются для последующего использования. Создание вкладки "Комплексные дельты" с заглушками показывает проактивную подготовку инфраструктуры: UI готов к миграции Этапа 3, что упростит интеграцию реальных расчетов CD. Адаптация весов под новые интервалы CoinGecko обеспечивает актуальность модели.

## Коммит 70e4822 от 11.12.2025 : Stage 1: Migrate math helpers, PRC weights, and PV1h clip functions
◆ Мигрированы базовые утилиты и функции математической модели "median" (Этап 1): базовые математические утилиты, PRC-веса и клиппинг PV1h. Все модули изолированы через IIFE для предотвращения конфликтов имен. → Создан файл `mm/median/utils/math-helpers.js` с базовыми утилитами: `clamp(x, min, max)` - ограничение значения в диапазоне, `safeNumber(x, def)` - безопасное преобразование в число, `tanh(x)` - гиперболический тангенс, `median(arr)` - вычисление медианы массива. Все функции экспортируются через `window.mmMedianHelpers`. Создан файл `mm/median/core/prc-weights.js` с функцией `computePRCWeights(hDays)` для расчета PRC-весов (Proximity Relevance Coefficients) для заданного горизонта прогноза. Обновлен массив `timeFramesDays` для новых интервалов CoinGecko: `[1/24, 1, 7, 14, 30, 200]` (вместо старых `[1/24, 1, 7, 30, 60, 90]`). Экспортируется через `window.mmMedianPRCWeights`, также экспортируется `timeFramesDays` для использования в UI. Создан файл `mm/median/core/pv1h-clip.js` с функциями `computePV1hClipThreshold(coins)` - расчет порога клиппинга (99-й перцентиль), `smoothPV1h(pv1h)` - сглаживание PV1h с клиппингом, `setPV1hClip(threshold)`, `getPV1hClip()`. Константа `EPSILON = 0.2` для порога чувствительности. Экспортируется через `window.mmMedianPV1hClip`. Все файлы обернуты в IIFE (Immediately Invoked Function Expression) для изоляции области видимости и предотвращения конфликтов имен переменных (`clamp`, `safeNumber`). Переменные внутри IIFE переименованы (`clampFn`, `safeNumberFn`) для избежания конфликтов. Все файлы подключены в `index.html` в правильном порядке: после Vue.js, перед компонентами. Порядок загрузки: `math-helpers.js` → `prc-weights.js` → `pv1h-clip.js` (зависимости). В `migration-plan.md` обновлен статус Этапа 1 как завершенного, добавлена запись в историю изменений. ◉ Начало миграции математической модели "median": создан фундамент из базовых утилит, PRC-весов и функций клиппинга. Изоляция через IIFE предотвращает конфликты имен в глобальной области видимости, что критично для безопасной миграции. Адаптация PRC-весов под новые интервалы CoinGecko демонстрирует эволюцию модели: временные рамки обновлены для соответствия актуальным данным API.

## Коммит 8413ccf от 09.12.2025 : Align market metrics variables with source for mathematical model compatibility
◆ Приведены переменные метрик рынка в соответствие с первоисточником для использования в математической модели, добавлены глобальные переменные и экспорт в `window`. → В `ui/api/market-metrics.js` добавлены глобальные переменные: `fgiVal`, `vixVal`, `btcDomVal`, `oiVal`, `frVal`, `lsrVal` (числовые значения), `vixAvailable` (boolean флаг доступности VIX). Добавлена функция `updateWindowMetrics()` для экспорта всех числовых значений в `window` (совместимость с первоисточником). Добавлен третий источник VIX (Alpha Vantage) в fallback стратегию получения VIX. Исправлено форматирование Open Interest: теперь `'$' + oiVal.toFixed(2)` вместо `'$' + (value / 1e9).toFixed(2) + 'B'` (как в первоисточнике). Все функции теперь возвращают `numericValue` помимо форматированной строки для отображения. Глобальные переменные инициализируются при загрузке модуля через `updateWindowMetrics()`. ◉ Создан мост между системой метрик рынка и математической моделью: экспорт числовых значений в `window` обеспечивает совместимость с первоисточником, позволяя модели использовать актуальные метрики для расчетов. Это заложило основу для интеграции математической модели с данными рынка, критично для корректности вычислений.