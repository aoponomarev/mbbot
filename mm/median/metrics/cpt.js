// =========================
// CPT (Coin Potential) - потенциал монеты
// Источник: old_app_not_write/math-model.js (строки 48-77)
// =========================
// CPT (Coin Potential) - потенциал монеты для краткосрочной торговли.
// Физический смысл: акцент на ближние окна 1–7d для оценки краткосрочного потенциала.
// Взаимосвязь: использует взвешенную сумму PV с адаптацией весов к горизонту.
// В контексте ТА: показывает краткосрочный потенциал роста/падения монеты.

// Изолируем область видимости через IIFE для предотвращения конфликтов имен
(function() {
  'use strict';
  
  // Импорт утилит (должен быть загружен до этого файла)
  // Используем clamp из mmMedianHelpers (хотя в этом файле clamp не используется напрямую)
  // Оставляем для совместимости и возможного использования в будущем

/**
 * computeEnhancedCPT(values, hDays)
 * Расчет улучшенного CPT (Coin Potential) для монеты
 * Источник: old_app_not_write/math-model.js, строки 54-71
 * 
 * Физический смысл: акцент на ближние окна 1–7d для оценки краткосрочного потенциала.
 * Взаимосвязь: использует взвешенную сумму PV с адаптацией весов к горизонту.
 * В контексте ТА: показывает краткосрочный потенциал роста/падения монеты.
 * 
 * Алгоритм:
 * 1. Базовые веса baseW: [0.38, 0.32, 0.18, 0.08, 0.03, 0.01]
 *    - Соответствуют временным узлам: [1h, 24h, 7d, 14d, 30d, 200d]
 *    - Больший вес у ближних окон (1h, 24h, 7d)
 *    - Меньший вес у дальних окон (14d, 30d, 200d)
 * 2. Адаптация весов к горизонту прогноза (g = min(hDays, 7) / 7):
 *    - При малом горизонте (g → 1): увеличиваем вес ближних окон, уменьшаем дальних
 *    - При большом горизонте (g → 0): веса приближаются к базовым
 * 3. Нормализация весов (сумма = 1.0)
 * 4. Взвешенная сумма PV значений
 * 5. Применение контраста (1 + 0.35 * g) для усиления ближних окон на малом горизонте
 * 
 * ВАЖНО: Базовые веса адаптированы для новых интервалов CoinGecko:
 * - Старое приложение: [1h, 24h, 7d, 30d, 60d, 90d]
 * - Новое приложение: [1h, 24h, 7d, 14d, 30d, 200d]
 * - baseW[3]: было для 30d → стало для 14d (НОВЫЙ интервал)
 * - baseW[4]: было для 60d → стало для 30d (сдвинут с индекса 3)
 * - baseW[5]: было для 90d → стало для 200d (НОВЫЙ интервал, заменяет 60d и 90d)
 * 
 * Веса для новых интервалов сохранены аналогично старым:
 * - 14d (индекс 3): 0.08 (как было для 30d)
 * - 30d (индекс 4): 0.03 (как было для 60d)
 * - 200d (индекс 5): 0.01 (как было для 90d, но для более длинного интервала)
 * 
 * @param {Array<number>} values - Массив из 6 значений PV (Price Variations) для временных узлов [1h, 24h, 7d, 14d, 30d, 200d]
 * @param {number} hDays - Горизонт прогноза в днях (используется для адаптации весов)
 * @returns {number} Значение CPT (может быть положительным или отрицательным)
 * 
 * Примеры:
 * computeEnhancedCPT([1, 2, 3, 4, 5, 6], 7) → число (взвешенная сумма с адаптацией к горизонту 7 дней)
 * При hDays = 2: больший вес у 1h и 24h, меньший у 200d
 * При hDays = 30: веса приближаются к базовым
 */
function computeEnhancedCPT(values, hDays) {
  // Базовые веса для временных узлов [1h, 24h, 7d, 14d, 30d, 200d]
  // Источник: old_app_not_write/math-model.js, строка 55
  // ВАЖНО: Адаптированы для новых интервалов CoinGecko
  const baseW = [0.38, 0.32, 0.18, 0.08, 0.03, 0.01];
  
  // Коэффициент адаптации к горизонту (g = min(hDays, 7) / 7)
  // При малом горизонте (≤7 дней) g → 1, при большом g → 0
  // Источник: old_app_not_write/math-model.js, строка 56
  const g = Math.min(hDays, 7) / 7;
  
  // Адаптация весов к горизонту прогноза
  // Ближние окна (1h, 24h, 7d): увеличиваем вес при малом горизонте
  // Дальние окна (14d, 30d, 200d): уменьшаем вес при малом горизонте
  // Источник: old_app_not_write/math-model.js, строки 57-64
  const adjW = [
    baseW[0] * (1 + 0.40 * g), // 1h: +40% при малом горизонте
    baseW[1] * (1 + 0.30 * g), // 24h: +30% при малом горизонте
    baseW[2] * (1 + 0.20 * g), // 7d: +20% при малом горизонте
    baseW[3] * (1 - 0.25 * g), // 14d: -25% при малом горизонте
    baseW[4] * (1 - 0.35 * g), // 30d: -35% при малом горизонте
    baseW[5] * (1 - 0.45 * g)  // 200d: -45% при малом горизонте
  ];
  
  // Нормализация весов (сумма = 1.0)
  // Источник: old_app_not_write/math-model.js, строки 65-66
  const wSum = adjW.reduce((a, b) => a + b, 0);
  const w = adjW.map(x => x / wSum);
  
  // Взвешенная сумма PV значений
  // Источник: old_app_not_write/math-model.js, строки 67-68
  let score = 0;
  for (let i = 0; i < 6; i++) {
    score += (values[i] || 0) * w[i];
  }
  
  // Применение контраста для усиления ближних окон на малом горизонте
  // Контраст: 1 + 0.35 * g (при малом горизонте увеличивает значение)
  // Источник: old_app_not_write/math-model.js, строки 69-70
  const contrast = 1 + 0.35 * g;
  
  return score * contrast;
}

/**
 * formatEnhancedCPT(value)
 * Форматирование значения CPT для отображения
 * Источник: old_app_not_write/math-model.js, строки 73-77
 * 
 * Формат: "+X.XX" для положительных значений, "-X.XX" для отрицательных
 * Округление до 2 знаков после запятой
 * 
 * @param {number} value - Значение CPT для форматирования
 * @returns {string} Отформатированное значение CPT (например: "+5.23" или "-2.45")
 * 
 * Примеры:
 * formatEnhancedCPT(5.234) → "+5.23"
 * formatEnhancedCPT(-2.456) → "-2.46"
 * formatEnhancedCPT(0) → "+0.00"
 */
function formatEnhancedCPT(value) {
  // Округление до 2 знаков после запятой
  // Источник: old_app_not_write/math-model.js, строка 74
  const v = Math.round(value * 100) / 100;
  
  // Добавление знака "+" для положительных значений
  // Источник: old_app_not_write/math-model.js, строки 75-76
  const sign = v >= 0 ? '+' : '';
  
  // Форматирование с 2 знаками после запятой
  // Источник: old_app_not_write/math-model.js, строка 76
  return sign + v.toFixed(2);
}

  // Экспорт функций через window для использования в других модулях
  // Префикс mmMedian указывает на модель "median"
  try {
    window.mmMedianCPT = {
      computeEnhancedCPT,
      formatEnhancedCPT
    };
    console.log('✅ mmMedianCPT module loaded successfully');
  } catch (error) {
    console.error('❌ mmMedianCPT module failed to load:', error);
  }
})();

