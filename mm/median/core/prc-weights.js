// =========================
// PRC-ВЕСА (Proximity Relevance Coefficients)
// Источник: old_app_not_write/math-model.js (строки 16-19, 35-46)
// =========================
// PRC-веса определяют соразмерность вкладов PV (Price Variations) к горизонту прогноза.
// Физический смысл: чем ближе временной узел к горизонту, тем больше его вес.
// Взаимосвязь: используется во всех расчетах, где нужно учесть близость временных узлов к горизонту.
// В контексте ТА: экспоненциальное затухание весов с расстоянием от горизонта.

// Изолируем область видимости через IIFE для предотвращения конфликтов имен
(function() {
  'use strict';
  
  // Импорт утилит (должен быть загружен до этого файла)
  // Используем clamp из mmMedianHelpers
  const clampFn = window.mmMedianHelpers?.clamp || ((x, min, max) => Math.max(min, Math.min(max, x)));

/**
 * Временные узлы PV в днях (физический смысл: точки измерения траектории)
 * Источник: old_app_not_write/math-model.js, строка 18
 * 
 * ВАЖНО: Обновлены для новых интервалов CoinGecko API
 * Старое приложение: [1/24, 1, 7, 30, 60, 90]
 * Новое приложение: [1/24, 1, 7, 14, 30, 200]
 * 
 * Изменения:
 * - timeFramesDays[3]: было 30d → стало 14d (НОВЫЙ интервал)
 * - timeFramesDays[4]: было 60d → стало 30d (сдвинут с индекса 3)
 * - timeFramesDays[5]: было 90d → стало 200d (НОВЫЙ интервал, заменяет 60d и 90d)
 * 
 * Экспортируем глобально для использования в UI (рендеринг таблиц) и других модулях
 */
const timeFramesDays = [1/24, 1, 7, 14, 30, 200];
window.timeFramesDays = timeFramesDays;

/**
 * computePRCWeights(hDays)
 * Расчет PRC-весов (Proximity Relevance Coefficients) для заданного горизонта прогноза
 * Источник: old_app_not_write/math-model.js, строки 41-46
 * 
 * Физический смысл: соразмерность вкладов PV к горизонту прогноза.
 * Взаимосвязь: чем ближе временной узел к горизонту, тем больше его вес.
 * В контексте ТА: экспоненциальное затухание весов с расстоянием от горизонта.
 * 
 * Алгоритм:
 * 1. Вычисляется параметр tau (временная константа) на основе горизонта: tau = 0.35 * clamp(hDays, 1, 90)
 * 2. Для каждого временного узла вычисляется базовый вес: exp(-|t - hDays| / tau) + 0.05
 *    - Экспоненциальное затухание: чем дальше узел от горизонта, тем меньше вес
 *    - Добавка 0.05: гарантирует минимальный вклад даже далеких узлов
 * 3. Веса нормализуются (сумма = 1.0) для корректного взвешивания
 * 
 * @param {number} hDays - Горизонт прогноза в днях (должен быть в диапазоне [1, 90])
 * @returns {Array<number>} Массив из 6 весов (соответствует 6 временным узлам: 1h, 24h, 7d, 14d, 30d, 200d)
 * 
 * Примеры:
 * computePRCWeights(7) → [w1, w2, w3, w4, w5, w6] где сумма ≈ 1.0
 * При hDays = 7: больший вес у узлов 7d и 1d, меньший у 200d
 * При hDays = 30: больший вес у узла 30d, меньший у 1h и 200d
 */
function computePRCWeights(hDays) {
  // Параметр tau (временная константа) определяет скорость затухания весов
  // Ограничиваем горизонт диапазоном [1, 90] дней для стабильности расчетов
  // Источник: old_app_not_write/math-model.js, строка 42
  const tau = 0.35 * clampFn(hDays, 1, 90);
  
  // Вычисляем базовые веса для каждого временного узла
  // Формула: exp(-|t - hDays| / tau) + 0.05
  // - exp(-|t - hDays| / tau): экспоненциальное затухание с расстоянием от горизонта
  // - + 0.05: минимальный вклад даже далеких узлов (защита от нулевых весов)
  // Источник: old_app_not_write/math-model.js, строка 43
  const base = timeFramesDays.map(t => Math.exp(-Math.abs(t - hDays) / tau) + 0.05);
  
  // Суммируем все веса для нормализации
  // Источник: old_app_not_write/math-model.js, строка 44
  const sum = base.reduce((a, b) => a + b, 0);
  
  // Нормализуем веса (сумма = 1.0) для корректного взвешивания
  // Источник: old_app_not_write/math-model.js, строка 45
  return base.map(w => w / sum);
}

  // Экспорт функций через window для использования в других модулях
  // Префикс mmMedian указывает на модель "median"
  try {
    window.mmMedianPRCWeights = {
      computePRCWeights,
      timeFramesDays // Экспортируем также массив временных узлов для использования в других модулях
    };
    console.log('✅ mmMedianPRCWeights module loaded successfully');
  } catch (error) {
    console.error('❌ mmMedianPRCWeights module failed to load:', error);
  }
})();

