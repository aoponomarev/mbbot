// =========================
// КЛИППИНГ PV1h (Price Variation 1 hour)
// Источник: old_app_not_write/math-model.js (строки 27, 29-30, 329-341)
// =========================
// Клиппинг PV1h используется для сглаживания экстремальных значений изменения цены за 1 час.
// Физический смысл: защита от выбросов в краткосрочных данных.
// Взаимосвязь: используется в расчете CGR (Coin Gradient) для более стабильных результатов.
// В контексте ТА: сглаживает экстремальные значения 1h для более стабильных расчетов.

// Изолируем область видимости через IIFE для предотвращения конфликтов имен
(function() {
  'use strict';
  
  // Импорт утилит (должен быть загружен до этого файла)
  // Используем safeNumber из mmMedianHelpers
  const safeNumberFn = window.mmMedianHelpers?.safeNumber || ((x, def = 0) => {
    const n = Number(x);
    return Number.isFinite(n) ? n : def;
  });

/**
 * Порог чувствительности по |ΔP|, чтобы не ловить шум
 * Источник: old_app_not_write/math-model.js, строка 27
 * 
 * Используется в расчете CGR для фильтрации малых изменений, которые могут быть шумом.
 * Если абсолютное значение изменения цены меньше EPSILON, считается, что изменения нет.
 */
const EPSILON = 0.2;

/**
 * Порог клиппинга для сглаживания 1h (99-й перцентиль по |PV1h|)
 * Источник: old_app_not_write/math-model.js, строка 30
 * 
 * Вычисляется один раз для всей выборки монет перед расчетом CGR.
 * Значение null означает, что порог еще не вычислен.
 * Значение 0 означает, что порог вычислен, но равен 0 (все значения PV1h равны 0).
 */
let pv1hClip = null;

/**
 * computePV1hClipThreshold(coins)
 * Рассчитать порог клиппинга PV1h по текущей выборке (99-й перцентиль абсолютных значений)
 * Источник: old_app_not_write/math-model.js, строки 329-334
 * 
 * Физический смысл: защита от выбросов в краткосрочных данных.
 * Взаимосвязь: используется перед расчетом CGR для определения порога клиппинга.
 * В контексте ТА: сглаживает экстремальные значения 1h для более стабильных расчетов.
 * 
 * Алгоритм:
 * 1. Извлекаем все значения |PV1h| из выборки монет
 * 2. Сортируем массив по возрастанию
 * 3. Находим 99-й перцентиль (индекс = floor(0.99 * (length - 1)))
 * 4. Возвращаем значение на этом индексе
 * 
 * 99-й перцентиль означает, что 99% значений меньше или равны порогу.
 * Это позволяет отсечь 1% самых экстремальных значений как выбросы.
 * 
 * @param {Array<Object>} coins - Массив объектов монет, каждый должен содержать поле pvs[0] (PV1h)
 * @returns {number} Порог клиппинга (99-й перцентиль абсолютных значений PV1h)
 * 
 * Примеры:
 * computePV1hClipThreshold([{pvs: [5, ...]}, {pvs: [10, ...]}, {pvs: [15, ...]}]) → 15 (если это 99-й перцентиль)
 * computePV1hClipThreshold([]) → 0 (пустая выборка)
 */
function computePV1hClipThreshold(coins) {
  // Извлекаем все абсолютные значения PV1h из выборки
  // pvs[0] соответствует PV1h (1 час)
  // Источник: old_app_not_write/math-model.js, строка 330
  const arr = coins.map(c => Math.abs(safeNumberFn(c.pvs?.[0], 0))).sort((a, b) => a - b);
  
  // Если выборка пуста, возвращаем 0
  // Источник: old_app_not_write/math-model.js, строка 331
  if (arr.length === 0) return 0;
  
  // Вычисляем индекс 99-го перцентиля
  // Формула: floor(0.99 * (length - 1))
  // Источник: old_app_not_write/math-model.js, строка 332
  const idx = Math.floor(0.99 * (arr.length - 1));
  
  // Возвращаем значение на этом индексе
  // Источник: old_app_not_write/math-model.js, строка 333
  return arr[idx];
}

/**
 * smoothPV1h(pv1h)
 * Вернуть сглаженное PV1h с клиппингом по порогу
 * Источник: old_app_not_write/math-model.js, строки 336-341
 * 
 * Физический смысл: ограничивает экстремальные значения PV1h порогом клиппинга.
 * Взаимосвязь: используется в расчете CGR для сглаживания краткосрочных данных.
 * В контексте ТА: предотвращает влияние выбросов на расчет градиента.
 * 
 * Алгоритм:
 * 1. Если порог клиппинга не установлен (null) или равен 0, возвращаем исходное значение
 * 2. Иначе ограничиваем абсолютное значение порогом, сохраняя знак
 * 
 * @param {number} pv1h - Исходное значение PV1h (изменение цены за 1 час)
 * @returns {number} Сглаженное значение PV1h (ограниченное порогом клиппинга)
 * 
 * Примеры:
 * smoothPV1h(5) при pv1hClip = 10 → 5 (не превышает порог)
 * smoothPV1h(15) при pv1hClip = 10 → 10 (ограничено порогом)
 * smoothPV1h(-15) при pv1hClip = 10 → -10 (ограничено порогом, знак сохранен)
 * smoothPV1h(5) при pv1hClip = null → 5 (порог не установлен, возвращаем как есть)
 */
function smoothPV1h(pv1h) {
  // Если порог клиппинга не установлен или равен 0, возвращаем исходное значение
  // Источник: old_app_not_write/math-model.js, строка 338
  if (pv1hClip === null || pv1hClip === 0) return pv1h;
  
  // Сохраняем знак исходного значения
  // Источник: old_app_not_write/math-model.js, строка 339
  const sign = pv1h >= 0 ? 1 : -1;
  
  // Ограничиваем абсолютное значение порогом клиппинга, сохраняя знак
  // Источник: old_app_not_write/math-model.js, строка 340
  return Math.min(Math.abs(pv1h), pv1hClip) * sign;
}

/**
 * setPV1hClip(threshold)
 * Установить порог клиппинга PV1h
 * Используется для установки порога после его вычисления
 * 
 * @param {number} threshold - Порог клиппинга (99-й перцентиль)
 */
function setPV1hClip(threshold) {
  pv1hClip = threshold;
}

/**
 * getPV1hClip()
 * Получить текущий порог клиппинга PV1h
 * 
 * @returns {number|null} Текущий порог клиппинга или null, если не установлен
 */
function getPV1hClip() {
  return pv1hClip;
}

  // Экспорт функций через window для использования в других модулях
  // Префикс mmMedian указывает на модель "median"
  try {
    window.mmMedianPV1hClip = {
      computePV1hClipThreshold,
      smoothPV1h,
      setPV1hClip,
      getPV1hClip,
      EPSILON // Экспортируем также константу EPSILON для использования в других модулях
    };
    console.log('✅ mmMedianPV1hClip module loaded successfully');
  } catch (error) {
    console.error('❌ mmMedianPV1hClip module failed to load:', error);
  }
})();

