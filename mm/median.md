# Математическая модель: Median-based Analysis

Документация математической модели для анализа криптовалютных монет на основе медианных значений и накопительных дельт.

> **Статус**: В процессе миграции из старого приложения. Документ заполняется по мере миграции компонентов модели.

---

## Переменные

### Входные данные

#### PV (Price Variations) - Вариации цены
- **Описание**: Массив из 6 значений изменения цены за фиксированные временные интервалы
- **Формат**: `[PV1h, PV24h, PV7d, PV14d, PV30d, PV200d]`
- **Единицы**: Проценты (%)
- **Источник**: CoinGecko API (`price_change_percentage_*_in_currency`)
- **Использование**: 
  - Базовые данные для расчета всех производных метрик
  - См. [CPT (Coin Potential)](#cpt-coin-potential)
  - См. [CD (Cumulative Delta)](#cd-cumulative-delta)

#### hDays (Horizon Days) - Горизонт прогноза
- **Описание**: Пользовательский параметр, определяющий временной горизонт для прогнозирования
- **Диапазон**: 1-90 дней
- **По умолчанию**: 2 дня
- **Использование**:
  - Расчет PRC-весов (см. [PRC Weights](#prc-weights-proximity-relevance-coefficients))
  - Интерполяция CDH (см. [CDH (Cumulative Delta on Horizon)](#cdh-cumulative-delta-on-horizon))

### Промежуточные значения

#### PRC Weights (Proximity Relevance Coefficients) - Коэффициенты близости и релевантности
- **Описание**: Массив из 6 весов, определяющих важность каждого временного интервала для заданного горизонта прогноза
- **Формат**: `[w1, w2, w3, w4, w5, w6]` (сумма = 1.0)
- **Зависимость**: Зависит от `hDays` - чем ближе временной интервал к горизонту, тем больше вес
- **Формула**: См. [PRC Weights](#prc-weights-proximity-relevance-coefficients)
- **Использование**:
  - Взвешивание PV для расчета CPT
  - Взвешивание PV для расчета взвешенных CD
  - См. [CPT (Coin Potential)](#cpt-coin-potential)
  - См. [CD (Cumulative Delta)](#cd-cumulative-delta)

### Выходные метрики

#### CPT (Coin Potential) - Потенциал монеты
- **Описание**: Взвешенная сумма PV, отражающая потенциал монеты
- **Единицы**: Проценты (%)
- **Формула**: См. [CPT (Coin Potential)](#cpt-coin-potential)
- **Использование**: 
  - Компонент метрики AGR (Impulse)
  - См. [AGR (Aggregated Score)](#agr-aggregated-score)

#### CD (Cumulative Delta) - Накопительная дельта
- **Описание**: Накопительная сумма PV за фиксированные временные интервалы
- **Типы**:
  - **Сырые CD** (`cd1`..`cd6`): Простая накопительная сумма PV
  - **Взвешенные CD** (`cd1w`..`cd6w`): Накопительная сумма PV, умноженных на PRC-веса
- **Единицы**: Проценты (%)
- **Формула**: См. [CD (Cumulative Delta)](#cd-cumulative-delta)
- **Использование**:
  - Базовые значения для интерполяции CDH
  - См. [CDH (Cumulative Delta on Horizon)](#cdh-cumulative-delta-on-horizon)

#### CDH (Cumulative Delta on Horizon) - CD на горизонте прогноза
- **Описание**: Интерполированное значение CD для заданного горизонта прогноза
- **Типы**:
  - **Сырое CDH** (`cdh`): Интерполяция между сырыми CD значениями
  - **Взвешенное CDH** (`cdhw`): Интерполяция между взвешенными CD значениями
- **Единицы**: Проценты (%)
- **Формула**: См. [CDH (Cumulative Delta on Horizon)](#cdh-cumulative-delta-on-horizon)
- **Использование**:
  - Компонент метрики AGR (Alignment)
  - См. [AGR (Aggregated Score)](#agr-aggregated-score)

---

## Вычислительный трек

### 1. PRC Weights (Proximity Relevance Coefficients)

**Назначение**: Вычисление весов для временных интервалов на основе близости к горизонту прогноза.

**Входные данные**:
- `hDays` - горизонт прогноза в днях (1-90)
- `timeFramesDays` - массив временных узлов: `[1/24, 1, 7, 14, 30, 200]` дней

**Алгоритм**:
1. Для каждого временного узла `t[i]` вычисляется расстояние до горизонта: `distance[i] = |hDays - t[i]|`
2. Вычисляется обратное расстояние с нормализацией: `weight[i] = 1 / (1 + distance[i])`
3. Веса нормализуются так, чтобы их сумма равнялась 1.0

**Формула**:
```
weight[i] = (1 / (1 + |hDays - t[i]|)) / Σ(1 / (1 + |hDays - t[j]|))
```

**Реализация**: `mm/median/core/prc-weights.js` → `computePRCWeights(hDays)`

**Выходные данные**: Массив из 6 весов `[w1, w2, w3, w4, w5, w6]`, где `Σw[i] = 1.0`

---

### 2. CPT (Coin Potential)

**Назначение**: Вычисление потенциала монеты как взвешенной суммы вариаций цены.

**Входные данные**:
- `pvs` - массив из 6 значений PV: `[PV1h, PV24h, PV7d, PV14d, PV30d, PV200d]`
- `prcWeights` - массив из 6 PRC-весов (см. [PRC Weights](#1-prc-weights-proximity-relevance-coefficients))

**Алгоритм**:
1. Каждое значение PV умножается на соответствующий PRC-вес
2. Результаты суммируются

**Формула**:
```
CPT = Σ(PV[i] × w[i]) для i = 0..5
```

где:
- `PV[i]` - вариация цены для временного узла `i`
- `w[i]` - PRC-вес для временного узла `i`

**Реализация**: `mm/median/metrics/cpt.js` → `computeEnhancedCPT(pvs, hDays)`

**Выходные данные**: 
- `enhancedCpt` - числовое значение CPT
- `enhancedCptFormatted` - отформатированное значение CPT (строка)

---

### 3. CD (Cumulative Delta)

**Назначение**: Вычисление накопительной дельты как интегральной силы движения цены.

**Входные данные**:
- `pvs` - массив из 6 значений PV: `[PV1h, PV24h, PV7d, PV14d, PV30d, PV200d]`
- `prcWeights` - массив из 6 PRC-весов (см. [PRC Weights](#1-prc-weights-proximity-relevance-coefficients))

**Алгоритм**:
1. **Сырые CD**: Для каждого временного узла вычисляется накопительная сумма PV
2. **Взвешенные CD**: Для каждого временного узла вычисляется накопительная сумма PV, умноженных на PRC-веса

**Формула (сырые CD)**:
```
cdRaw[0] = PV[0]
cdRaw[i] = cdRaw[i-1] + PV[i] для i = 1..5
```

**Формула (взвешенные CD)**:
```
cdW[0] = PV[0] × w[0]
cdW[i] = cdW[i-1] + PV[i] × w[i] для i = 1..5
```

**Реализация**: `mm/median/metrics/cd.js` → `calculateCDsWeighted(pvs, prcWeights)`

**Выходные данные**:
- `cd1`..`cd6` - сырые CD значения для временных узлов [1h, 24h, 7d, 14d, 30d, 200d]
- `cd1w`..`cd6w` - взвешенные CD значения для временных узлов [1h, 24h, 7d, 14d, 30d, 200d]

**Важно**: 
- **Сырые CD** (cd1..cd6) зависят только от фиксированных временных интервалов и **не должны пересчитываться** при изменении горизонта прогноза
- **Взвешенные CD** (cd1w..cd6w) зависят от PRC-весов, которые зависят от hDays, поэтому **должны пересчитываться** при изменении горизонта прогноза
- Пересчитывается также CDH (см. [CDH (Cumulative Delta on Horizon)](#4-cdh-cumulative-delta-on-horizon))

---

### 4. CDH (Cumulative Delta on Horizon)

**Назначение**: Интерполяция CD для заданного горизонта прогноза.

**Входные данные**:
- `series` - массив CD значений (сырые `cdRaw` или взвешенные `cdW`)
- `hDays` - горизонт прогноза в днях (1-90)
- `timeFramesDays` - массив временных узлов: `[1/24, 1, 7, 14, 30, 200]` дней

**Алгоритм**:
1. Находятся два соседних временных узла `t[i]` и `t[i+1]`, между которыми находится `hDays`
2. Извлекаются соответствующие CD значения `cd[i]` и `cd[i+1]`
3. Выполняется линейная интерполяция между `cd[i]` и `cd[i+1]` на основе положения `hDays` между `t[i]` и `t[i+1]`

**Формула**:
```
Если hDays == t[i]: CDH = cd[i]
Если hDays < t[0]: CDH = cd[0]
Если hDays > t[5]: CDH = cd[5]
Иначе:
  ratio = (hDays - t[i]) / (t[i+1] - t[i])
  CDH = cd[i] + ratio × (cd[i+1] - cd[i])
```

**Реализация**: `mm/median/metrics/cd.js` → `approximateCDHFromSeries(series, hDays)`

**Выходные данные**:
- `cdh` - сырое CDH значение (интерполяция между сырыми CD)
- `cdhw` - взвешенное CDH значение (интерполяция между взвешенными CD)

**Важно**: 
- **Сырое CDH** (cdh) **НЕ пересчитывается** при изменении горизонта прогноза - оно зависит только от сырых CD, которые не меняются
- **Взвешенное CDH** (cdhw) **пересчитывается** при изменении горизонта прогноза - оно зависит от взвешенных CD, которые пересчитываются с новыми PRC-весами
- Сырые CD1-CD6 остаются неизменными (см. [CD (Cumulative Delta)](#3-cd-cumulative-delta))

---

## Глоссарий

### Термины

**PV (Price Variation)** - Вариация цены. Изменение цены актива за фиксированный временной интервал, выраженное в процентах.

**CD (Cumulative Delta)** - Накопительная дельта. Интегральная сила движения цены, вычисляемая как накопительная сумма PV за фиксированные временные интервалы.

**CDH (Cumulative Delta on Horizon)** - CD на горизонте прогноза. Интерполированное значение CD для заданного пользователем горизонта прогноза.

**CPT (Coin Potential)** - Потенциал монеты. Взвешенная сумма PV, отражающая потенциал монеты с учетом важности временных интервалов.

**PRC (Proximity Relevance Coefficient)** - Коэффициент близости и релевантности. Вес, определяющий важность временного интервала для заданного горизонта прогноза.

**hDays (Horizon Days)** - Горизонт прогноза. Пользовательский параметр (1-90 дней), определяющий временной горизонт для прогнозирования.

**Сырые значения** - Значения, вычисленные без учета весов (например, сырые CD - простая накопительная сумма PV).

**Взвешенные значения** - Значения, вычисленные с учетом PRC-весов (например, взвешенные CD - накопительная сумма PV, умноженных на веса).

**Временные узлы** - Фиксированные временные интервалы для расчета метрик: 1 час, 24 часа, 7 дней, 14 дней, 30 дней, 200 дней.

**Интерполяция** - Метод вычисления промежуточных значений между известными точками данных. В контексте CDH используется линейная интерполяция между соседними CD значениями.

### Сокращения

- **PV** - Price Variation (Вариация цены)
- **CD** - Cumulative Delta (Накопительная дельта)
- **CDH** - Cumulative Delta on Horizon (CD на горизонте)
- **CPT** - Coin Potential (Потенциал монеты)
- **PRC** - Proximity Relevance Coefficient (Коэффициент близости и релевантности)
- **hDays** - Horizon Days (Горизонт прогноза в днях)

---

## Особенности реализации

### Отображение CD в таблице

**Осознанное расхождение со старым функционалом**: В новом приложении в таблице отображаются **взвешенные CD** (`cd1w`..`cd6w`, `cdhw`), а сырые значения (`cd1`..`cd6`, `cdh`) доступны в tooltip при наведении.

**Обоснование**:
- Взвешенные значения используются в расчете AGR (более важны для анализа)
- Учитывают важность временных интервалов через PRC-веса
- Согласованы с отображением в портфолио

**В старом проекте**: В основной таблице показывались сырые CD1-CD6 и взвешенное CDH.

---

*Документ обновляется по мере миграции компонентов математической модели.*

