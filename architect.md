# Архитектурный план (BOT)

Цели: запуск без бэкенда (CDN Vue + локальные файлы), работа из папки/`file://`, данные получаем из публичных API (CoinGecko и др.), всё состояние и история — локально (localStorage/IndexedDB).

Слои
- core/: конфиг, fetch-обёртка (таймауты/ретраи), абстракция хранения (localStorage/IndexedDB), общие расчётные хелперы, схемы валидации входящих данных.
  - core/security/: утилиты обфускации, валидация ключей, безопасное хранение чувствительных данных (PIN-коды, API-ключи).
- domain/:
  - entities/: asset, metric, index, strategy, portfolio, history (таймсерии), correlation.
  - services/: calculator (метрики/индексы), portfolio-builder (weights/стратегии), backtest, correlation.
- features/ (feature-first):
  - markets: загрузка и отображение рынка (цены, проценты, объёмы).
  - metrics: расчёт/просмотр метрик по периодам.
  - indices: конструирование пользовательских индексов/скорингов.
  - portfolios: конструктор портфелей под стратегии, предпросмотр метрик.
  - strategies: пресеты правил (ребаланс, лимиты веса, фильтры).
  - correlations: матрицы корреляций для активов/портфелей.
  - history: загрузка/кэш/просмотр временных рядов.
  - import-export: JSON экспорт/импорт настроек, стратегий, портфелей.
  - settings: тема, API-ключи, периодичность обновлений.
- ui/: переиспользуемые компоненты (таблицы, карточки, формы, графики), layout, тема/токены (через Bootstrap-утилиты).
  - ui/api/: компоненты для работы с внешними API (Perplexity, CoinGecko, импорт/экспорт).
  - ui/interaction/: компоненты взаимодействия с пользователем (сплэш, тема, чат).
- tests/: unit (расчёты), integration (сценарии сборки портфелей, импорт/экспорт).

Текущее размещение файлов
- **core/cfg-app.js** — конфиг приложения (defaults, модели).
- **core/security/u-sec-obfuscate.js** — утилиты обфускации для безопасного хранения PIN и API-ключей.
- **ui/api/import-export.js** — экспорт/импорт настроек.
- **ui/api/perplexity.js** — настройка ключа/модели Perplexity.
- **ui/api/coingecko.js** — виджет CoinGecko.
- **ui/api/market-metrics.js** — утилита для получения метрик рынка (FGI, VIX, BTC Dominance, Open Interest, Funding Rate, Long/Short Ratio).
- **ui/interaction/splash.js** — сплэш-экран с защитой PIN-кодом и настройкой API-ключа.
- **ui/interaction/theme.js** — применение темы.
- **ui/interaction/chat.js** — чат Perplexity.
- **app/app-ui-root.js** — сборка и монтирование Vue-приложения.
- **index.html** — корневой HTML, подключает скрипты через CDN + локальные.

Структура папок по специализации
- Папки специализации (`<сектор>/<специализация>/`) создаются по мере накопления файлов родственного назначения.
- Примеры: `ui/api/` (компоненты для работы с API), `ui/interaction/` (компоненты взаимодействия), `mm/` (математическая модель).
- Имена файлов без префиксов — специализация понятна из пути папки.

Ключевые сущности
- Asset: {id, symbol, name}.
- Metric: {assetId, period, kind, value}; источник — data-sources → calculator.
- Index: агрегированные скоры/метрики из набора Metric + формула.
- Strategy: правила (лимиты веса, фильтры волатильности/ликвидности, ребаланс).
- Portfolio: {strategyId, weights{assetId: number}, derivedMetrics, rebalance rules}.
- History: таймсерии цен/метрик/портфелей для backtest/корреляций.
- Correlation: матрицы между Asset/Portfolio на базе History.

Поток данных
Fetch (ui/api) → Validate/Normalize (schemas) → Compute (calculator/indices) → Build (portfolio-builder/strategy) → Persist (storage/IndexedDB) → Render (ui/api, ui/interaction).

Хранение и оффлайн
- Настройки и ключи: localStorage.
- История цен/метрик/портфелей: IndexedDB (chunked загрузка, при необходимости delta/RLE).
- Экспорт/импорт: JSON для настроек, стратегий, портфелей, исторических срезов.

Библиотеки (при необходимости через CDN)
- Vue (уже есть), Chart.js или Lightweight Charts для графиков, zod (или легковесная своя валидация) для схем, idb-keyval для удобной работы с IndexedDB.

Стандарты разработки
- **Кодировка файлов**: UTF-8
- **Окончания строк**: CRLF (Windows), но Git настроен на автоматическое преобразование
- **HTML**: Минимальная валидная HTML5 разметка, язык по умолчанию `ru`, кодировка UTF-8, viewport meta для адаптивности
- **Стилизация**: Использовать только Bootstrap классы для стилей, избегать секций `<style>` в HTML файлах. Все стили управляются через Bootstrap утилиты и классы

Технические ограничения
- **⚠️ Порядок загрузки x-template шаблонов**: При использовании `<script type="text/x-template">` для Vue компонентов - шаблон **ОБЯЗАТЕЛЬНО** должен быть в DOM **ДО** загрузки Vue.js и компонентов, которые его используют. Правильный порядок в `index.html`: 1) Bootstrap JS, 2) x-template шаблоны, 3) Vue.js, 4) компоненты, 5) app-ui-root.js. Нарушение порядка приводит к тому, что Vue не находит шаблон при монтировании компонента, и компонент не отображается.
- **Размещение компонентов**: Vue-монтирует только то, что находится в пределах `#app`, поэтому сплэш-экраны, модалки, новые UI-блоки и контейнеры должны рендериться внутри `<div id="app">`.
- **Внешние запросы**: Не запускать внешние HTTP-запросы (CoinGecko, CDN и т.п.) или иные операции вне `#app`, пока сплэш экран не разблокирован.

Принципы разработки

### UI (интерфейс)
*Принципы и правила интерфейса приложения: оформление, взаимодействие (UX), анимации, accessibility*

- *(Принципы добавляются по командам UI: или UX: от пользователя)*

### MM (математическая модель)
*Принципы математической модели, расчетов и обработки данных*

- *(Принципы добавляются по командам MM: или ММ: от пользователя)*

**Примечание**: UX (User Experience) является неотъемлемой частью UI - веб-компоненты содержат и визуальное оформление, и логику взаимодействия одновременно. Поэтому команды `UI:` и `UX:` обе обновляют раздел "UI (интерфейс)".

Обратная совместимость данных

**ОБЯЗАТЕЛЬНО**: При изменении структуры сохраненных данных (localStorage, IndexedDB, JSON-файлы экспорта) - **ВСЕГДА** предлагать пользователю реализацию обратной совместимости.

**Когда применять:**
- Переименование полей в JSON
- Изменение формата хранения (например: строка → объект)
- Миграция структуры localStorage/IndexedDB
- Обновление схемы экспорта/импорта
- Изменение версий API или форматов данных

**Что делать:**
1. **Предложить пользователю** добавить обратную совместимость
2. **Объяснить**, в чем будет состоять совместимость:
   - Какие старые форматы будут поддерживаться
   - Как будет происходить миграция данных
   - Какие риски при отсутствии совместимости (потеря данных, ошибки импорта и т.д.)
3. **Показать пример кода** для поддержки старого и нового формата
4. **Дать выбор пользователю**: делать совместимость сейчас или отложить

**Пример:**
```javascript
// Пользователь: "переименуй apiKey в apiKeyPerplexity"
// ИИ-агент должен предложить:

// Вариант 1: Без обратной совместимости (быстро, но может сломать существующие данные)
if (settings.secureData.apiKeyPerplexity) { ... }

// Вариант 2: С обратной совместимостью (медленнее, но безопасно)
if (settings.secureData.apiKeyPerplexity) {
  // Новый формат
} else if (settings.secureData.apiKey) {
  // Старый формат (для совместимости)
  // Автоматически мигрируем в новый
}
```

**Частые случаи:**
- **Экспорт/импорт настроек** - чаще всего требует совместимости
- **localStorage ключи** - при переименовании учитывать существующие данные
- **JSON-схемы** - версионировать (_version) и поддерживать старые версии
- **Миграция БД** - всегда с проверкой наличия данных в старом формате

**Исключения** (когда совместимость НЕ нужна):
- Проект на ранней стадии разработки (до первого релиза)
- Пользователь явно сказал "не надо обратной совместимости"
- Изменения не влияют на сохраненные данные (только UI/логика)

Структура проекта
```
BOT/
├── index.html          # Главный HTML файл
├── .git/              # Git репозиторий
├── .vscode/           # Настройки VS Code (для совместимости с Cursor)
│   ├── settings.json  # Настройки проекта (синхронизируются с Cursor)
│   ├── extensions.json # Рекомендуемые расширения
│   ├── cspell-dict.txt # Пользовательский словарь для проверки орфографии
│   └── README.md      # Документация по настройкам
├── history/           # Логи чата
│   └── YYYY/          # Папки по годам
│       └── MM-DD.txt  # Дневные логи (например: 12-09.txt)
├── core/              # Ядро приложения
│   ├── cfg-app.js     # Конфиг приложения
│   └── security/      # Безопасность
│       └── u-sec-obfuscate.js
├── ui/                # UI компоненты
│   ├── api/           # Компоненты для работы с API
│   │   ├── import-export.js
│   │   ├── perplexity.js
│   │   └── coingecko.js
│   └── interaction/   # Компоненты взаимодействия
│       ├── splash.js
│       ├── theme.js
│       └── chat.js
├── app/               # Точка входа приложения
│   └── app-ui-root.js
├── architect.md       # Архитектурный план (этот файл)
└── .cursorrules       # Правила работы ИИ-агента


```
