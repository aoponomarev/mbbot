# Дневной лог разработки - 14 декабря 2025

## UI (оформление)

### Коммит: Fix window.uiElementHelper access in Vue templates and restore icons catalog
- **Что сделано**: Исправлена проблема с доступом к `window.uiElementHelper` в шаблонах Vue, восстановлен каталог иконок и документация из коммита b04fb21
- **Как сделано**:
  * **Восстановление изменений из коммита b04fb21**:
    - Восстановлен файл `ui/assets/icons-review.html` - интерактивный каталог всех иконок проекта
    - Восстановлен файл `ui/assets/icons/icon-cross.svg` - SVG иконка крестика
    - Восстановлены обновления в `ui/config/ui-element-mapping.json` с командами для иконки крестика
    - Восстановлены обновления в `ui/styles/icons.css` со стилями для SVG иконки крестика
    - Восстановлены обновления в `ui/utils/ui-element-helper.js` с функциями для работы с SVG иконками
    - Восстановлены обновления документации в `architect.md` и `ui/guide-ii.md` про каталог иконок
  * **Исправление проблемы window.uiElementHelper**:
    - Добавлены computed свойства в `ui/components/button.js`:
      - `uiElementHelper()` - безопасный доступ к `window.uiElementHelper`
      - `isSVGIcon()` - проверка, является ли иконка SVG
      - `svgIconPath()` - путь к SVG иконке
    - Добавлены computed свойства в `ui/components/menu-item.js`:
      - `uiElementHelper()` - безопасный доступ к `window.uiElementHelper`
      - `isSVGIcon()` - проверка, является ли иконка SVG
      - `svgIconPath()` - путь к SVG иконке
    - Обновлены шаблоны в `index.html`:
      - В шаблоне `button-template` заменены прямые обращения `window.uiElementHelper.isSVGIcon()` и `window.uiElementHelper.getSVGIconPath()` на computed свойства `isSVGIcon` и `svgIconPath`
      - В шаблоне `menu-item-template` заменены прямые обращения `window.uiElementHelper.isSVGIcon()` и `window.uiElementHelper.getSVGIconPath()` на computed свойства `isSVGIcon` и `svgIconPath`
- **Функциональность**: Кнопки и выпадающие списки теперь работают корректно, так как доступ к `window.uiElementHelper` в шаблонах Vue осуществляется через computed свойства, которые безопасно обрабатывают случаи, когда `window` недоступен. Каталог иконок восстановлен и доступен для просмотра всех иконок проекта.

## UX (паттерны взаимодействий)

### Коммит: Fix header checkbox deselection and optimize header-coins component
- **Что сделано**: Исправлена проблема с снятием выбора всех элементов через верхний чекбокс в заголовке таблицы, оптимизирован компонент `header-coins` для улучшения производительности и читаемости кода
- **Как сделано**:
  * **Исправление проблемы с чекбоксом**:
    - Добавлена защита от неправильных аргументов в методе `handleToggleAll()` в `ui/components/table-data.js`
    - Если первый параметр `checked` является объектом события (а не boolean), аргументы нормализуются: `event` становится `checked`, а `checked` извлекается из `event.target.checked`
    - Это предотвращает повторный выбор всех монет при двойном вызове обработчика с неправильными аргументами
  * **Оптимизация компонента header-coins**:
    - Методы `getRemainingTickersCount()` и `getRemainingTickersDisplay()` перенесены в computed свойства `remainingTickersCount` и `remainingTickersDisplay` для улучшения производительности
    - Обновлен шаблон в `index.html`: вызовы методов заменены на computed свойства
    - Создан вспомогательный метод `_getFavoriteCoinData()` для устранения дублирования логики проверки типа в методах `getFavoriteCoinId()`, `getFavoriteCoinName()`, `getFavoriteCoinSymbol()`
    - Убраны неиспользуемые параметры из методов `handleToggleFavoritesDropdown()` и `handleFetchCoins()`
    - Магическое число `100` вынесено в константу `TOGGLE_FAVORITES_DELAY` с комментарием
    - Исправлено несоответствие в `emits`: добавлено событие `'remove-favorite-from-favorites'`, удалено неиспользуемое `'remove-selected-coins'`
- **Функциональность**: Верхний чекбокс в заголовке таблицы теперь корректно снимает выбор со всех элементов без повторного автоматического выбора. Компонент `header-coins` оптимизирован для лучшей производительности и поддерживаемости кода.

### Коммит: Fix dropdown menu opening issue and remove debug logging
- **Что сделано**: Исправлена проблема с открытием выпадающего меню кнопки "Избранное" и удалено отладочное логирование
- **Как сделано**:
  * **Исправление проблемы с открытием меню**:
    - Добавлен флаг `isTogglingFavorites` в `ui/components/header-coins.js` для предотвращения двойной обработки события `toggle-favorites-dropdown`
    - Убран модификатор `@click.stop` из шаблона `cmp-button` в `index.html`, так как `stopPropagation()` теперь вызывается явно в обработчике
    - Добавлен явный вызов `event.stopPropagation()` в методе `handleToggleFavoritesDropdown` для предотвращения всплытия события
    - Добавлена задержка 100ms перед сбросом флага `isTogglingFavorites` для предотвращения повторной обработки события
  * **Исправление проблемы с сохранением состояния чекбоксов**:
    - Модифицирован метод `fetchCoinGecko()` в `ui/api/coingecko.js` (теперь `ui/api/coins-manager.js`) для фильтрации `selectedCoinIds` на основе вновь загруженных монет вместо полной очистки массива
    - Это сохраняет состояние выбранных чекбоксов для монет, которые остаются в списке после обновления
  * **Исправление проблемы с event.stopPropagation**:
    - Модифицирован метод `handleClick()` в `ui/components/button.js` для передачи нативного объекта события как первого аргумента в `$emit('click')`
    - Добавлен явный вызов `event.stopPropagation()` в `handleClick()` для предотвращения всплытия события
  * **Удаление отладочного логирования**:
    - Удалены все блоки `#region agent log` из `ui/components/button.js`
    - Удалены все блоки `#region agent log` из `ui/components/header-coins.js`
    - Удалены все блоки `#region agent log` из `ui/api/coingecko.js` (теперь `ui/api/coins-manager.js`)
    - Удалены все блоки `#region agent log` из `ui/components/dropdown-menu.js`
- **Функциональность**: Выпадающее меню кнопки "Избранное" теперь открывается и закрывается корректно без двойной обработки событий. Состояние чекбоксов сохраняется при обновлении данных. Код очищен от отладочного логирования.

## MM (математическая модель)

## Architect (архитектура, настройки)

### Коммит: Add math models docs to main docs, fix path, and align documentation with codebase
- **Что сделано**: Добавлена документация математических моделей в основные документы проекта, исправлен путь к документации, проведена полная ревизия документации и приведение в соответствие с фактическим состоянием кодовой базы
- **Как сделано**:
  * **Добавление документации математических моделей в основные документы**:
    - Обновлен раздел "Список документов для сопровождения" в `.cursorrules`: добавлен пункт "Документация математических моделей" (`mm/<название_модели>.md`)
    - Указано, что все файлы документации математических моделей из папки `mm/` автоматически относятся к основным документам проекта и требуют сопровождения
    - Указано, что при создании новой математической модели её документация должна быть добавлена в список основных документов
    - Обновлены все упоминания ключевых документов в `.cursorrules` для включения документации математических моделей
  * **Исправление пути к документации**:
    - Исправлен путь в `.cursorrules` с `mm/<название_модели>/<название_модели>.md` на `mm/<название_модели>.md` для соответствия фактической структуре файлов
  * **Ревизия документации и приведение в соответствие с кодовой базой**:
    - Добавлено описание `core/api/coingecko.js` в раздел "Текущее размещение файлов" в `architect.md`
    - Добавлены описания новых утилит: `ui/utils/coins-cd-helpers.js`, `ui/utils/coins-favorites-helpers.js`
    - Добавлено описание `ui/config/table-columns-config.js`
    - Добавлено описание `ui/components/horizon-input.js`
    - Добавлены описания новых файлов математической модели: `mm/median/metrics/cd.js`, `mm/median.md`
    - Обновлена структура проекта в `architect.md`: добавлена папка `mm/` с полной структурой математической модели, добавлены все новые файлы в соответствующие разделы структуры
- **Функциональность**: Документация математических моделей теперь официально входит в основные документы проекта наравне с `.cursorrules`, `architect.md` и `ui/guide-ii.md`. Все новые файлы, созданные в процессе разработки, задокументированы и включены в структуру проекта. Документация полностью соответствует фактическому состоянию кодовой базы.

### Коммит: Extract Perplexity API utility and document core/api vs ui/api separation
- **Что сделано**: Вынесена функция запроса к Perplexity API в отдельную утилиту `core/api/perplexity.js`, обновлен компонент чата для использования утилиты, задокументировано правило разделения ответственности между `core/api/` и `ui/api/`
- **Как сделано**:
  * **Создание утилиты Perplexity API**:
    - Создан файл `core/api/perplexity.js` с функцией `sendPerplexityRequest()` для отправки запросов к Perplexity Chat Completions API
    - Функция поддерживает обработку ошибок, rate limiting (429), адаптивный таймаут (опционально)
    - Экспорт через `window.perplexityAPI` для использования в других модулях
    - Утилита независима от Vue компонентов, может использоваться в любом контексте
  * **Обновление компонента чата**:
    - Обновлен `ui/interaction/chat.js`: метод `askPerplexity()` теперь использует утилиту `window.perplexityAPI.sendPerplexityRequest()` вместо прямых `fetch` запросов
    - Добавлена проверка доступности модуля `perplexityAPI` перед использованием
    - Убрана прямая логика `fetch` запросов к Perplexity API
  * **Подключение утилиты**:
    - Добавлен скрипт `core/api/perplexity.js` в `index.html` в секции "API утилиты" перед компонентами
  * **Документирование правила разделения ответственности**:
    - Добавлено правило в `architect.md` (раздел "Стандарты разработки"):
      - Подробное описание различий между `core/api/` (утилиты, не Vue) и `ui/api/` (Vue компоненты)
      - Характеристики каждого типа файлов с примерами
      - Правило контроля для ИИ-агента с 4 пунктами проверки при создании нового функционала
    - Добавлена ссылка в `.cursorrules`:
      - Новый раздел "КРИТИЧЕСКИ ВАЖНО - Разделение ответственности между `core/api/` и `ui/api/`"
      - Краткое правило для быстрого контроля
      - Ссылка на подробное описание в `architect.md`
      - 4 пункта для проверки при создании нового функционала для работы с API
  * **Обновление документации**:
    - Обновлен раздел "Текущее размещение файлов" в `architect.md`: добавлено описание `core/api/perplexity.js`
    - Обновлено описание `ui/interaction/chat.js` с указанием использования утилиты из `core/api/perplexity.js`
    - Обновлена структура проекта в `architect.md`: добавлена папка `core/api/` с файлами
- **Функциональность**: Функция запроса к Perplexity API вынесена в отдельную утилиту, что обеспечивает единообразие с другими API утилитами (`core/api/coingecko.js`, `core/api/market-metrics.js`), улучшает переиспользование и тестируемость, правильно разделяет ответственность между утилитами и компонентами. Компонент чата теперь использует утилиту из `core/api/`, а не делает запросы напрямую. Правило разделения ответственности между `core/api/` и `ui/api/` задокументировано и будет контролироваться ИИ-агентом в процессе разработки для обеспечения правильной организации кода.

### Коммит: Refactor documentation structure and add mandatory documentation reading principle
- **Что сделано**: Разгружен `.cursorrules` от деталей в пользу `architect.md` и `ui/guide-ii.md`, добавлен принцип обязательного чтения документации перед выполнением заданий
- **Как сделано**:
  * **Разгрузка `.cursorrules`**:
    - Убраны детали работы с HTML файлами (стилизация, вынесение стилей, маркировка контейнеров, детерминированные хэши, стандартные размеры чекбоксов, система иконок) - оставлены только ссылки на `architect.md` и `ui/guide-ii.md`
    - Убраны детали проверки зависимостей - оставлена ссылка на `architect.md`
    - Убраны детали протоколирования - оставлена ссылка на `architect.md`
    - Убраны детали синхронизации настроек - оставлена ссылка на `architect.md`
    - Удалены разделы "Заметки для будущих сессий" и "Рекомендации для улучшения"
    - Оставлены только принципиальные правила работы ИИ-агента
  * **Добавление деталей в `architect.md`**:
    - Добавлен раздел "Проверка актуальности зависимостей" с регламентом ежедневной проверки версий Vue.js и Bootstrap
    - Добавлен раздел "Протоколирование дневного чата" с форматом записи, структурой секций и примером
    - Добавлен раздел "Синхронизация настроек Cursor → VS Code" с механизмом отслеживания изменений и списком синхронизируемых настроек
    - Обновлен раздел "Отслеживание согласованности архитектурных правил" для отражения нового распределения ответственности
  * **Добавление принципа обязательного чтения документации**:
    - Обновлен раздел "Контроль качества выполнения" в `.cursorrules`:
      - Добавлен блок "⚠️ ПЕРЕД ВЫПОЛНЕНИЕМ ЛЮБОГО ЗАДАНИЯ ПОЛЬЗОВАТЕЛЯ" с требованиями:
        * Прочитать соответствующую документацию проекта перед началом выполнения
        * Применить рекомендации и предписания из документации
        * Учесть существующие решения, паттерны и компоненты
      - Уточнена цель: ИИ-агент должен читать и применять документацию проекта перед выполнением заданий
    - Добавлена запись в "Текущие предпочтения пользователя" с правилом "Чтение документации перед выполнением заданий"
    - Добавлена запись в "Историю изменений предпочтений" с датой 2025-12-14
- **Функциональность**: `.cursorrules` теперь содержит только принципиальные правила работы ИИ-агента, детали перенесены в соответствующие документы (`architect.md` для архитектурных принципов и процессов, `ui/guide-ii.md` для UI/UX деталей). ИИ-агент теперь ОБЯЗАН читать соответствующую документацию проекта перед выполнением любого задания пользователя, что обеспечивает высокое качество выполнения задач и соответствие установленным правилам и принципам проекта.

### Коммит: Move review files to ui/, remove unused color variable, and update documentation
- **Что сделано**: Перемещены review-файлы из `docs/` в `ui/`, удалена неиспользуемая переменная `--color-primary-muted`, обновлена документация и исправлены несоответствия
- **Как сделано**:
  * **Перемещение review-файлов**:
    - Перемещен `docs/review-manager.js` → `ui/review-manager.js`
    - Перемещен `docs/review-styles.css` → `ui/review-styles.css`
    - Обновлены пути в `ui/assets/icons-review.html` и `ui/styles/colors-review.html` на `../review-manager.js` и `../review-styles.css`
    - Обновлена логика определения путей в `ui/review-manager.js` для корректной навигации между review-файлами
    - Обновлены ссылки в `.cursorrules` на новые пути
  * **Удаление неиспользуемой переменной**:
    - Удалена переменная `--color-primary-muted` и связанные переменные (`--color-primary-muted-h`, `--color-primary-muted-s`, `--color-primary-muted-l`, `--color-primary-muted-rgb`) из `ui/styles/theme-colors.css` (светлая и темная темы)
    - Удалены записи о `--color-primary-muted` и `--color-primary-muted-rgb` из `ui/styles/colors-review.html`
    - Удалена категория "Primary" из выпадающего списка категорий в `ui/styles/colors-review.html` (так как цветов с этой категорией больше нет)
  * **Обновление стилей review-файлов**:
    - Убрана тень (`box-shadow`) у `.review-header` в `ui/review-styles.css`
    - Убран вертикальный гэп (`margin-bottom: 0`) между вкладками и блоком фильтров
    - Убрана внешняя рамка (`border: none`, `box-shadow: none`) у блока фильтров
  * **Обновление документации**:
    - Добавлено описание каталога цветов (`ui/styles/colors-review.html`) в `architect.md` и `ui/guide-ii.md`
    - Добавлено описание системы управления review-файлами (`ui/review-manager.js` и `ui/review-styles.css`) в `architect.md` и `ui/guide-ii.md`
    - Обновлена структура проекта в `architect.md`: добавлены `review-manager.js`, `review-styles.css`, `colors-review.html`
    - Исправлены несоответствия в структуре проекта: добавлены `button.js`, `dropdown-menu.js` в список компонентов и `button.css` в список стилей
    - Добавлено упоминание `ui/styles/button.css` в раздел "Текущее размещение файлов"
- **Функциональность**: Review-файлы теперь находятся в более логичном месте (`ui/`), неиспользуемый код удален, документация актуализирована и соответствует кодовой базе. Интерфейс review-файлов упрощен (убрана тень, рамка фильтров, вертикальный гэп).

### Коммит: Rename coingecko.js to coins-manager.js and update documentation
- **Что сделано**: Переименован файл `ui/api/coingecko.js` в `ui/api/coins-manager.js`, обновлены все ссылки в документации и коде, исправлены несоответствия
- **Как сделано**:
  * **Переименование файла и компонента**:
    - Переименован файл `ui/api/coingecko.js` → `ui/api/coins-manager.js`
    - Переименован компонент `window.cmpCoinGecko` → `window.cmpCoinsManager`
    - Обновлен template ID `#coingecko-template` → `#coins-manager-template`
    - Обновлено имя компонента в шаблоне `app-coingecko` → `app-coins-manager`
    - Обновлена регистрация компонента в `app-ui-root.js`
  * **Обновление документации**:
    - Обновлены все упоминания в `architect.md`: `ui/api/coingecko.js` → `ui/api/coins-manager.js`
    - Обновлены все упоминания в `migration-plan.md`: `ui/api/coingecko.js` → `ui/api/coins-manager.js`
    - Исправлен комментарий в `ui/config/table-columns-config.js`: `ui/api/coingecko.js` → `ui/api/coins-manager.js`
  * **Обновление дневных логов**:
    - Добавлены примечания о переименовании в существующие записи дневного лога от 12-14
    - Упоминания старого файла дополнены указанием нового названия: `ui/api/coingecko.js` (теперь `ui/api/coins-manager.js`)
- **Функциональность**: Файл переименован для отражения его более широкой роли (не только CoinGecko API, но и управление монетами в целом). Все ссылки в документации и коде обновлены. Дневные логи содержат контекст о переименовании для понимания истории изменений.

### Коммит: Start of day: 12-14
- **Что сделано**: Открыт новый рабочий день 14 декабря 2025
- **Как сделано**:
  * Проведена проверка документации проекта (`.cursorrules`, `architect.md`, `ui/guide-ii.md`)
  * Проверено состояние репозитория (чистое рабочее дерево, синхронизировано с `origin/master`)
  * Проверены текущие версии зависимостей (Vue.js 3.5.25, Bootstrap 5.3.8, Font Awesome 6.5.1)
  * Создан файл дневного лога `history/2025/12-14.txt`
  * Обновлен `lastCommitMessage` в `core/cfg-app.js` на "Start of day: 12-14"
- **Функциональность**: Зафиксировано начало рабочего дня в истории репозитория, обеспечена преемственность документации и правил работы ИИ-агента

