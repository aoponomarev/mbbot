# Дневной лог разработки - 2025-12-10

> **⚠️ КРИТИЧЕСКИ ВАЖНО**: В этом логе упоминается файл `ui/api/coingecko.js`, который был переименован в `ui/api/coins-manager.js` (коммит от 14.12.2025). При чтении этого лога учитывайте, что все упоминания `ui/api/coingecko.js` относятся к текущему файлу `ui/api/coins-manager.js`.

## UI (оформление)

### Коммит: [a602a3e] - Update documentation: add caching system and archive structure
- **Что сделано**: Обновлена документация проекта: добавлен раздел о системе кэширования данных, обновлены описания архива монет и управления списком, дополнен список настроек в системе экспорта/импорта.
- **Как сделано**:
  * В `architect.md` добавлен новый раздел "Система кэширования данных" с описанием кэширования иконок монет и метрик рынка, принципов работы, правил кэширования и списка кэшируемых данных.
  * Обновлен раздел "Текущие настройки" в "Расширяемая система экспорта/импорта настроек": добавлены `cgCoins`, `cgLastUpdated`, `cgSelectedCoins`, `cgArchivedCoins`, `activeTab` в обычные настройки, добавлены кэши (`cgIconsCache`, `cgIconsCacheTimestamp`, `marketMetricsCache`, `marketMetricsCacheTimestamp`) в исключенные ключи.
  * Обновлен раздел "Текущее размещение файлов": уточнено описание компонентов `ui/api/perplexity.js` (или `settings.js`) и `ui/api/coingecko.js` с указанием полного функционала.
  * В `ui/guide-ii.md` добавлен раздел "Кэширование данных" в секцию "Interaction (паттерны UX)" с описанием кэширования иконок монет и метрик рынка, фильтрации анимации и валидации кэша.
  * Обновлен раздел "Персистентность": добавлены упоминания о сохранении активной вкладки и списка монет.
  * Обновлен раздел "Паттерны взаимодействия": добавлено подробное описание управления списком монет (поиск, архив, контекстное меню, сортировка таблицы).
- **Функциональность**: Документация теперь полностью отражает реализованную систему кэширования данных, структуру архива монет и все паттерны взаимодействия с управлением списком монет. Документация согласована с текущим состоянием проекта.

## UI (оформление)

### Коммит: [89b6f62] - Add caching for icons and market metrics, improve archive UI
- **Что сделано**: Реализовано кэширование иконок монет и метрик рынка (не чаще 1 раза в час), добавлена фильтрация символов анимации из кэша, улучшен интерфейс архива (ширина по контенту, tooltip с полным именем монеты), упрощена функция архивирования.
- **Как сделано**:
  * В `ui/api/coingecko.js` упрощена функция `archiveCoin()`: убрана валидация, используется прямое сохранение `coin.symbol` и `coin.name` из CoinGecko API.
  * Добавлено кэширование иконок монет с проверкой времени: обновление не чаще 1 раза в час через `cgIconsCacheTimestamp` в localStorage.
  * В `ui/interaction/footer.js` реализовано кэширование метрик рынка (FGI, VIX, BTC Dominance, OI, FR, LSR) с проверкой времени (не чаще 1 раза в час).
  * Добавлена функция `filterSpinnerChars()` для фильтрации символов анимации (`|`, `/`, `-`, `\`) из метрик перед сохранением в кэш (заменяются на "—").
  * При загрузке из кэша: если есть неопределенные метрики ("—"), они продолжают загружаться из API с показом анимации слешами.
  * Кэшируются только успешно загруженные метрики с реальными значениями (пустые значения не кэшируются).
  * В `index.html` изменена ширина выпадающего списка "Архив": `min-width: 200px` заменено на `width: auto; min-width: fit-content;` для подстройки под контент.
  * Добавлен tooltip с полным именем монеты при ховере над пунктами архива: `:title="getArchivedCoinName(archivedCoin)"`.
- **Функциональность**: Иконки монет и метрики рынка кэшируются и обновляются не чаще 1 раза в час, что уменьшает количество запросов к API. Символы анимации не попадают в кэш, неопределенные метрики продолжают загружаться с анимацией. Выпадающий список архива имеет ширину по контенту, при наведении показывается полное имя монеты. Функция архивирования упрощена и работает напрямую с данными CoinGecko API.

## UI (оформление)

### Коммит: [a2c1ec1] - Change archive structure to store coin ticker and name separately
- **Что сделано**: Изменена структура хранения архива монет: теперь сохраняются объекты с полями `id`, `symbol` и `name` вместо простых ID, в выпадающем списке архива показывается только тикер.
- **Как сделано**:
  * В `ui/api/coingecko.js` изменена структура `cgArchivedCoins`: теперь массив объектов `{id, symbol, name}` вместо массива строк (ID).
  * При загрузке из localStorage добавлена обратная совместимость: если загружен массив строк (старый формат) - автоматически преобразуется в объекты с fallback значениями.
  * Метод `archiveCoin()` теперь сохраняет объект с тремя полями: `id` (ID монеты), `symbol` (тикер в uppercase), `name` (полное название).
  * Метод `restoreFromArchiveById()` обновлен для работы с объектами: поиск по `archived.id` вместо прямого сравнения строк.
  * Добавлен метод `getArchivedCoinId(archivedCoin)` для получения ID из объекта или строки (обратная совместимость).
  * Методы `getArchivedCoinSymbol()` и `getArchivedCoinIcon()` обновлены для работы с объектами: проверяют `archivedCoin.symbol` и `archivedCoin.id` соответственно.
  * В `index.html` обновлен шаблон архива: `v-for="archivedCoin in cgArchivedCoins"` вместо `v-for="archivedId in cgArchivedCoins"`, использование `getArchivedCoinId()`, `getArchivedCoinSymbol()`, `getArchivedCoinIcon()` с объектами.
  * В выпадающем списке архива показывается только тикер (без полного названия), как и требовалось.
- **Функциональность**: При архивировании монеты сохраняются её ID, тикер и полное название в структурированном виде. В выпадающем списке архива отображается только тикер монеты для компактности. Система экспорта/импорта автоматически поддерживает новую структуру (собирает все ключи из localStorage). Обеспечена обратная совместимость со старым форматом архива (массив строк).

### Коммит: [0591c5f] - Review and add avto- hash markers to all significant containers
- **Что сделано**: Проведена ревизия системы маркировки контейнеров `avto-{hash}`, добавлены маркеры для header и footer, обновлена документация с актуальными примерами.
- **Как сделано**:
  * Проверены все значимые контейнеры в проекте на наличие маркировки `avto-{hash}`.
  * Добавлена маркировка для header: `<header class="... avto-vn6jdk3M">` (хэш `vn6jdk3M` сгенерирован через Base58).
  * Добавлена маркировка для footer: `<footer class="... avto-3B8RpMhu">` (хэш `3B8RpMhu` сгенерирован через Base58).
  * Проверены существующие маркеры: `avto-X7pL2nQ` (корневой контейнер контента), `avto-K9mP4rT` (основная секция main), `avto-M3nP8qW` (карточка настроек), `avto-B7fN2kT` (карточка CoinGecko) - все на месте.
  * Splash screen не маркирован `avto-`, так как имеет `id="splash-screen"` и используется в JS через `getElementById()` (JS-зависимый элемент).
  * Контекстное меню не маркировано, так как является динамическим элементом с JS-зависимостями (позиционирование через JS).
  * В `architect.md` обновлены примеры маркировки с актуальными хэшами и добавлены примеры для header и footer.
- **Функциональность**: Все значимые контейнеры проекта теперь имеют маркировку `avto-{hash}` для удобной навигации в DevTools и указания агенту места в коде. Система маркировки полная и согласованная.

### Коммит: [441e3f6] - Remove full coin name from archive dropdown, show only ticker
- **Что сделано**: Убрано полное название монеты из выпадающего списка архива, теперь показывается только тикер (сокращенная аббревиатура).
- **Как сделано**:
  * В `index.html` удалена строка `<small class="text-muted">{{ getArchivedCoinName(archivedId) }}</small>` из структуры элемента архива.
  * Теперь в архиве отображается только тикер монеты в верхней строке с классами `fw-semibold small text-uppercase`, без полного названия внизу.
  * Структура архива теперь идентична структуре результатов поиска по отображению тикера (только тикер, без названия).
- **Функциональность**: В выпадающем списке архива показывается только тикер монеты (BTC, ETH и т.п.), без дублирования полного названия. Интерфейс стал более компактным и единообразным.

### Коммит: [4dbe4f8] - Fix coins count button styles and unify card-header layout
- **Что сделано**: Исправлены стили кнопки индикатора числа монет (убрана блеклость), переделана структура card-header для единого потока элементов с равными гэпами.
- **Как сделано**:
  * В `index.html` убран атрибут `disabled` у кнопки индикатора числа монет, чтобы она выглядела как обычная кнопка (как "Обновить"), а не блеклой.
  * Переделана структура `card-header`: убрано разделение на три секции (`<div class="d-flex justify-content-between align-items-center w-100">`), все элементы теперь в едином потоке с классом `d-flex align-items-center gap-2` на `card-header`.
  * Поле поиска использует `flex-grow-1` для растягивания, остальные элементы (Архив, индикатор монет, дата/время, Обновить) идут последовательно с равными отступами через `gap-2`.
  * Убраны обертки `<div class="d-flex align-items-center gap-2">` вокруг групп элементов, все элементы на одном уровне.
- **Функциональность**: Кнопка индикатора числа монет теперь визуально идентична кнопке "Обновить" (не блеклая). Все элементы в card-header имеют визуально равные отступы между собой, структура упрощена до единого потока без разделения на секции.

### Коммит: [665d722] - Add pluralize utility, convert coins count to button, remove archive indicator
- **Что сделано**: Создана глобальная утилита для склонения русских числительных, индикатор числа монет преобразован в кнопку в стиле "Архив" и "Обновить", убран индикатор числа монет в архиве.
- **Как сделано**:
  * Создан файл `ui/utils/pluralize.js` с глобальной функцией `window.pluralize(number, forms)` для склонения русских числительных по правилам русского языка (1 монета, 2-4 монеты, 5+ монет, 11-19 монет).
  * Подключен `pluralize.js` в `index.html` после `table-sort-mixin.js`.
  * В `ui/api/coingecko.js` добавлен метод `pluralizeCoins(count)` для склонения слова "монета" с использованием глобальной утилиты.
  * В `index.html` индикатор числа монет (`<small>`) заменен на кнопку `<button class="btn btn-sm btn-outline-secondary" disabled>` с текстом `{{ sortedCoins.length }} {{ pluralizeCoins(sortedCoins.length) }}` (например: "5 монет").
  * Убран индикатор архива `<small class="text-muted" v-if="cgArchivedCoins.length > 0">{{ cgArchivedCoins.length }}</small>`.
  * Кнопка числа монет имеет те же стили, что и кнопки "Архив" и "Обновить" (`btn-sm btn-outline-secondary`), фиксированную ширину по контенту (`width: auto; min-width: fit-content;`), состояние `disabled` для визуального единства.
  * В `architect.md` добавлена информация о новой утилите `pluralize.js` в раздел "Текущее размещение файлов" → "UI Utilities".
- **Функциональность**: Индикатор числа монет теперь отображается в виде кнопки, стилистически единой с другими кнопками управления. Текст кнопки использует правильное склонение слова "монета" в зависимости от числа (1 монета, 2 монеты, 5 монет и т.д.). Глобальная утилита `pluralize` может использоваться для склонения любых русских слов в проекте. Индикатор архива убран для упрощения интерфейса.

### Коммит: [4bd04f2] - Add coins count indicator and format date/time in two lines
- **Что сделано**: Добавлен индикатор числа монет в таблице после кнопки "Архив", изменен формат отображения даты и времени на две строки без запятой.
- **Как сделано**:
  * В `index.html` добавлен индикатор `{{ sortedCoins.length }}` после индикатора архива для отображения количества монет в основной таблице.
  * Изменен формат отображения даты/времени: вместо одной строки с запятой (`toLocaleString()`) теперь две строки - дата и время отдельно.
  * В `ui/api/coingecko.js` изменено сохранение `cgLastUpdated` с `toLocaleString()` на `toISOString()` для более надежного парсинга.
  * Добавлены методы `formatLastUpdatedDate()` и `formatLastUpdatedTime()` для форматирования даты и времени в две строки с поддержкой обратной совместимости (старый формат `toLocaleString()` также обрабатывается).
  * В `index.html` дата/время отображаются в двух `<div>` элементах с `line-height: 1.2` для компактного отображения.
- **Функциональность**: Пользователь видит количество монет в таблице рядом с количеством в архиве. Дата и время обновления отображаются в две строки без запятой, что улучшает читаемость и компактность.

### Коммит: [41cef8d] - Fix archive button width, coin display order, header alignment, and table spacing
- **Что сделано**: Зафиксирована ширина кнопки "Архив" по контенту, исправлен порядок отображения монет (тикер вместо названия в верхней строке), выровнено содержимое card-header по вертикали, убран зазор между низом таблицы и низом карточки.
- **Как сделано**:
  * В `index.html` добавлены стили `width: auto; min-width: fit-content;` на кнопку "Архив" для фиксации ширины по контенту.
  * В результатах поиска монет изменен порядок отображения: тикер (`result.symbol`) теперь в верхней строке с классами `fw-semibold small text-uppercase`, полное название (`result.name`) в нижней строке с классом `text-muted`.
  * В `card-header` добавлен класс `d-flex align-items-center` для вертикального выравнивания по центру, убран `mb-2` из внутреннего контейнера, добавлен `w-100` для полной ширины.
  * В `ui/styles/layout.css` добавлены глобальные CSS правила для удаления нижнего маргина у последней таблицы в `card-body`: `.card-body > .table-responsive:last-child`, `.card-body > .table:last-child` с `margin-bottom: 0 !important;`.
- **Функциональность**: Кнопка "Архив" имеет фиксированную ширину по контенту, не растягивается. В результатах поиска и архиве тикер отображается в верхней строке (более заметно), название внизу. Содержимое card-header выровнено по вертикали по центру. Таблица не имеет зазора снизу в карточке, визуально прилегает к низу.

### Коммит: [3f9d71c] - Fix archive dropdown, context menu actions, and add multi-coin search
- **Что сделано**: Исправлен dropdown архива (иконка + тикер), исправлены кнопки перемещения в контекстном меню, убрано цветовое выделение пунктов меню, добавлен disabled для пустого архива, реализован множественный поиск монет через разделители.
- **Как сделано**:
  * Заменен HTML `<select>` на кастомный dropdown для архива: кнопка "Архив" открывает выпадающий список с иконками и тикерами монет (аналогично поиску).
  * В `ui/api/coingecko.js` добавлены методы: `toggleArchiveDropdown()`, `closeArchiveDropdownOnOutside()`, `restoreFromArchiveById(coinId)`, `getArchivedCoinName()`, `getArchivedCoinSymbol()`, `getArchivedCoinIcon()`.
  * Исправлен метод `moveToPosition()`: изменена логика перемещения - для 'up' и 'down' используется обмен местами вместо splice, что исправляет баг с неработающими кнопками.
  * Убраны классы `text-warning` и `text-danger` из кнопок "В архив" и "Удалить" в контекстном меню для единообразного оформления.
  * Добавлен `:disabled="cgArchivedCoins.length === 0"` на кнопку "Архив" для блокировки при пустом архиве.
  * Реализован множественный поиск монет: метод `searchCoins()` теперь разбивает запрос на термины через регулярное выражение `/[^a-zA-Z0-9]+/` (все разделители кроме букв и цифр), выполняет отдельные запросы для каждого термина и объединяет результаты с удалением дубликатов.
  * Добавлено поле `showArchiveDropdown` в data для управления видимостью dropdown архива.
- **Функциональность**: Dropdown архива теперь показывает иконку и тикер каждой монеты, кнопки перемещения в контекстном меню работают корректно, все пункты меню оформлены единообразно, архив недоступен когда пуст, поиск поддерживает множественный ввод (например: "btc, ena, eth" или "btc/ena eth") с любыми разделителями.

### Коммит: [4465437] - Fix table UI: restore archive, context menu, remove sort icons, improve spacing
- **Что сделано**: Исправлена кнопка обновления (текст вместо Unicode), исправлено контекстное меню (появляется при клике), добавлен селект архива с индикатором количества, убраны иконки сортировки, улучшено визуальное оформление таблицы.
- **Как сделано**:
  * В `index.html` заменен Unicode символ "⟳" на текст "Обновить" в кнопке обновления данных.
  * Исправлено контекстное меню: добавлен `@click.stop` и `@contextmenu.prevent.stop` на блок монеты, исправлен метод `openContextMenu()` с использованием `event.stopPropagation()`, добавлен метод `closeContextMenuOnOutside()` с правильной привязкой контекста через `.bind(this)`.
  * Добавлен селект архива справа от поля поиска: `<select>` с опциями из `cgArchivedCoins`, заголовок "Архив", обработчик `@change="restoreFromArchive"`.
  * Добавлен индикатор количества монет в архиве: `<small class="text-muted">` с `{{ cgArchivedCoins.length }}` справа от селекта.
  * В `ui/api/coingecko.js` добавлены методы: `restoreFromArchive()` (восстанавливает монету из архива в таблицу), `getArchivedCoinName(coinId)` (получает название монеты для селекта).
  * Убраны иконки сортировки (`<i :class="getSortIcon(...)"></i>`) из всех заголовков колонок, оставлен только текст.
  * В `ui/styles/layout.css` добавлены стили: `.table tbody tr:last-child td { border-bottom: none !important; }` (убирает светлую линию под последней строкой), `.avto-B7fN2kT .card-body { padding-bottom: 0.5rem !important; }` (уменьшает паддинг между низом таблицы и низом карточки).
- **Функциональность**: Кнопка обновления теперь показывает текст "Обновить" вместо символа. Контекстное меню корректно открывается при клике на блок монеты. Пользователь может восстановить монету из архива через селект, видит количество монет в архиве. Интерфейс таблицы упрощен (без иконок сортировки), визуально чище (без лишних линий и отступов).

### Коммит: [dc6b0e2] - Add table sorting, context menu, coin archive, and UI improvements
- **Что сделано**: Реализована глобальная система сортировки таблиц, контекстное меню для операций с монетами, архив монет, улучшен интерфейс таблицы (убрано название монеты, колонка цены, заменены крестики на чекбоксы, нейтральная кнопка обновления).
- **Как сделано**:
  * Создан глобальный Vue mixin `ui/utils/table-sort-mixin.js` для циклической сортировки таблиц (3 состояния: null → asc → desc → null).
  * Mixin добавляет методы `handleSort(field)`, `sortData(data, defaultOrder)`, `getSortValue(item, field)`, `getSortIcon(field)` и data-свойства `sortBy`, `sortOrder`.
  * В `ui/api/coingecko.js` подключен mixin через `mixins: [window.tableSortMixin]`, добавлен computed-свойство `sortedCoins()`.
  * В `index.html` добавлены обработчики `@click="handleSort(field)"` на заголовки колонок с иконками сортировки (`fa-sort`, `fa-sort-up`, `fa-sort-down`).
  * Убрана колонка "Цена", убрано полное название монеты (оставлен только uppercase тикер с иконкой).
  * Добавлен нативный tooltip через атрибут `title="coin.name"` на блок иконка+тикер для показа полного названия.
  * Реализовано контекстное меню по клику/правому клику на блок монеты: операции "В начало", "Вверх", "Вниз", "В конец", "В архив", "Удалить".
  * В `ui/api/coingecko.js` добавлены методы: `openContextMenu()`, `closeContextMenu()`, `moveToPosition(position)`, `archiveCoin()`.
  * Добавлено хранилище архивированных монет (`cgArchivedCoins`) в localStorage.
  * Заменены кнопки удаления (крестики) на чекбоксы в первой колонке (без функциональности).
  * Кнопка обновления данных изменена с `btn-outline-primary` с иконкой `fa-sync-alt` на `btn-outline-secondary` с Unicode символом "⟳" для нейтрального вида.
  * Таблица теперь использует `sortedCoins` вместо `cgCoins` для отображения отсортированных данных.
- **Функциональность**: Таблица поддерживает циклическую сортировку по клику на заголовок колонки (возрастание/убывание/отмена). Контекстное меню позволяет перемещать монеты в списке, архивировать или удалять их. Архив монет хранится отдельно в localStorage. Интерфейс упрощен: показывается только тикер с иконкой, полное название в tooltip, чекбоксы для будущего функционала, нейтральная кнопка обновления.

### Коммит: [a2bf815] - Improve CoinGecko search: sort by ticker match, add hover effects, cache icons
- **Что сделано**: Улучшена сортировка результатов поиска (полные совпадения по тикеру выше), добавлена подсветка при наведении на элементы выпадающего списка, реализовано кэширование иконок монет для мгновенной загрузки.
- **Как сделано**:
  * В `ui/api/coingecko.js` метод `searchCoins()` дополнен сортировкой результатов: полные совпадения с тикером (case-insensitive) выводятся первыми, затем тикеры, начинающиеся с запроса, затем остальные по `market_cap_rank` (популярности).
  * В `ui/styles/layout.css` добавлены стили для `.cg-search-item`: `cursor: pointer`, `transition: background-color 0.15s ease-in-out`, `:hover` с `var(--bs-secondary-bg)`, `:active` с `var(--bs-tertiary-bg)`.
  * В `index.html` удален inline `style="cursor: pointer;"` из элементов списка, добавлены классы `cg-search-dropdown` и `cg-search-item` для управления через CSS.
  * В `ui/api/coingecko.js` реализовано кэширование иконок монет в `localStorage`:
    - Добавлено поле `cgIconsCache` в `data()` для реактивного доступа к кэшу иконок.
    - Метод `cacheCoinsIcons(coins)` добавляет иконки в кэш и сохраняет в `localStorage` под ключом `cgIconsCache`.
    - Метод `getCoinIcon(coin)` возвращает иконку из кэша или из объекта монеты с автоматическим кэшированием.
    - При загрузке данных из API (`fetchCoinGecko()`) иконки автоматически кэшируются через `cacheCoinsIcons()`.
    - При добавлении монеты через поиск (`addCoin()`) иконка из результатов поиска сразу кэшируется.
  * В `index.html` заменено `coin.image` на `getCoinIcon(coin)` для отображения иконок в таблице, обеспечивая мгновенную загрузку из кэша.
- **Функциональность**: Результаты поиска монет теперь отсортированы по релевантности (точные совпадения тикера сверху), элементы списка подсвечиваются при наведении мыши (плавная анимация), иконки монет кэшируются в localStorage и загружаются мгновенно при повторном отображении, без задержек.

## UX (паттерны взаимодействий)

### Коммит: [50c3603] - Optimize main layout: remove wrapper, center content, fix header spacing
- **Что сделано**: Оптимизирована структура основного контента: убрана лишняя обертка `<div class="row">`, перенесен класс `row` на `<main>`, добавлено центрирование контента с ограничением ширины, исправлен отступ сверху (контент не перекрывается хедером), убраны `!important` из CSS.
- **Как сделано**:
  * В `index.html` убрана лишняя обертка `<div class="row">`, класс `row` перенесен на `<main class="avto-K9mP4rT row justify-content-center">`.
  * Убран пустой `<header class="mb-4"></header>`, который создавал лишний отступ сверху.
  * Убраны Bootstrap классы `pt-5 pb-4` из HTML, вместо них используется кастомный CSS селектор `.container-fluid.app-main-container` с достаточной специфичностью (два класса) для переопределения дефолтных стилей Bootstrap без `!important`.
  * В `ui/styles/layout.css` добавлены стили для `.container-fluid.app-main-container` с `padding-top: 60px` (хедер 50px + зазор 10px) и `padding-bottom: 20px`.
  * Добавлены стили для `.avto-K9mP4rT` с `max-width: 1400px`, `margin: 0 auto` для центрирования, адаптивными боковыми отступами (15px на десктопе, 10px на мобильных < 576px).
  * Убраны все `!important` из CSS, используется правильная специфичность селекторов.
- **Функциональность**: Контент теперь красиво центрирован с максимальной шириной 1400px, не перекрывается фиксированным хедером, имеет адаптивные отступы для мобильных устройств. Структура упрощена без лишних оберток, код чище и проще в поддержке.

### Коммит: [520b03e] - Add inverse theme for header dropdowns/tooltips and remove header side padding
- **Что сделано**: Реализована инверсная тема для dropdown меню и всплывающих подсказок в хедере, убраны боковые паддинги в хедере, центральный блок занимает всю доступную ширину.
- **Как сделано**:
  * Добавлен метод `getInverseTheme()` и computed-свойство `inverseTheme` в `ui/interaction/header.js` для получения инверсной темы (light ↔ dark).
  * Dropdown меню используют инверсную тему через `:data-bs-theme="inverseTheme"` вместо `getCurrentTheme()`.
  * Реализована инициализация Bootstrap tooltips с инверсной темой через `data-bs-theme` в методе `initTooltips()`, tooltips обновляются при изменении темы приложения.
  * Убраны кастомные `border-radius: 4px` из `ui/styles/dropdown.css`, используются дефолтные значения Bootstrap (`var(--bs-border-radius)`).
  * Унифицированы стили dropdown для десктоп и мобильной версии (убрана медиа-запрос `@media (max-width: 767.98px)`, стили применяются ко всем `.app-header-dropdown-menu`).
  * Убраны боковые паддинги в хедере: добавлен класс `app-header-container-fluid` с `padding-left: 0` и `padding-right: 0` в `ui/styles/header.css`, убран класс `px-3` у центрального блока в `index.html`.
  * Центральный блок хедера использует `flex-grow-1` и занимает всю доступную ширину без боковых паддингов.
- **Функциональность**: Dropdown меню и всплывающие подсказки в хедере теперь инверсны включенной теме приложения (если тема light — dropdown/tooltip dark, и наоборот), обеспечивая визуальный контраст. Оформление идентично для десктоп и мобильной версии. Хедер не имеет боковых паддингов, центральный блок занимает всю доступную ширину.

## UX (паттерны взаимодействий)

### Коммит: [3df7eb2] - Fix component visibility toggle and tab switching logic
- **Что сделано**: Исправлена логика переключения видимости компонентов `app-settings` и `app-coingecko` при взаимодействии с гамбургером и вкладкой "%". Исправлен баг, когда после открытия настроек через гамбургер вкладка "%" переставала переключаться.
- **Как сделано**:
  * Перенесено состояние `activeTab` из компонента header в корневой компонент (`app/app-ui-root.js`) для централизованного управления и доступа из разных компонентов.
  * В `ui/interaction/header.js` `activeTab` преобразован в computed-свойство, которое читает значение из корневого компонента (`this.$root.activeTab`).
  * Добавлен watch для `$root.activeTab` в `ui/interaction/header.js` для реактивного обновления computed-свойств при изменении активной вкладки.
  * Метод `toggleMenu()` в `ui/interaction/header.js` теперь только открывает настройки (`root.showSettings = true`), не переключает их.
  * Метод `switchTab()` в `ui/interaction/header.js` при переключении на вкладку "%" всегда закрывает настройки (`root.showSettings = false`), обеспечивая показ CoinGecko.
  * В `index.html` добавлен `@click="switchTab(tab.id)"` на label радиокнопок вкладок для обработки клика даже когда вкладка уже активна (HTML radio buttons не генерируют `@change` при клике на уже активную кнопку).
  * В `index.html` условия видимости компонентов используют `showSettings && activeTab === 'percent'` для `app-settings` и `!showSettings && activeTab === 'percent'` для `app-coingecko`.
- **Функциональность**: Гамбургер теперь только открывает настройки, не переключает их. Вкладка "%" всегда показывает CoinGecko и закрывает настройки при переключении. Клик на вкладку "%" работает даже когда она уже активна, исправляя баг с невозможностью переключения после открытия настроек через гамбургер.

### Коммит: [c80858f] - Fix settings visibility from any tab and add activeTab persistence
- **Что сделано**: Исправлен баг, когда настройки не открывались при клике на гамбургер с любой вкладки кроме "%". Добавлено сохранение активной вкладки в localStorage.
- **Как сделано**:
  * В `index.html` убрано условие `activeTab === 'percent'` из `v-if` для `app-settings`, чтобы настройки показывались при `showSettings === true` независимо от активной вкладки.
  * Для `app-coingecko` оставлено условие `!showSettings && activeTab === 'percent'`, чтобы он показывался только на вкладке "%" когда настройки закрыты.
  * В `app/app-ui-root.js` добавлена загрузка сохраненной активной вкладки из localStorage при инициализации (`savedActiveTab = localStorage.getItem('activeTab')`).
  * В `app/app-ui-root.js` добавлен watch для `activeTab`, который сохраняет текущую вкладку в localStorage при изменении.
- **Функциональность**: Настройки теперь открываются при клике на гамбургер с любой вкладки, а не только с "%". Активная вкладка сохраняется в localStorage и восстанавливается при перезагрузке приложения.

## MM (математическая модель)

## Architect (архитектура, настройки)

### Коммит: [0cb545e] - Add adaptive timeout for rate limiting and sync table/archive
- **Что сделано**: Реализован адаптивный таймаут для обработки rate limiting CoinGecko API (экспоненциальный backoff), добавлена синхронизация данных между таблицей и архивом монет, реализовано восстановление автоматически заархивированных монет с обработкой failed- монет, добавлена визуальная дифференциация автоматически заархивированных монет (иконка рефреша), улучшена читабельность желтых элементов (темно-оранжевый цвет), добавлены стили для disabled полей в темной теме, скорректировано позиционирование панельки загрузки монет.
- **Как сделано**:
  * В `ui/api/coingecko.js` реализован адаптивный таймаут для обработки rate limiting:
    - Добавлены свойства `adaptiveTimeout` (текущий таймаут, начинается с 300ms), `adaptiveTimeoutBase` (300ms), `adaptiveTimeoutMax` (10000ms), `lastSuccessfulRequest` (время последнего успешного запроса).
    - Метод `increaseAdaptiveTimeout()`: удваивает таймаут при получении 429 ошибки, ограничен максимумом 10 секунд.
    - Метод `decreaseAdaptiveTimeout()`: уменьшает таймаут на 20% при успешных запросах и если прошло более 5 секунд без ошибок, не ниже базового значения.
    - Метод `resetAdaptiveTimeout()`: сбрасывает таймаут к базовому значению при начале нового процесса.
    - Обработка 429 ошибок во всех методах API: `fetchCoinGecko()`, `getCoinIdBySymbol()`, `searchCoins()`, `archiveFailedTicker()`.
    - Адаптивный таймаут применяется в `processTickersQueue()` как задержка между последовательными запросами и между повторными попытками неудачных тикеров.
  * Реализована синхронизация данных между таблицей и архивом:
    - Метод `syncCoinWithArchive(coinId, action)`: синхронизирует одну монету - при `action === 'add'` удаляет из архива, при `action === 'archive'` удаляет из таблицы.
    - Метод `syncAllCoinsWithArchive()`: очищает дубликаты при загрузке приложения, удаляет из архива все монеты, присутствующие в таблице.
    - Синхронизация применяется в: `addCoin()`, `processTickersQueue()`, `archiveCoin()`, `archiveSelectedCoins()`, `restoreFromArchiveById()`.
    - Вызов `syncAllCoinsWithArchive()` в `mounted()` для проверки дубликатов при загрузке.
  * Улучшено восстановление монет из архива:
    - Метод `restoreFromArchiveById()` стал асинхронным, обрабатывает монеты с префиксом `failed-{ticker}`.
    - При восстановлении автоматически заархивированной монеты извлекается тикер и находится реальный CoinGecko ID через `getCoinIdBySymbol()`.
    - Если монета не найдена - возвращается в архив, процесс не продолжается.
    - После добавления в таблицу проверяется успешность загрузки данных через `fetchCoinGecko()` и наличие монеты в таблице.
    - При ошибке добавления или отсутствии монеты в таблице - откат изменений: монета удаляется из таблицы и возвращается в архив с оригинальным ID.
  * Визуальная дифференциация автоматически заархивированных монет:
    - Метод `isFailedArchivedCoin(archivedCoin)`: проверяет, является ли монета автоматически заархивированной по префиксу `failed-` в ID.
    - Метод `getArchivedCoinIcon()`: для монет с префиксом `failed-` возвращает `null`, чтобы показать иконку рефреша в шаблоне.
    - В `index.html` добавлена условная отрисовка: для автоматически заархивированных монет показывается иконка Font Awesome `fa-sync-alt` (рефреш) вместо фирменной иконки монеты.
    - Иконка рефреша стилизована серым цветом (`text-muted`) и имеет размер 20x20px для соответствия обычным иконкам.
  * Улучшена читабельность желтых элементов:
    - В `ui/styles/layout.css` добавлены кастомные классы `.bg-warning-dark` и `.text-warning-dark` с темно-оранжевыми цветами.
    - Бейджи неудачных тикеров: `#cc7700` для светлой темы, `#ffb84d` для темной темы (белый/черный текст соответственно).
    - Текст предупреждений: `#cc7700` для светлой темы, `#ffb84d` для темной темы.
    - В `index.html` заменены стандартные Bootstrap классы `bg-warning` и `text-warning` на кастомные для улучшенной читабельности на белом фоне.
  * Стили для disabled полей в темной теме:
    - В `ui/styles/layout.css` добавлены глобальные стили для всех типов disabled полей ввода в темной теме.
    - `.form-control:disabled`, `.form-control[readonly]`: темный фон `var(--bs-secondary-bg)`, приглушенный текст `var(--bs-secondary-color)`, прозрачность `0.65`.
    - `.form-select:disabled`: те же стили для select элементов.
    - `.form-check-input:disabled`: темный фон для чекбоксов.
    - `textarea.form-control:disabled`: стили для текстовых областей.
    - Используется `!important` для переопределения стандартных стилей Bootstrap, которые применяют белый фон для disabled элементов.
  * Позиционирование панельки загрузки монет:
    - В `index.html` добавлен класс `cg-loading-panel` к панельке загрузки монет.
    - В `ui/styles/layout.css` добавлен стиль `.card-header .cg-loading-panel` с отрицательным `margin-top: calc(-2.2rem + 0.45ex)` для поднятия панельки так, чтобы её верхний край был на уровне верхней границы card-header (на уровне кнопок управления).
    - Используются единицы `ex` для точного вертикального позиционирования, значение скорректировано для точного выравнивания.
  * В `architect.md` добавлены разделы "Адаптивный таймаут для обработки rate limiting API" и "Синхронизация данных между таблицей и архивом монет" с полным описанием принципов работы.
  * В `ui/guide-ii.md` обновлены разделы: добавлена информация об отключенных полях ввода, цветовых состояниях предупреждений, панельке загрузки монет, синхронизации таблицы и архива, восстановлении монет из архива, линейном добавлении монет списком тикеров с адаптивным таймаутом.
- **Функциональность**: Система автоматически адаптируется к rate limiting CoinGecko API: при получении 429 ошибок увеличивает задержки между запросами (удваивает таймаут до максимума 10 секунд), при успешных запросах постепенно уменьшает задержки (на 20% за раз, не ниже 300ms). Монеты не могут одновременно присутствовать в таблице и архиве - при добавлении монета удаляется из архива, при архивировании - удаляется из таблицы, при загрузке дубликаты автоматически очищаются. Автоматически заархивированные монеты (неудачные попытки добавления) визуально отличаются иконкой рефреша вместо фирменной иконки. Желтые элементы (бейджи и текст предупреждений) используют темно-оранжевый цвет для улучшенной читабельности на белом фоне. Disabled поля ввода в темной теме имеют темный фон вместо белого. Панелька загрузки монет позиционирована так, что её верхний край находится на одном уровне с кнопками в хедере карточки.

## Architect (архитектура, настройки)

### Коммит: [fa2f2cf] - Refactor import/export to universal system and fix import bugs
- **Что сделано**: Реализована универсальная система экспорта/импорта всех настроек проекта, удален экспорт messages (чат удален), исправлены баги с импортом (диалог выбора файла не открывался, тема не восстанавливалась).
- **Как сделано**:
  * В `ui/api/import-export.js` реализована универсальная система `collectAllSettings()`, которая автоматически собирает все настройки из localStorage, разделяя их на обычные (`regularSettings`) и обфусцированные (`secureData`).
  * Удален экспорт `messages` из формата экспорта (чат с Perplexity AI удален из интерфейса).
  * Добавлены массивы `SECURE_KEYS` (ключи обфусцированных данных) и `EXCLUDED_KEYS` (служебные ключи, не экспортируются).
  * Реализован метод `restoreAllSettings()` с поддержкой обратной совместимости форматов v1.0, v2.0 и v3.0.
  * Исправлен баг с диалогом выбора файла: `<input ref="fileInput">` перенесен из шаблона компонента `app-settings` в корневой `<div id="app">` в `index.html`, чтобы `this.$refs.fileInput` был доступен в корневом компоненте.
  * Исправлен баг с восстановлением темы: изменен порядок операций при импорте - сначала обновляется localStorage, затем Vue-свойство, чтобы watch в `cmpTheme` автоматически применил тему через `applyTheme()`.
  * В `architect.md` добавлен раздел "Расширяемая система экспорта/импорта настроек" с описанием принципов работы, правил для разработчиков, текущих настроек и примерами кода.
  * Обновлен `data-app.json` до формата v3.0 (универсальная система).
- **Функциональность**: Система экспорта/импорта теперь автоматически собирает все настройки из localStorage, не требуя изменений кода при добавлении новых настроек. При добавлении новой настройки в localStorage она автоматически попадает в экспорт/импорт. Обфусцированные данные (PIN, API-ключи) обрабатываются отдельно. Поддерживается обратная совместимость со старыми форматами. Диалог выбора файла теперь открывается корректно, все настройки (включая тему) восстанавливаются при импорте.

### Коммит: [950f57d] - Remove chat component registration from app-ui-root
- **Что сделано**: Удалена регистрация компонента чата `window.cmpChat()` из `app/app-ui-root.js`, так как чат с Perplexity AI был убран из интерфейса.
- **Как сделано**:
  * В `app/app-ui-root.js` удалена строка `window.cmpChat && window.cmpChat()` из массива `parts`.
  * Добавлен комментарий `// window.cmpChat удален - чат с Perplexity AI убран из интерфейса` для ясности.
- **Функциональность**: Приложение больше не пытается зарегистрировать компонент чата, который был удален из интерфейса. Это завершает процесс удаления чата с Perplexity AI из проекта.

### Коммит: [88af77b] - Add automatic container marking system with avto- classes
- **Что сделано**: Реализована система автоматической маркировки значимых контейнеров через CSS классы `avto-{Base58_8символов}` для удобной навигации в коде через DevTools и указания агенту места в разметке.
- **Как сделано**:
  * В `architect.md` добавлен раздел "Маркировка контейнеров" в секцию "Стандарты разработки" с полным описанием системы: назначение, формат маркировки (`avto-{Base58_8символов}`), правила применения (что маркировать, что не маркировать), изоляция (классы vs ID), примеры использования.
  * В `.cursorrules` добавлен пункт о маркировке контейнеров в раздел "При работе с файлами" → "HTML файлы" с ссылкой на полное описание в `architect.md` и правилами для ИИ-агента.
  * В `index.html` добавлены классы `avto-{hash}` к значимым контейнерам: корневой контейнер контента (`avto-X7pL2nQ`), основная секция `<main>` (`avto-K9mP4rT`), карточка настроек Perplexity AI (`avto-M3nP8qW`), карточка виджета CoinGecko (`avto-B7fN2kT`), информационная карточка (`avto-H5jR9vQ`).
  * Мелкие обертки (`.row`, `.col-*`, `.mb-3`, `.input-group`) и части компонентов (`.card-header`, `.card-body`) не маркируются согласно правилам.
  * JS-зависимые элементы (`id="apiKey"`, `id="model"`) остались с осмысленными ID, не используют `avto-*` классы.
- **Функциональность**: Система маркировки позволяет легко находить значимые контейнеры в DevTools по классам `avto-*` и указывать агенту место в коде через инспектор. Классы `avto-*` используются только для маркировки, не используются в JS/CSS, обеспечивая полную изоляцию от функциональности. Осмысленные ID используются только для JS-зависимых элементов.

### Коммит: [ec0208b] - Add CoinGecko coin search with autocomplete and customizable list
- **Что сделано**: Реализован поиск монет CoinGecko с автодополнением, замена колонки "60d %" на "14d %" и "200d %", сохранение полных данных монет в настройках, изменение логики обновления данных (только при загрузке и по кнопке).
- **Как сделано**:
  * В `ui/api/coingecko.js` заменен параметр запроса с `'1h,24h,7d,30d,60d'` на `'1h,24h,7d,14d,30d,200d'` для получения данных о процентных изменениях за 14 и 200 дней.
  * В `index.html` заменен заголовок таблицы "60d %" на "14d %" и "200d %", colspan ячеек обновлен с 8 на 9, добавлены соответствующие ячейки для отображения `price_change_percentage_14d_in_currency` и `price_change_percentage_200d_in_currency`.
  * В `ui/api/coingecko.js` добавлена инициализация данных из localStorage при монтировании компонента (`cgCoins`, `cgLastUpdated`, `cgSelectedCoins`).
  * При успешном запросе к API данные сохраняются в localStorage (`cgCoins`, `cgLastUpdated`, `cgSelectedCoins`).
  * Изменена логика в `mounted()`: данные загружаются только если `cgCoins.length === 0`, обеспечивая загрузку при старте только если нет сохраненных данных.
  * Список монет для запроса теперь берется из `cgSelectedCoins` вместо хардкодного списка `ids`, что позволяет пользователю настраивать список через поиск.
  * Добавлен метод `searchCoins(query)` для поиска монет через CoinGecko API `/search?query=...` с ограничением на 10 результатов.
  * Добавлен метод `addCoin(coinId)` для добавления монеты в `cgSelectedCoins` и обновления данных.
  * Добавлен метод `removeCoin(coinId)` для удаления монеты из списка.
  * Добавлен watch для `cgSearchQuery` с задержкой 500ms для автоматического поиска при вводе.
  * В `index.html` заменен заголовок "Топ-10 (CoinGecko)" на поле поиска с автодополнением (`input` с `v-model="cgSearchQuery"`, выпадающий список результатов с `v-for="result in cgSearchResults"`).
  * Первая колонка таблицы заменена с `#` на кнопку удаления монеты (`btn-outline-danger` с иконкой `fa-times` и `@click="removeCoin(coin.id)"`).
  * Кнопка "Обновить" теперь отображает только иконку обновления (`fa-sync-alt`) без текста, чтобы освободить место для поиска.
  * В `architect.md` обновлен раздел "Расширяемая система экспорта/импорта настроек" с упоминанием данных CoinGecko (`cgCoins`, `cgLastUpdated`, `cgSelectedCoins`).
- **Функциональность**: Пользователь может искать монеты по названию или тикеру (включая опечатки через API CoinGecko `/search`), добавлять их в список кликом на результат поиска, удалять монеты из списка через кнопку с иконкой крестика. Полные данные монет (включая список выбранных монет) автоматически сохраняются в localStorage и восстанавливаются при загрузке. Данные обновляются только при первой загрузке (если нет сохраненных) или по явному нажатию кнопки "Обновить", не обновляются при нажатии Refresh в хедере. Таблица отображает процентные изменения за 1h, 24h, 7d, 14d, 30d, 200d (вместо 60d).

### Коммит: [0a67ba3] - Create guide-ii.md and integrate with project documentation
- **Что сделано**: Создан файл `ui/guide-ii.md` с двумя секциями (Interface и Interaction), интегрирован с `architect.md` и `.cursorrules`, исправлены несогласованности в документации, добавлены правила контроля качества и сопровождения документации.
- **Как сделано**:
  * Создан файл `ui/guide-ii.md` с секциями "Interface (оформление)" и "Interaction (паттерны UX)" на основе текущего состояния проекта (компоненты, стили, паттерны взаимодействия).
  * В `architect.md` заменены полные описания разделов UI и MM на ссылки на соответствующие документы (`ui/guide-ii.md` для UI/UX, `architect.md` для MM).
  * В `architect.md` добавлен раздел "Отслеживание согласованности архитектурных правил" с упоминанием всех трех документов.
  * В `.cursorrules` обновлено правило обработки команд UI:/UX:/MM: - команды UI: и UX: теперь обновляют разделы в `ui/guide-ii.md`, команда MM: обновляет раздел в `architect.md`.
  * Исправлены несогласованности: добавлен `ui/guide-ii.md` в раздел "Текущее размещение файлов" и "Структура проекта" в `architect.md`, исправлено дублирование папки `ui/` в структуре проекта, добавлены недостающие файлы (`header.js`, `footer.js`).
  * В `ui/guide-ii.md` добавлен раздел "Связанные документы" со ссылками на все три документа проекта.
  * В `.cursorrules` добавлен раздел "Сопровождение документации проекта" с правилами обновления документации при изменениях в проекте (список документов: `.cursorrules`, `architect.md`, `ui/guide-ii.md`, исключение: папка `docs/`).
  * В `.cursorrules` добавлен раздел "Контроль качества выполнения" в начало файла с требованием проверки соответствия документации после каждой задачи и самостоятельного исправления ошибок.
  * Усилено правило о тщательной проверке согласованности: добавлено требование проверять документацию насквозь, а не "кусками", обновлять структуру проекта при изменениях, не допускать дублирования.
- **Функциональность**: Документация проекта теперь разделена по специализациям: `architect.md` содержит архитектурные решения и принципы MM, `ui/guide-ii.md` содержит принципы интерфейса и паттерны взаимодействий, `.cursorrules` содержит правила работы ИИ-агента. Все документы связаны между собой и согласованы. ИИ-агент теперь обязан контролировать качество выполнения задач и поддерживать актуальность документации.

### Коммит: [cc8d181] - Improve card headers, dropdowns styling and fix UI bugs
- **Что сделано**: Увеличены вертикальные паддинги в хедерах карточек, убраны выделяющие цвета во всех выпадающих списках, исправлен баг с подсветкой в выпадающем списке счетчика, применен единый стиль для всех выпадающих меню (контрастная рамка, тень, радиус 2.5px), исправлена подсветка уже добавленных монет в темной теме, улучшена логика отображения счетчика монет, добавлена фиксированная ширина для кнопок, настроена видимость полос прокрутки.
- **Как сделано**:
  * В `ui/styles/layout.css` добавлены вертикальные паддинги для `.card-header`: `padding-top: 0.75rem` и `padding-bottom: 0.75rem`.
  * Убраны выделяющие цвета из всех выпадающих списков: удален класс `text-danger` у кнопки "Удалить отмеченные", удален `text-success` у иконки проверки в списке поиска, добавлены глобальные стили для `.list-group-item-action` с одинаковым цветом текста во всех состояниях (используется `var(--bs-body-color)`).
  * Исправлен баг с подсветкой в выпадающем списке счетчика: добавлены специфичные CSS правила с `!important` для `.cg-counter-dropdown .list-group-item-action:hover`, `:focus`, `:active`, включая disabled элементы.
  * Применен единый стиль для всех выпадающих меню внутри `<main>`: радиус скругления `2.5px`, более контрастная рамка (`#adb5bd` для светлой темы, `#5a5d62` для темной), усиленная тень для обеих тем.
  * Исправлена подсветка уже добавленных монет: в `index.html` заменен класс `bg-light` на `cg-search-item-selected`, добавлен CSS класс `.cg-search-item-selected` с использованием `var(--bs-secondary-bg)` для теме-зависимой подсветки.
  * Изменена логика отображения счетчика монет: формат "n/N" показывается только когда выбрана часть монет (`0 < selectedCoinsCount < totalCoinsCount`), в остальных случаях показывается только общее число монет.
  * Увеличена ширина кнопки счетчика с `3.5em` до `5em` в `ui/styles/layout.css`.
  * Добавлена фиксированная ширина `7em` для кнопки обновления (класс `.cg-update-btn`) для предотвращения "прыжков" интерфейса при показе спиннера.
  * Настроена видимость полос прокрутки: вертикальная полоса всегда видна (`overflow-y: scroll` на `html`), горизонтальная полоса скрыта глобально (`overflow-x: hidden` на `html`/`body`, скрытие через CSS `::-webkit-scrollbar { height: 0 }` и `scrollbar-width`).
- **Функциональность**: Хедеры карточек имеют увеличенные вертикальные паддинги для лучшей читаемости. Все выпадающие списки имеют единый стиль оформления с одинаковым цветом текста во всех состояниях, подсветка работает корректно для всех элементов. Выпадающие меню внутри `<main>` имеют единый стиль с контрастной рамкой и тенью, радиус скругления 2.5px. Подсветка уже добавленных монет корректно работает в обеих темах. Счетчик монет показывает формат "n/N" только при частичном выборе, иначе только общее число. Кнопки имеют фиксированную ширину для предотвращения "прыжков" интерфейса. Вертикальная полоса прокрутки всегда видна, горизонтальная скрыта, но прокрутка работает через Shift + колесико мыши.

