<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Каталог сообщений проекта</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <!-- Единые стили для всех review -->
    <link rel="stylesheet" href="../review-styles.css">
    <!-- Стили layout (включая стили для alert-close-button-wrapper) -->
    <link rel="stylesheet" href="../styles/layout.css">
    <!-- Level 2: единое хранилище и единый компонент сообщений -->
    <script src="../utils/messages-store.js"></script>
    <script src="../components/system-messages.js"></script>
    <!-- Единый менеджер для всех review (хедер с вкладками) - загружаем в head для ранней инициализации -->
    <script src="../review-manager.js"></script>
</head>
<body>
    <!-- Хедер с вкладками будет вставлен здесь через review-manager.js -->
    
    <div id="app" class="container-fluid">
        <!-- Auto-scan: каталог сообщений из фактической кодовой базы -->
        <div class="mt-4 mb-3">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Auto-scan</h5>
                    <small v-if="autoMessagesMeta" class="text-muted">{{ autoMessagesMeta }}</small>
                </div>
                <div class="card-body">
                    <!-- Единый хост сообщений для Auto-scan (показывается только при наличии сообщений) -->
                    <system-messages scope="review-messages-auto-scan" :include-unscoped="false" :limit="2"></system-messages>

                    <div v-if="autoMessagesLoading" class="text-muted">Сканирую сообщения в проекте…</div>
                    <div v-else-if="autoMessagesError"></div>
                    <div v-else>
                        <div v-if="autoMessages.length === 0" class="text-muted">Сообщения не найдены (или недоступен источник данных).</div>
                        <div v-else class="table-responsive">
                            <table class="table table-sm review-table">
                                <thead>
                                    <tr>
                                        <th style="width: 110px;">Тип</th>
                                        <th>Текст (сниппет)</th>
                                        <th style="width: 240px;">Где найдено</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr v-for="(m, idx) in autoMessages" :key="idx">
                                        <td><span class="badge bg-secondary">{{ m.type }}</span></td>
                                        <td style="font-size: 0.9rem;">{{ m.text }}</td>
                                        <td class="usage-cell">
                                            <select v-if="m.files && m.files.length > 1" class="form-select form-select-sm" style="width: auto; display: inline-block; min-width: 200px; font-size: 0.85rem;">
                                                <option v-for="f in m.files" :key="f" :value="f">{{ f }}</option>
                                            </select>
                                            <code v-else-if="m.files && m.files.length === 1" style="font-size: 0.85rem;">{{ m.files[0] }}</code>
                                            <span v-else class="text-muted">—</span>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="messages-container mt-4">
            <div class="row g-4">
                <!-- Левая колонка: быстрые пресеты -->
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">Шаблоны (клик создаёт сообщение)</h5>
                            <button class="btn btn-sm btn-outline-secondary" @click="clearScope(scopes.left)">Очистить</button>
                        </div>
                        <div class="card-body">
                            <div class="d-flex flex-column gap-2">
                                <button class="btn btn-sm btn-outline-danger text-start" @click="presetLeft('cgError')">
                                    cgError — Не удалось загрузить данные (danger)
                                </button>
                                <button class="btn btn-sm btn-outline-warning text-start" @click="presetLeft('quoteError')">
                                    quoteError — Не удалось загрузить цитату (warning)
                                </button>
                                <button class="btn btn-sm btn-outline-danger text-start" @click="presetLeft('passwordError')">
                                    passwordError — Неверный код (danger)
                                </button>
                                <button class="btn btn-sm btn-outline-success text-start" @click="presetLeft('importSuccess')">
                                    importStatus — Экспорт успешен (success)
                                </button>
                                <button class="btn btn-sm btn-outline-danger text-start" @click="presetLeft('importError')">
                                    importStatus — Ошибка экспорта (danger)
                                </button>
                                <button class="btn btn-sm btn-outline-warning text-start" @click="presetLeft('apiKeyMissing')">
                                    perplexityApiKey — Нужен API ключ (warning)
                                </button>
                                <button class="btn btn-sm btn-outline-success text-start" @click="presetLeft('apiKeyOk')">
                                    perplexityApiKey — API ключ настроен (success)
                                </button>
                                <button class="btn btn-sm btn-outline-warning text-start" @click="presetLeft('failedTickers')">
                                    failedTickers — Некоторые монеты не удалось добавить (warning)
                                </button>
                            </div>

                            <div class="mt-3">
                                <system-messages :scope="scopes.left" :include-unscoped="false" :limit="6"></system-messages>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Правая колонка: темы -->
                <div class="col-md-6">
                    <!-- Light Theme -->
                    <div class="card mb-4">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">Light Theme</h5>
                            <div class="btn-group">
                                <button class="btn btn-sm btn-outline-secondary" @click="clearScope(scopes.light)">Очистить</button>
                                <button class="btn btn-sm btn-outline-info" @click="presetTheme(scopes.light, 'info')">Info</button>
                                <button class="btn btn-sm btn-outline-success" @click="presetTheme(scopes.light, 'success')">Success</button>
                                <button class="btn btn-sm btn-outline-warning" @click="presetTheme(scopes.light, 'warning')">Warning</button>
                                <button class="btn btn-sm btn-outline-danger" @click="presetTheme(scopes.light, 'danger')">Danger</button>
                            </div>
                        </div>
                        <div class="card-body">
                            <system-messages :scope="scopes.light" :include-unscoped="false" :limit="4"></system-messages>
                        </div>
                    </div>

                    <!-- Dark Theme -->
                    <div class="card mb-4" data-bs-theme="dark">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">Dark Theme</h5>
                            <div class="btn-group">
                                <button class="btn btn-sm btn-outline-secondary" @click="clearScope(scopes.dark)">Очистить</button>
                                <button class="btn btn-sm btn-outline-info" @click="presetTheme(scopes.dark, 'info')">Info</button>
                                <button class="btn btn-sm btn-outline-success" @click="presetTheme(scopes.dark, 'success')">Success</button>
                                <button class="btn btn-sm btn-outline-warning" @click="presetTheme(scopes.dark, 'warning')">Warning</button>
                                <button class="btn btn-sm btn-outline-danger" @click="presetTheme(scopes.dark, 'danger')">Danger</button>
                            </div>
                        </div>
                        <div class="card-body">
                            <system-messages :scope="scopes.dark" :include-unscoped="false" :limit="4"></system-messages>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Bootstrap JS для работы alert-dismissible -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Vue.js 3 -->
    <script src="https://unpkg.com/vue@3.5.25/dist/vue.global.prod.js"></script>
    
    <!-- Глобальные утилиты -->
    <script src="../../ui/utils/ui-element-helper.js"></script>
    <script src="../../ui/utils/hash-generator.js"></script>
    
    <!-- X-Template для компонента button (ДОЛЖЕН БЫТЬ ДО компонентов) -->
    <script type="text/x-template" id="button-template">
        <button
            :type="type"
            :class="buttonClasses"
            :disabled="disabled"
            @click="handleClick"
        >
            <!-- Основная часть (иконка + текст) с tooltip -->
            <span 
                class="button-main"
                :class="{'button-icon-only': isIconOnly}"
                :title="mainTooltip"
            >
                <!-- Спиннер загрузки (показывается только если нет loadingText) -->
                <span v-if="loading && !loadingText" class="spinner-border spinner-border-sm" role="status"></span>
                
                <!-- Динамический текст загрузки (показывается вместо спиннера) -->
                <span v-if="loading && loadingText" class="button-label">{{ loadingText }}</span>
                
                <!-- Иконка (скрывается при loading) -->
                <span v-if="!loading && (effectiveIconClass || hasIconImage)" class="button-icon">
                    <!-- SVG-иконка из файла (используется object для поддержки currentColor и CSS переменных) -->
                    <object v-if="isSVGIcon" 
                            :data="svgIconPath" 
                            type="image/svg+xml"
                            :class="effectiveIconClass"
                            style="width: 1em; height: 1em; vertical-align: middle; pointer-events: none;">
                        <!-- Fallback на img если object не поддерживается -->
                        <img :src="svgIconPath" 
                             :alt="displayLabel"
                             :class="effectiveIconClass"
                             style="width: 1em; height: 1em; vertical-align: middle;">
                    </object>
                    <!-- Font Awesome иконки (используется i) -->
                    <i v-else-if="effectiveIconClass" :class="effectiveIconClass"></i>
                    <img v-if="hasIconImage" :src="iconImage" :alt="displayLabel" width="16" height="16">
                </span>
                
                <!-- Текст (всегда рендерится, но скрывается визуально при loading для сохранения высоты, если нет loadingText) -->
                <span 
                    v-if="displayLabel && !(loading && loadingText)" 
                    class="button-label"
                    :style="{ visibility: (loading && !loadingText) ? 'hidden' : 'visible' }"
                >{{ displayLabel }}</span>
            </span>
            
            <!-- Индикатор с отдельным tooltip -->
            <span 
                v-if="indicator"
                class="button-indicator"
                :title="indicatorTooltipText"
            >
                <i v-if="effectiveIndicatorIcon" :class="effectiveIndicatorIcon"></i>
            </span>
        </button>
    </script>
    
    <!-- Компоненты (для demo-кнопок и единых сообщений) -->
    <script src="../../ui/components/button.js"></script>
    
    <script>
        // Инициализация Vue приложения (Auto-scan + demo сообщений)
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof Vue === 'undefined' || !window.AppMessages || !window.cmpSystemMessages) return;

            const { createApp } = Vue;

            const app = createApp({
                data() {
                    return {
                        scopes: {
                            left: 'review-messages-left',
                            light: 'review-messages-light',
                            dark: 'review-messages-dark'
                        },
                        autoMessagesLoading: true,
                        autoMessagesError: null,
                        autoMessagesMeta: null,
                        autoMessages: []
                    };
                },
                async mounted() {
                    const pipeline = window.ReviewManager?.ReviewDataPipeline;
                    if (!pipeline?.scanMessages) {
                        this.autoMessagesLoading = false;
                        this.autoMessagesError = 'ReviewDataPipeline недоступен.';
                        window.AppMessages?.replace?.('rm_auto_scan_error', {
                            scope: 'review-messages-auto-scan',
                            type: 'danger',
                            text: 'Auto-scan: ReviewDataPipeline недоступен.',
                            details: this.autoMessagesError
                        });
                        return;
                    }

                    try {
                        const res = await pipeline.scanMessages();
                        this.autoMessages = Array.isArray(res?.messages) ? res.messages : [];
                        this.autoMessagesMeta = res?.generatedAt ? `generatedAt: ${res.generatedAt}` : null;
                        this.autoMessagesLoading = false;
                        window.AppMessages?.dismiss?.('rm_auto_scan_error');
                    } catch (e) {
                        this.autoMessagesLoading = false;
                        this.autoMessagesError = String(e?.message || e);
                        window.AppMessages?.replace?.('rm_auto_scan_error', {
                            scope: 'review-messages-auto-scan',
                            type: 'danger',
                            text: 'Auto-scan сообщений: ошибка.',
                            details: this.autoMessagesError
                        });
                        window.ReviewManager?.ReviewSystemMessages?.post?.('messages.scan.error', {
                            id: 'messages-scan',
                            details: this.autoMessagesError
                        });
                    }
                },
                methods: {
                    clearScope(scope) {
                        window.AppMessages?.clear?.(scope);
                    },
                    pushDemo({ id, scope, type, text, details }) {
                        if (!window.AppMessages) return;
                        window.AppMessages.replace?.(id, { scope, type, text, details });
                    },
                    presetLeft(key) {
                        const scope = this.scopes.left;
                        const map = {
                            cgError: { id: 'rm_left_cg', type: 'danger', text: 'Не удалось загрузить данные', details: 'CoinGecko: пример системной ошибки.' },
                            quoteError: { id: 'rm_left_quote', type: 'warning', text: 'Не удалось загрузить цитату', details: 'Perplexity: пример предупреждения.' },
                            passwordError: { id: 'rm_left_pin', type: 'danger', text: 'Неверный код', details: 'Splash: неверный PIN.' },
                            importSuccess: { id: 'rm_left_import_ok', type: 'success', text: 'Экспорт успешен', details: 'Чувствительные данные обфусцированы.' },
                            importError: { id: 'rm_left_import_err', type: 'danger', text: 'Ошибка экспорта настроек', details: 'Пример текста ошибки…' },
                            apiKeyMissing: { id: 'rm_left_key_missing', type: 'warning', text: 'Для работы необходимо указать API ключ', details: 'Perplexity API key отсутствует.' },
                            apiKeyOk: { id: 'rm_left_key_ok', type: 'success', text: 'API ключ настроен', details: 'Perplexity API key сохранён.' },
                            failedTickers: { id: 'rm_left_failed_tickers', type: 'warning', text: 'Некоторые монеты не удалось добавить', details: 'Повторите попытку позже.' }
                        };
                        const v = map[key];
                        if (!v) return;
                        this.pushDemo({ ...v, scope });
                    },
                    presetTheme(scope, type) {
                        const base = {
                            info: {
                                id: `${scope}_info`,
                                type: 'info',
                                text: 'Информация о прогнозе',
                                details: 'Модель завершила расчёт метрик; проверьте распределение портфеля.'
                            },
                            success: {
                                id: `${scope}_success`,
                                type: 'success',
                                text: 'Портфель сохранён',
                                details: 'Изменения сохранены в локальное хранилище.'
                            },
                            warning: {
                                id: `${scope}_warning`,
                                type: 'warning',
                                text: 'Внимание: недостаточно данных',
                                details: 'Данных < 30 дней по некоторым активам — точность может снизиться.'
                            },
                            danger: {
                                id: `${scope}_danger`,
                                type: 'danger',
                                text: 'Ошибка загрузки данных',
                                details: 'CoinGecko API: лимит запросов / сеть. Используйте кэш.'
                            }
                        }[type];
                        if (!base) return;
                        this.pushDemo({ ...base, scope });
                    }
                }
            });

            app.component('cmp-button', window.cmpButton);
            app.component('system-messages', window.cmpSystemMessages);
            app.mount('#app');
        });
    </script>
</body>
</html>
