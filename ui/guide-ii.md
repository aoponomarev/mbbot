# Руководство по интерфейсу и взаимодействию (BOT)

> **Цель документа**: Поддержка сквозной консистентности UI во всех аспектах приложения.

> **ВАЖНО**: Этот документ предназначен для ИИ-агентов и разработчиков. Принципы и правила, описанные здесь, должны соблюдаться при разработке всех компонентов интерфейса.

## Структура документа

Документ разделен на две крупные секции:
- **Interface** — оформление, визуальные стили, компоненты
- **Interaction** — паттерны UX, базовые паттерны взаимодействия приложения

---

## Interface (оформление)

*Принципы и правила визуального оформления интерфейса: стили, компоненты, цветовая схема, типографика, анимации*

### Общие принципы стилизации

- **Приоритет Bootstrap**: Использовать Bootstrap классы и утилиты в приоритете. Минимизировать кастомные CSS стили, inline стили и секции `<style>` в HTML файлах.
- **Вынесение стилей в отдельные файлы**: Все кастомные CSS стили выносятся в отдельные файлы в структуре `ui/styles/`. Стили группируются по компонентам: `ui/styles/header.css`, `ui/styles/footer.css`, `ui/styles/splash.css`, `ui/styles/dropdown.css`, `ui/styles/layout.css`, `ui/styles/chat.css` и т.д.
- **Динамические стили**: Динамические стили в JavaScript (вычисляемые значения, анимации) могут оставаться в JS, но базовые стили должны быть в CSS файлах.
- **Радиусы скругления**: Использовать дефолтные значения Bootstrap (`var(--bs-border-radius)`). Избегать кастомных `border-radius`, если не требуется специфичное оформление.

### Цветовая схема и темы

- **Темы**: Поддержка светлой (`light`) и темной (`dark`) темы через Bootstrap `data-bs-theme`.
- **Хедер**: Всегда в темной теме (темный графит `#2b2b2b`), не реагирует на переключалку темы. Обеспечивает контраст с основным контентом.
- **Футер**: Фон соответствует теме через `bg-body`, тень сверху для визуального отделения.
- **Цветовые состояния метрик**: 
  - BTC Dominance: цветная иконка если >50%, серая если нет
  - FGI (Fear & Greed Index): красный 0-25, оранжевый 26-45, серый 46-55, зеленый 56-75, яркий зеленый 76-100
  - VIX: зеленый <20, серый 20-30, красный >30
  - Funding Rate: зеленый отрицательный, серый нейтральный, красный положительный
  - Long/Short Ratio: красный <1.0, серый =1.0, зеленый >1.0
  - Open Interest: всегда серый

### Компоненты

#### Хедер
- **Позиционирование**: `position-fixed top-0`, высота 50px, z-index 1050
- **Фон**: Темный графит `#2b2b2b`, тень сверху
- **Паддинги**: Боковые паддинги отсутствуют (0px) для десктоп и мобильной версии. Контейнер хедера без боковых отступов.
- **Структура**: 3 секции
  - Левая: гамбургер (50px, SVG иконка для пиксельной четкости)
  - Средняя: селект математической модели (десктоп) / dropdown (мобильная) + вкладки отображения (Bootstrap радиокнопки). Занимает всю доступную ширину (`flex-grow-1`), без боковых паддингов.
  - Правая: кнопки рефреша и смены темы (2x50px)
- **Селекты**: Полупрозрачный фон `rgba(255, 255, 255, 0.1)`, белый текст, полупрозрачная стрелка через data URI SVG
- **Вкладки**: Bootstrap `btn-group` с `btn-check`, активная вкладка — белый текст, неактивные — полупрозрачный белый `rgba(255, 255, 255, 0.5)`
- **Кнопки управления**: Без ободков, только иконки, легкая подсветка при наведении `rgba(255, 255, 255, 0.1)`
- **Dropdown меню**: Инверсны включенной теме приложения (если тема `light` — dropdown `dark`, и наоборот). Идентичное оформление для десктоп и мобильной версии. Используют дефолтные радиусы скругления Bootstrap. **Примечание**: Выпадающие меню внутри `<main>` (не в хедере) используют единый стиль с радиусом `2.5px`, контрастной рамкой и тенью (см. раздел "Карточки" → "Выпадающие меню внутри `<main>`").
- **Всплывающие подсказки (tooltips)**: Инверсны включенной теме приложения. Инициализируются через Bootstrap Tooltip API с `data-bs-theme`, обновляются при изменении темы.
- **Адаптивность**: На десктопе селект модели, на мобильных — dropdown. Вкладки: десктоп — радиокнопки, мобильные — dropdown

#### Футер
- **Позиционирование**: `position-fixed bottom-0`, z-index 1000, тень сверху
- **Адаптивность**: 
  - Десктоп: все индикаторы равномерно распределены (`justify-content-between`)
  - Мобильные: только метрики рынка с горизонтальной прокруткой (`overflow-x-auto`, `-webkit-overflow-scrolling: touch`), версии фреймворков скрыты
- **Высота**: На мобильных `p-5` (≈48px), на десктопе `p-2` (≈8px)
- **Метрики**: Моноширинный шрифт `font-monospace` с размером `1.05em` для предотвращения "дергания" строки при анимации

#### Сплэш-экран
- **Позиционирование**: `position-fixed`, полный экран, z-index 9999, темный фон `rgba(0, 0, 0, 0.95)`
- **Контейнер**: Максимальная ширина 400px, ширина 90%
- **Поле ввода API-ключа**: 
  - По умолчанию: прозрачный фон, прозрачная рамка, полупрозрачный текст (`opacity: 0.5`)
  - При фокусе: фон `var(--bs-dark)`, рамка `var(--bs-secondary)`, полная непрозрачность
- **Индикатор загрузки**: Анимированные точки (1,2,3,4,5) вместо спиннера

#### Карточки
- **Хедер карточки (`.card-header`)**: 
  - Вертикальные паддинги: `padding-top: 0.75rem`, `padding-bottom: 0.75rem` для улучшенной читаемости
  - Фон: Более темный и "стальной" оттенок (`#e8eaed` для светлой темы, `#2e3035` для темной темы) для визуального отделения от основного контента
  - Кнопки: Единый стиль для всех кнопок в хедерах карточек (класс `.card-header .btn`)
    - Фон: `var(--bs-secondary-bg)` (адаптируется под тему)
    - Рамки: Высококонтрастные для светлой темы (`#adb5bd` нормальное состояние, `#98a2ac` при hover/focus), стандартные для темной темы
    - Прозрачность: Полностью непрозрачные (`opacity: 1`)
    - Hover/Focus: В светлой теме фон темнеет (`#d5d8dc`), в темной теме светлеет (`#4a4d52`)
    - Фиксированная ширина: Кнопка обновления (`.cg-update-btn`) имеет фиксированную ширину `7em` для предотвращения "прыжков" интерфейса при показе спиннера
- **Выпадающие меню внутри `<main>`**: Единый стиль для всех выпадающих меню (счетчик монет, поиск, архив, контекстное меню)
  - Радиус скругления: `2.5px` (единый для всех меню)
  - Рамка: Высококонтрастная (`#adb5bd` для светлой темы, `#5a5d62` для темной темы)
  - Тень: Усиленная для обеих тем для визуального отделения
  - Цвет текста: Одинаковый во всех состояниях (hover, focus, active) через `var(--bs-body-color)` для единообразия
  - Подсветка: Только фон меняется при hover/focus/active, цвет текста остается неизменным

#### Счетчик монет
- **Кнопка счетчика (`.cg-coins-counter`)**: 
  - Фиксированная ширина: `5em` для двузначных чисел и слеша (например: "99/99")
  - Выравнивание текста: По центру
  - Формат отображения: 
    - При частичном выборе (`0 < selectedCount < totalCount`): Формат "n/N" (n - выбрано, N - всего)
    - При отсутствии выбора или выборе всех: Только общее число монет (N)
  - Выделение числа выбранных монет: Класс `.cg-counter-selected` с полужирным шрифтом (`font-weight: 600`) и цветом `var(--bs-body-color)` для контраста в обеих темах
- **Выпадающее меню счетчика (`.cg-counter-dropdown`)**: 
  - Опции: "Выбрать все", "Отменить все", "Удалить отмеченные", "Архивировать отмеченные"
  - Подсветка: Работает корректно для всех элементов, включая disabled, через специфичные CSS правила с `!important`

#### Отключенные поля ввода
- **Disabled поля в темной теме**: Глобальные стили для всех типов disabled полей ввода
  - `.form-control:disabled`, `.form-control[readonly]`: Темный фон `var(--bs-secondary-bg)`, приглушенный текст `var(--bs-secondary-color)`, прозрачность `0.65`
  - `.form-select:disabled`: Те же стили для select элементов
  - `.form-check-input:disabled`: Темный фон для чекбоксов
  - `textarea.form-control:disabled`: Стили для текстовых областей
  - Bootstrap по умолчанию применяет белый фон для disabled элементов, что плохо видно в темной теме, поэтому используются кастомные стили с `!important` для переопределения

#### Цветовые состояния предупреждений
- **Неудачные тикеры при добавлении монет**: Кастомные цвета для лучшей читабельности на светлом фоне
  - Бейджи: Класс `.bg-warning-dark` с темно-оранжевым фоном (`#cc7700` для светлой темы, `#ffb84d` для темной темы)
  - Текст предупреждений: Класс `.text-warning-dark` с темно-оранжевым цветом (`#cc7700` для светлой темы, `#ffb84d` для темной темы)
  - Стандартный желтый цвет Bootstrap (`bg-warning`, `text-warning`) заменен на более контрастный темно-оранжевый для улучшенной читабельности

#### Панелька загрузки монет
- **Позиционирование панельки загрузки (`.cg-loading-panel`)**: 
  - Верхний край панельки выровнен с верхней границей card-header (на уровне кнопок управления)
  - Реализовано через отрицательный `margin-top` с использованием единиц `ex` для точного вертикального позиционирования
  - Формула: `calc(-2.2rem + 0.45ex)` учитывает высоту поля ввода (`form-control-sm`) и корректировку для точного выравнивания

### Типографика

- **Моноширинный шрифт**: Используется для метрик и числовых значений (`font-monospace`) для предотвращения "дергания" строки при анимации
- **Размеры**: Базовый размер шрифта Bootstrap, метрики с увеличенным размером `1.05em` для визуального совпадения

### Анимации и переходы

- **Индикатор загрузки метрик**: Вращающиеся символы `| / - \` (каждые 150мс) вместо тире во время загрузки
- **Индикатор загрузки цитаты**: Анимированные точки (1,2,3,4,5) на сплэш-экране
- **Переходы**: Плавные переходы для hover состояний (`transition: background-color 0.2s`)

### Иконки

- **Font Awesome 6.5.1**: Основная библиотека иконок
- **SVG иконки**: Используются для пиксельной четкости (гамбургер в хедере)
- **Цветовые состояния**: Иконки метрик меняют цвет в зависимости от значения

### Адаптивность

- **Breakpoints Bootstrap**: Использование стандартных breakpoints Bootstrap (`d-none d-md-block`, `d-block d-md-none`)
- **Мобильная версия**: Упрощенный интерфейс на мобильных (dropdown вместо селектов, скрытие второстепенной информации)
- **Touch-friendly**: Увеличенные области нажатия на мобильных (футер `p-5` вместо `p-2`)

### Полосы прокрутки

- **Вертикальная полоса прокрутки**: Всегда видна глобально (`overflow-y: scroll` на `html`) для предотвращения "дергания" интерфейса при появлении/исчезновении полосы
- **Горизонтальная полоса прокрутки**: Скрыта визуально глобально (`overflow-x: hidden` на `html`/`body`, скрытие через CSS `::-webkit-scrollbar { height: 0 }` и `scrollbar-width: none`), но горизонтальная прокрутка доступна через Shift + колесико мыши (или пальцем на мобильных)

---

## Interaction (паттерны UX)

*Базовые паттерны взаимодействия приложения: навигация, формы, обратная связь, состояния загрузки*

### Навигация

- **Хедер**: Фиксированный сверху, всегда видимый, обеспечивает быстрый доступ к основным функциям
- **Гамбургер-меню**: Левая секция хедера (50px), готов к реализации бокового меню
- **Вкладки отображения**: Переключение между режимами отображения данных (%, Компл. дельты, Градиенты, MAX, min, Баланс Δ)

### Формы и ввод данных

- **PIN-код**: 4-значный PIN для разблокировки приложения, автоматическая валидация при вводе
- **API-ключ**: Поле ввода на сплэш-экране, скрыто до фокуса (полупрозрачное), автоматическое сохранение при вводе
- **Селекты**: Десктоп — нативный `<select>`, мобильные — Bootstrap dropdown для лучшего UX

### Обратная связь

- **Индикаторы загрузки**: 
  - Метрики рынка: вращающиеся символы `| / - \`
  - Цитата на сплэш-экране: анимированные точки
- **Цветовые состояния**: Визуальная обратная связь через цвет иконок метрик (красный/зеленый/серый)
- **Сообщения об ошибках**: Alert компоненты Bootstrap для отображения ошибок

### Состояния компонентов

- **Загрузка**: Флаги `isLoading` для отслеживания состояния загрузки, визуальные индикаторы
- **Активность**: Выделение активных элементов (вкладки, выбранные опции)
- **Отключенные элементы**: `disabled` состояние для кнопок и полей ввода во время загрузки

### Доступность

- **Подсказки**: `title` атрибуты для кнопок и элементов управления. Bootstrap tooltips с инверсной темой для визуального контраста с хедером.
- **Клавиатурная навигация**: Поддержка стандартной навигации через Tab
- **Семантическая разметка**: Использование правильных HTML элементов (`<header>`, `<footer>`, `<button>`)

### Персистентность

- **Тема**: Сохранение выбранной темы в `localStorage`
- **API-ключ**: Сохранение API-ключа в `localStorage` (обфусцированно)
- **PIN-код**: Сохранение PIN-кода в `localStorage` (обфусцированно)
- **Активная вкладка**: Сохранение активной вкладки отображения в `localStorage`
- **Список монет**: Сохранение выбранных монет, архива монет, данных CoinGecko в `localStorage`

### Кэширование данных

- **Иконки монет**: Кэшируются в localStorage (`cgIconsCache`) с временным ограничением (не чаще 1 раза в час). Обеспечивают мгновенную загрузку при повторном отображении. Время последнего обновления хранится в `cgIconsCacheTimestamp`.
- **Метрики рынка**: Кэшируются в localStorage (`marketMetricsCache`) с временным ограничением (не чаще 1 раза в час). Неопределенные метрики (`"—"`) продолжают загружаться из API с показом анимации. Время последнего обновления хранится в `marketMetricsCacheTimestamp`.
- **Фильтрация анимации**: Символы анимации (`|`, `/`, `-`, `\`) не попадают в кэш, заменяются на `"—"` перед сохранением через метод `filterSpinnerChars()`.
- **Валидация кэша**: Кэшируются только успешно загруженные данные с реальными значениями. Пустые значения не кэшируются.

### Многоязычность

- **Определение языка**: Автоматическое определение языка системы через `navigator.language`
- **Генерация контента**: Философские предложения генерируются на языке системы пользователя

### Паттерны взаимодействия

- **Переключение темы**: Кнопка в хедере, мгновенное применение через `data-bs-theme`
- **Обновление страницы**: Кнопка рефреша в хедере
- **Разблокировка приложения**: PIN-код на сплэш-экране, автоматическая проверка при вводе
- **Настройка API**: Поле ввода на сплэш-экране, сохранение при нажатии кнопки сохранения
- **Глобальное закрытие выпадающих списков**: Клик за пределами любого выпадающего списка закрывает все открытые выпадающие элементы одновременно. Реализовано через глобальный обработчик в корневом компоненте (`closeAllDropdowns()`), который использует событие `close-all-dropdowns` для уведомления всех компонентов. Обеспечивает консистентное поведение и чистый интерфейс (одновременно открыт только один элемент).
- **Управление списком монет**:
  - **Поиск монет**: Поле поиска с автодополнением, поддержка множественного поиска через разделители (запятые, слеши, спецсимволы). Результаты сортируются: полные совпадения по тикеру → тикеры, начинающиеся с запроса → остальные по популярности. Выпадающий список поиска автоматически закрывается при клике вне области поиска.
  - **Архив монет**: Структура хранения - массив объектов `{id, symbol, name}`. При архивировании сохраняются ID, тикер (uppercase) и полное название монеты. В выпадающем списке архива показывается только тикер, полное название отображается в tooltip при наведении. Ширина выпадающего списка - по контенту (`width: auto; min-width: fit-content;`). Выпадающий список архива автоматически закрывается при клике вне области архива. Автоматически заархивированные монеты (неудачные попытки добавления после 5 попыток) имеют ID с префиксом `failed-{ticker}` и отображаются с иконкой рефреша (`fa-sync-alt`) вместо фирменной иконки монеты для визуального отличия от вручную заархивированных монет. Синхронизация таблицы и архива: монета не может одновременно присутствовать в таблице и архиве. При добавлении монеты в таблицу она автоматически удаляется из архива. При архивировании монета автоматически удаляется из таблицы. При загрузке приложения дубликаты автоматически очищаются (приоритет таблице).
  - **Контекстное меню**: Доступно по клику на блок иконка+тикер. Операции: перемещение (в начало, вверх, вниз, в конец), архивирование, удаление. Контекстное меню автоматически закрывается при клике вне области меню или блока монеты.
  - **Счетчик монет**: Интерактивная кнопка с выпадающим меню для массовых операций. Отображает количество выбранных монет или общее число. Формат "n/N" показывается только при частичном выборе, в остальных случаях показывается только общее число монет. Выпадающее меню предоставляет опции: "Выбрать все", "Отменить все", "Удалить отмеченные", "Архивировать отмеченные". Кнопка имеет фиксированную ширину `5em` для предотвращения "прыжков" интерфейса. Подсветка уже добавленных монет в списке поиска использует тему-зависимый класс `.cg-search-item-selected` с `var(--bs-secondary-bg)` для корректной работы в обеих темах.
  - **Сортировка таблицы**: Циклическая сортировка по клику на заголовок колонки (3 состояния: null → asc → desc → null). Глобальный mixin `table-sort-mixin.js` для переиспользования.
  - **Линейное добавление монет списком тикеров**: Режим автоматически активируется при вставке списка тикеров в поле поиска. Тикеры разделяются любыми не-алфавитными символами, автоматически фильтруются (удаляются уже присутствующие в таблице или архиве, удаляются отсутствующие на CoinGecko). Добавление происходит последовательно, по одной монете, с визуальной обратной связью: поле поиска блокируется, показывается текущий добавляемый тикер, список оставшихся тикеров уменьшается по мере добавления. Неудачно загруженные монеты пропускаются и повторяются в следующем цикле. После 5 неудачных попыток монета автоматически отправляется в архив с префиксом `failed-`. Процесс можно остановить вручную через кнопку "Остановить". Используется адаптивный таймаут для обработки rate limiting CoinGecko API (экспоненциальный backoff: базовое значение 300ms, удваивается при 429 ошибке до максимума 10 секунд, постепенно уменьшается при успешных запросах).
  - **Восстановление монет из архива**: При восстановлении автоматически заархивированной монеты (`failed-{ticker}`) система автоматически находит реальный CoinGecko ID по тикеру. Если монета не найдена или попытка добавления не удалась - монета возвращается обратно в архив с оригинальным ID.

---

## Обновление принципов

Принципы и правила в этом документе обновляются по командам пользователя:
- **Команды `UI:`** — обновляют раздел "Interface (оформление)"
- **Команды `UX:`** — обновляют раздел "Interaction (паттерны UX)"

ИИ-агент должен немедленно обновлять соответствующий раздел при получении команды.

## Связанные документы

Этот документ является частью системы документации проекта:
- **`.cursorrules`** — правила работы ИИ-агента с проектом
- **`architect.md`** — архитектурный план проекта, принципы математической модели, технические ограничения
- **`ui/guide-ii.md`** (этот файл) — руководство по интерфейсу и взаимодействию

**ВАЖНО**: При изменении принципов UI/UX в этом документе необходимо проверить согласованность с другими документами проекта. См. раздел "Отслеживание согласованности архитектурных правил" в `architect.md` и `.cursorrules`.

---

*Документ обновляется по мере развития проекта и изменения требований*

